/**
 * Vehicle PreCreate Hooks - Auto-fill category on vehicle creation
 *
 * Loads canonical vehicle category mapping and automatically assigns
 * the correct category when a vehicle is created in the compendium
 * or actor inventory.
 *
 * Mapping loaded from VEHICLE_AUDIT_MAPPING.json (generated by audit process)
 */

import { SWSELogger } from '../../utils/logger.js';

const SYSTEM_ID = 'foundryvtt-swse';
const MAPPING_PATH = 'modules/foundryvtt-swse/VEHICLE_AUDIT_MAPPING.json';

// Canonical vehicle categories (from audit prompt)
const CANONICAL_CATEGORIES = {
  planetary: ['mount', 'speeder', 'tracked', 'walker', 'wheeled', 'emplacement', 'airspeeder'],
  starships: ['starfighter', 'transport', 'capitalShip', 'spaceStation']
};

// Lazy-loaded mapping cache
let VEHICLE_CATEGORY_MAPPING = null;

/**
 * Load vehicle category mapping from JSON file
 * @returns {Promise<Object>} Vehicle name → category mapping
 */
async function loadVehicleMapping() {
  if (VEHICLE_CATEGORY_MAPPING) {
    return VEHICLE_CATEGORY_MAPPING;
  }

  try {
    const response = await fetch(MAPPING_PATH);
    if (!response.ok) {
      SWSELogger.warn(`[${SYSTEM_ID}] Could not load vehicle mapping (${response.status}). PreCreate auto-fill disabled.`);
      return {};
    }

    VEHICLE_CATEGORY_MAPPING = await response.json();
    SWSELogger.log(`[${SYSTEM_ID}] Loaded vehicle category mapping (${Object.keys(VEHICLE_CATEGORY_MAPPING).length} entries)`);
    return VEHICLE_CATEGORY_MAPPING;
  } catch (err) {
    SWSELogger.error(`[${SYSTEM_ID}] Error loading vehicle mapping:`, err.message);
    return {};
  }
}

/**
 * Register preCreate hook for vehicles
 * Automatically assigns category based on vehicle name
 */
export function registerVehiclePreCreateHooks() {
  Hooks.on('preCreateItem', async (document, data, options, userId) => {
    // Only process vehicles
    if (document.type !== 'vehicle') {
      return;
    }

    // Load mapping if not already loaded
    const mapping = await loadVehicleMapping();
    if (!mapping || Object.keys(mapping).length === 0) {
      return;
    }

    // Get vehicle name from document or data
    const vehicleName = data.name || document.name;

    if (!vehicleName) {
      return;
    }

    // Look up category in mapping
    const category = mapping[vehicleName];

    if (category && category !== 'REVIEW_REQUIRED') {
      // Only update if it's a valid canonical category
      const isCanonical = Object.values(CANONICAL_CATEGORIES)
        .flat()
        .includes(category);

      if (isCanonical) {
        // Update the document data with canonical category
        if (!document.system) {
          document.system = {};
        }
        document.system.category = category;

        // Also derive domain from category
        const domain = CANONICAL_CATEGORIES.starships.includes(category) ? 'starship' : 'planetary';
        document.system.domain = domain;

        SWSELogger.debug(`[${SYSTEM_ID}] Auto-filled vehicle "${vehicleName}" → category: ${category}, domain: ${domain}`);
      }
    } else if (category === 'REVIEW_REQUIRED') {
      // Flag vehicles that need manual review
      SWSELogger.info(`[${SYSTEM_ID}] Vehicle "${vehicleName}" marked for manual category review`);
    }
  });
}

/**
 * Get vehicle category mapping (for dynamic dropdowns, etc)
 * @returns {Promise<Object>} Vehicle mapping
 */
export async function getVehicleCategoryMapping() {
  return loadVehicleMapping();
}

/**
 * Get list of canonical vehicle categories
 * @returns {Object} Categories by domain
 */
export function getCanonicalCategories() {
  return CANONICAL_CATEGORIES;
}
