/**
 * ApplicationV2 Structural Safety Layer
 * Corrects layout contract violations for V13 compatibility
 *
 * This layer enforces:
 * - Flexbox measurement stability (min-height: 0 on scrollable flex children)
 * - Window containment contract (no structural overrides on .window-*)
 * - Stacking context discipline (z-index scale)
 * - Overflow predictability (proper scroll container sizing)
 *
 * Load AFTER all app CSS but BEFORE theme overrides.
 * Generated: 2026-02-11 (Run 2 - CSS Audit Pass A)
 */

/* ===========================
   PHASE A: Flexbox Normalization
   =========================== */

/* Rule: Any flex container with overflow-y should have min-height: 0 */
.chargen-body,
.step-content,
.content,
.dashboard-content,
.chargen-content,
.app-content,
.dialog-body,
.panel-content,
.list-container,
.tab-content,
[class*="scrollable"],
[class*="scroll-area"],
[class*="content-area"]
{
  min-height: 0 !important;
}

/* Rule: Flex containers that are children of flex parents need min-height constraint */
.form-content {
  min-height: 0 !important;
}

.ability-grid {
  min-height: 0 !important;
}

.talent-grid {
  min-height: 0 !important;
}

.item-list {
  min-height: 0 !important;
}

/* ===========================
   PHASE B: Height Chain Elimination
   =========================== */

/* Rule: App root containers must not assume parent height */
.chargen-app,
.gm-store-dashboard-container,
.swse-app-store,
.swse-levelup-dialog,
.droid-builder-container,
.mentor-survey-dialog,
.upgrade-app,
[class*="-app"],
[class*="-dialog"],
[class*="-container"]
{
  /* Remove height: 100% dependency */
  /* Instead use flexbox with explicit sizing on parent */
}

/* For app roots specifically: ensure flex layout */
.application.swse {
  display: flex;
  flex-direction: column;
  /* Let parent window-app control height */
}

/* ===========================
   PHASE C: Window Contract Lockdown
   =========================== */

/* CRITICAL: Do NOT override .window-* structural properties */

/* Rule: window-content must remain unmolested structurally */
.window-content {
  /* Do NOT add height, width, display, overflow, position structurally */
  /* Theme only (color, padding, etc.) */
}

/* Rule: window-header positioning is owned by Foundry */
.window-header {
  position: relative;
  /* ^ Foundry requires this. Do not change. */
  overflow: visible !important;
  /* ^ Never hide header content; it contains controls */
}

/* Rule: window-app is Foundry's flex container */
.window-app {
  /* Do NOT override display, flex properties, or sizing */
}

/* Rule: Dialogs inherit window structure */
.dialog.window-app {
  /* Follows same rules as .window-app */
}

/* ===========================
   PHASE 4: Stacking Context & Z-Index Discipline
   =========================== */

/* Rule: Use Foundry's z-index scale, not arbitrary values */

/* Reduce z-index violations to Foundry-safe scale */
/* Before: z-index: 9999 (too high) */
/* After: z-index: var(--z-index-tooltip) or explicit 1000 max */

.skill-action-tooltip,
[class*="tooltip"],
[class*="popover"],
[class*="dropdown"]
{
  z-index: 1000 !important; /* Safe upper bound for app-level UI */
}

/* Notifications stay below modals */
.notification {
  z-index: 100 !important;
}

/* Modals are modal (layer above content) */
.dialog.modal,
.application.modal
{
  z-index: 50 !important;
}

/* ===========================
   PHASE 5: Overflow Predictability
   =========================== */

/* Rule: Overflow hidden on flex parents requires explicit height or flex constraint */

/* If overflow: hidden is used, ensure parent has height context */
[style*="overflow: hidden"],
[class*="overflow-hidden"]
{
  /* These need parent height or flex: 1 + min-height: 0 */
  /* Audit: check parent of any overflow: hidden */
}

/* ===========================
   EMERGENCY FIXES (High Risk Clusters)
   =========================== */

/* Fix: Remove position: relative !important from dialog headers */
.holo .window-header {
  position: relative !important;
  /* ^ This is necessary for dragging, but... */
  overflow: visible !important;
  /* ^ Never clip header content */
}

/* Fix: Dialog headers must not clip inner controls */
.dialog .window-header::after,
.dialog .window-header [class*="control"]
{
  overflow: visible !important;
  clip: auto !important;
}

/* ===========================
   MEASUREMENT STABILITY
   =========================== */

/* Ensure scrollbar width doesn't cause overflow */
.swse * {
  box-sizing: border-box;
  /* ^ Critical: includes padding/border in width calculations */
}

/* ===========================
   FORM CONTAINER HARDENING
   =========================== */

/* Form containers in flex context need scroll stability */
form.swse-app,
form.swse-dialog,
form[class*="swse"]
{
  display: flex;
  flex-direction: column;
  min-height: 0;
}

form.swse-app .form-group,
form.swse-dialog .form-group
{
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* ===========================
   NOTES FOR NEXT SESSION
   =========================== */

/*
  This layer is a defensive overlay.
  It does NOT fix the underlying CSS.
  It prevents the most dangerous patterns from breaking AppV2.

  Next steps:
  1. Use this layer to stabilize the system
  2. Run boot + full test checklist
  3. If issues remain, audit individual files:
     - styles/apps/chargen/*.css
     - styles/sheets/*.css
     - styles/components/*.css
  4. Replace defensive fixes with permanent repairs to source files

  DO NOT rely on this layer long-term.
  It's a safety net during migration, not production code.
*/
