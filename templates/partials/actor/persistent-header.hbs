{{!-- Persistent Header HUD — Cockpit-Style Character Interface --}}
{{!-- Three-tier hierarchy: Identity → Combat Readiness → Status/Build --}}

<header class="sheet-header hud-cockpit flexrow">

  {{!-- ═══════════════════════════════════════════════════════════════════════
       LEFT: COMMAND STACK (Identity + Actions)
       Primary: Who am I? What can I do?
       ═══════════════════════════════════════════════════════════════════════ --}}
  <div class="window-app-drag-handle hud-command-stack flex0">

    {{!-- Identity Card: Portrait + Name/Level as single unit --}}
    <div class="identity-card">
      <img class="portrait" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" />

      <div class="identity-info">
        <input class="character-name-input" name="name" type="text" value="{{actor.name}}" placeholder="Name"/>

        <div class="level-badge">
          <span class="level-label">LVL</span>
          <input class="level-input" name="system.level" type="number" value="{{system.level}}" min="1" max="20" data-dtype="Number"/>
        </div>
      </div>
    </div>

    {{!-- Quick Actions: Icon-primary, text on hover --}}
    <div class="quick-actions">
      <button class="action-btn level-up" title="Level Up Character" data-tooltip="Level Up">
        <i class="fas fa-level-up-alt"></i>
        <span class="action-label">Level Up</span>
      </button>

      {{#unless chargenComplete}}
      <button class="action-btn character-generator" title="Character Generator" data-tooltip="Chargen">
        <i class="fas fa-user-plus"></i>
        <span class="action-label">Chargen</span>
      </button>
      {{/unless}}

      <button class="action-btn open-store" title="Open Marketplace" data-tooltip="Shop">
        <i class="fas fa-store"></i>
        <span class="action-label">Shop</span>
      </button>

      <button class="action-btn talk-to-mentor" title="Talk to Mentors" data-tooltip="Mentor">
        <i class="fas fa-comments"></i>
        <span class="action-label">Mentor</span>
      </button>
    </div>
  </div>

  {{!-- ═══════════════════════════════════════════════════════════════════════
       CENTER: COMBAT SNAPSHOT
       "How dangerous/safe am I right now?"
       Tier 1 (Primary): Defenses strip
       Tier 2 (Primary): HP bar
       Tier 3 (Secondary): Force/Destiny
       ═══════════════════════════════════════════════════════════════════════ --}}
  <div class="hud-combat-snapshot flex2">

    {{!-- TIER 1: Defense Strip (answers: "Can I be hit?") --}}
    <div class="defense-strip">
      {{!-- Fort --}}
      <div class="defense-stat" data-defense="fort">
        <span class="def-label">FORT</span>
        <span class="def-value rollable"
              data-roll="1d20+{{system.defenses.fort.total}}"
              data-label="Fortitude Defense"
              title="Click to roll vs. Fortitude">{{system.defenses.fort.total}}</span>
        <select class="def-ability-select" name="system.defenses.fort.ability" title="Ability for Fort">
          <option value="str" {{#if (eq system.defenses.fort.ability "str")}}selected{{/if}}>STR</option>
          <option value="con" {{#if (eq system.defenses.fort.ability "con")}}selected{{/if}}>CON</option>
        </select>
      </div>

      {{!-- Ref --}}
      <div class="defense-stat" data-defense="reflex">
        <span class="def-label">REF</span>
        <span class="def-value rollable"
              data-roll="1d20+{{system.defenses.reflex.total}}"
              data-label="Reflex Defense"
              title="Click to roll vs. Reflex">{{system.defenses.reflex.total}}</span>
        <span class="def-ability-fixed">DEX</span>
      </div>

      {{!-- Will --}}
      <div class="defense-stat" data-defense="will">
        <span class="def-label">WILL</span>
        <span class="def-value rollable"
              data-roll="1d20+{{system.defenses.will.total}}"
              data-label="Will Defense"
              title="Click to roll vs. Will">{{system.defenses.will.total}}</span>
        <span class="def-ability-fixed">WIS</span>
      </div>

      <div class="defense-divider"></div>

      {{!-- Flat-Footed (secondary) --}}
      <div class="defense-stat secondary" data-defense="flatFooted">
        <span class="def-label">FF</span>
        <span class="def-value rollable"
              data-roll="1d20+{{system.defenses.flatFooted.total}}"
              data-label="Flat-Footed Defense"
              title="Flat-Footed (Ref - DEX)">{{system.defenses.flatFooted.total}}</span>
      </div>
    </div>

    {{!-- TIER 2: HP Bar (Primary - most dynamic) --}}
    <div class="hp-display">
      <div class="hp-bar-wrapper">
        <div class="hp-bar">
          <div class="hp-fill" style="width: {{hpPercentage}}%"></div>
          <div class="hp-text">
            <span class="hp-label">HP</span>
            <input class="hp-current" type="text" name="system.hp.value" value="{{system.hp.value}}" data-dtype="Number" title="Current HP"/>
            <span class="hp-sep">/</span>
            <input class="hp-max" type="text" name="system.hp.max" value="{{system.hp.max}}" data-dtype="Number" title="Max HP"/>
            {{#if system.hp.bonus}}
            <span class="hp-bonus" title="Bonus HP (shield)"><i class="fas fa-shield-alt"></i>+{{system.hp.bonus}}</span>
            {{/if}}
          </div>
        </div>
      </div>
    </div>

    {{!-- TIER 3: Secondary Resources (Force Points / Destiny) --}}
    <div class="secondary-resources">
      {{!-- Force Points --}}
      <div class="resource-compact fp">
        <span class="res-label">FP</span>
        <input class="res-current" type="text" name="system.forcePoints.value" value="{{system.forcePoints.value}}" data-dtype="Number" title="Current Force Points"/>
        <span class="res-sep">/</span>
        <input class="res-max" type="text" name="system.forcePoints.max" value="{{system.forcePoints.max}}" data-dtype="Number" title="Max Force Points"/>
        <button class="roll-fp rollable" title="Roll Force Point" data-roll="{{system.forcePoints.diceType}}" data-label="Force Point">
          <i class="fas fa-dice"></i>{{forceRerollDice}}
        </button>
      </div>

      {{!-- Destiny Points (if applicable) --}}
      {{#if system.destiny.hasDestiny}}
      <div class="resource-compact dp {{#if system.destiny.fulfilled}}fulfilled{{/if}}">
        <span class="res-label">DP</span>
        <input class="res-current" type="text" name="system.destinyPoints.value" value="{{system.destinyPoints.value}}" data-dtype="Number" title="Destiny Points" {{#if system.destiny.fulfilled}}disabled{{/if}}/>
        <span class="res-sep">/</span>
        <span class="res-max">{{system.destinyPoints.max}}</span>
        {{#if system.destiny.fulfilled}}
        <span class="destiny-status fulfilled"><i class="fas fa-crown"></i></span>
        {{else}}
        <span class="destiny-status active"><i class="fas fa-star"></i></span>
        {{/if}}
      </div>
      {{/if}}
    </div>

  </div>

  {{!-- ═══════════════════════════════════════════════════════════════════════
       RIGHT: STATUS PANEL
       Top: Condition Track (urgent, high-contrast)
       Bottom: Build State (calmer, informational)
       ═══════════════════════════════════════════════════════════════════════ --}}
  <div class="hud-status-panel flex0">

    {{!-- URGENT: Condition Track (dynamic, combat-relevant) --}}
    <div class="condition-section">
      <div class="condition-header">
        <span class="section-label">CONDITION</span>
        {{#if (gt system.conditionTrack.penalty 0)}}
        <span class="penalty-badge">-{{system.conditionTrack.penalty}}</span>
        {{/if}}
      </div>

      <div class="condition-track-compact">
        <div class="track-pip {{#if (eq system.conditionTrack.current 0)}}active{{/if}}" data-step="0" title="Normal">●</div>
        <div class="track-pip {{#if (gte system.conditionTrack.current 1)}}filled{{/if}}" data-step="1" title="-1">{{#if (gte system.conditionTrack.current 1)}}✓{{else}}○{{/if}}</div>
        <div class="track-pip {{#if (gte system.conditionTrack.current 2)}}filled{{/if}}" data-step="2" title="-2">{{#if (gte system.conditionTrack.current 2)}}✓{{else}}○{{/if}}</div>
        <div class="track-pip {{#if (gte system.conditionTrack.current 3)}}filled{{/if}}" data-step="3" title="-5">{{#if (gte system.conditionTrack.current 3)}}✓{{else}}○{{/if}}</div>
        <div class="track-pip {{#if (gte system.conditionTrack.current 4)}}filled{{/if}}" data-step="4" title="-10">{{#if (gte system.conditionTrack.current 4)}}✓{{else}}○{{/if}}</div>
        <div class="track-pip helpless {{#if (gte system.conditionTrack.current 5)}}filled{{/if}}" data-step="5" title="Helpless">{{#if (gte system.conditionTrack.current 5)}}✗{{else}}○{{/if}}</div>
      </div>

      <div class="condition-controls">
        <button class="cond-btn improve" type="button" title="Recover one step">
          <i class="fas fa-arrow-up"></i>
        </button>
        <label class="persistent-toggle" title="Persistent (prevents recovery)">
          <input type="checkbox" name="system.conditionTrack.persistent" {{checked system.conditionTrack.persistent}}/>
          <span class="toggle-indicator"></span>
        </label>
        <button class="cond-btn worsen" type="button" title="Worsen one step">
          <i class="fas fa-arrow-down"></i>
        </button>
      </div>
    </div>

    {{!-- INFORMATIONAL: Build State (static, rarely changes) --}}
    <div class="build-state-section">
      <div class="build-info">
        {{#if system.race}}
        <span class="build-tag species" title="Species">{{system.race}}</span>
        {{/if}}
        {{#if system.size}}
        <span class="build-tag size" title="Size">{{system.size}}</span>
        {{/if}}
        {{#if system.isForceSensitive}}
        <span class="build-tag force-sensitive" title="Force Sensitive"><i class="fas fa-jedi"></i></span>
        {{/if}}
      </div>
      {{#if displayedClasses}}
      <div class="class-summary" title="Classes">
        {{displayedClasses}}
      </div>
      {{/if}}
    </div>

  </div>
</header>
