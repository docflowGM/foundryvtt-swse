{{!-- Persistent Header with Critical Resources --}}
<header class="window-header sheet-header flexrow">
  <div class="window-app-drag-handle header-left flex0">

    {{!-- Profile Image + Name --}}
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" width="100" height="100"/>

    <div class="character-name">
      <input name="name" type="text" value="{{actor.name}}" placeholder="Character Name"/>
    </div>

    {{!-- Level & Half-Level --}}
    <div class="character-level">
      <label>Level</label>
      <input name="system.level" type="number" value="{{system.level}}" min="1" max="20" data-dtype="Number" class="level-input"/>

      <div class="half-level-display" title="Half Level (rounded down) - used for skills and other bonuses">
        <span class="half-level-label">Â½ Level:</span>
        <span class="half-level-value">{{system.halfLevel}}</span>
      </div>

      <button class="level-up" title="Level Up Character" role="button" tabindex="0">
        <i class="fas fa-level-up-alt" aria-hidden="true"></i> Level Up
      </button>
    </div>

    {{!-- Top-level Character Tools --}}
    <div class="character-actions">
      {{#unless chargenComplete}}
      <button class="character-generator" title="Character Generator" role="button" tabindex="0">
        <i class="fas fa-user-plus" aria-hidden="true"></i> Chargen
      </button>
      {{/unless}}

      <button class="open-store" title="Open Marketplace" role="button" tabindex="0">
        <i class="fas fa-store" aria-hidden="true"></i> Shop
      </button>
    </div>
  </div>

  <div class="header-center flex2">

    {{!-- Defenses Grid --}}
    <div class="defenses grid grid-4col">

      {{!-- Fortitude --}}
      <div class="defense fortitude-defense">
        <div class="defense-header">
          <label class="defense-label">Fort</label>
          <select class="defense-ability-select" name="system.defenses.fort.ability" data-defense="fort">
            <option value="str" {{#if (eq system.defenses.fort.ability "str")}}selected{{/if}}>STR</option>
            <option value="con" {{#if (eq system.defenses.fort.ability "con")}}selected{{/if}}>CON</option>
          </select>
        </div>
        <div class="defense-base">10</div>
        <div class="defense-level" title="Character Level / 2">{{system.level}}/2</div>
        <div class="defense-ability" title="Selected ability modifier">+</div>
        <div class="defense-class" title="Class bonus"></div>
        <div class="defense-misc" title="Miscellaneous bonus">M</div>
        <div class="defense-value rollable"
             data-roll="1d20+{{system.defenses.fort.total}}"
             data-label="Fortitude Defense"
             role="button" tabindex="0"
             title="Roll vs. Fortitude Defense">
          <strong>{{system.defenses.fort.total}}</strong>
        </div>
      </div>

      {{!-- Reflex --}}
      <div class="defense reflex-defense">
        <div class="defense-header">
          <label class="defense-label">Ref</label>
          <span class="defense-ability-fixed" title="Reflex always uses Dexterity">DEX</span>
        </div>
        <div class="defense-base">10</div>
        <div class="defense-level" title="Character Level / 2">{{system.level}}/2</div>
        <div class="defense-ability" title="Dexterity modifier">+</div>
        <div class="defense-class" title="Class bonus"></div>
        <div class="defense-misc" title="Miscellaneous bonus">M</div>
        <div class="defense-value rollable"
             data-roll="1d20+{{system.defenses.reflex.total}}"
             data-label="Reflex Defense"
             role="button" tabindex="0"
             title="Roll vs. Reflex Defense">
          <strong>{{system.defenses.reflex.total}}</strong>
        </div>
      </div>

      {{!-- Will --}}
      <div class="defense will-defense">
        <div class="defense-header">
          <label class="defense-label">Will</label>
          <span class="defense-ability-fixed" title="Will always uses Wisdom">WIS</span>
        </div>
        <div class="defense-base">10</div>
        <div class="defense-level" title="Character Level / 2">{{system.level}}/2</div>
        <div class="defense-ability" title="Wisdom modifier">+</div>
        <div class="defense-class" title="Class bonus"></div>
        <div class="defense-misc" title="Miscellaneous bonus">M</div>
        <div class="defense-value rollable"
             data-roll="1d20+{{system.defenses.will.total}}"
             data-label="Will Defense"
             role="button" tabindex="0"
             title="Roll vs. Will Defense">
          <strong>{{system.defenses.will.total}}</strong>
        </div>
      </div>

      {{!-- Flat-Footed --}}
      <div class="defense flatfooted-defense">
        <div class="defense-header">
          <label class="defense-label">Flat-Footed</label>
        </div>
        <div class="defense-value rollable"
             data-roll="1d20+{{system.defenses.flatFooted.total}}"
             data-label="Flat-Footed Defense"
             role="button" tabindex="0"
             title="Roll vs. Flat-Footed (without DEX bonus)">
          <strong>{{system.defenses.flatFooted.total}}</strong>
        </div>
        <div class="flatfooted-note">Reflex - DEX</div>
      </div>
    </div>

    {{!-- Resources: HP & Force Points --}}
    <div class="resources flexrow">

      {{!-- HP --}}
      <div class="resource hp flex1">
        <label>Hit Points</label>
        <div class="resource-bar flexrow">
          <input type="text"
                 name="system.hp.value"
                 value="{{system.hp.value}}"
                 data-dtype="Number"
                 class="resource-input"/>
          <span class="separator">/</span>
          <span class="resource-max">{{system.hp.max}}</span>
          {{#if system.hp.bonus}}
          <span class="bonus-hp-indicator" title="Bonus Hit Points (temporary damage buffer)">
            <i class="fas fa-shield-alt" aria-hidden="true"></i>+{{system.hp.bonus}}
          </span>
          {{/if}}
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: {{hpPercentage}}%"></div>
        </div>
        {{#if system.hp.bonus}}
        <div class="bonus-hp-info">
          <small>Bonus HP: {{system.hp.bonus}} (consumed before regular HP)</small>
        </div>
        {{/if}}
      </div>

      {{!-- Force Points --}}
      <div class="resource force-points flex1">
        <label>Force Points</label>

        <div class="resource-content flexrow">
          <input type="text"
                 name="system.forcePoints.value"
                 value="{{system.forcePoints.value}}"
                 data-dtype="Number"
                 class="resource-input"
                 title="Current Force Points"/>

          <span class="separator">/</span>

          <input type="text"
                 name="system.forcePoints.max"
                 value="{{system.forcePoints.max}}"
                 data-dtype="Number"
                 class="resource-max-input"
                 title="Maximum Force Points (editable)"/>
        </div>

        <div class="force-point-controls flexrow">
          <div class="reroll-bonus">
            <i class="fas fa-dice" aria-hidden="true"></i> {{forceRerollDice}}
          </div>

          <select name="system.forcePoints.diceType"
                  class="dice-type-select"
                  title="Dice Type">
            <option value="d6" {{#if (eq system.forcePoints.diceType "d6")}}selected{{/if}}>d6</option>
            <option value="d8" {{#if (eq system.forcePoints.diceType "d8")}}selected{{/if}}>d8</option>
          </select>

          <button class="roll-force-point" title="Roll Force Point" role="button" tabindex="0">
            <i class="fas fa-dice-d6" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      {{!-- Destiny Points --}}
      {{#if system.destiny.hasDestiny}}
      <div class="resource destiny-points flex1">
        <label>Destiny Points</label>

        <div class="resource-content flexrow">
          <input type="text"
                 name="system.destinyPoints.value"
                 value="{{system.destinyPoints.value}}"
                 data-dtype="Number"
                 class="resource-input"
                 title="Current Destiny Points"
                 {{#if system.destiny.fulfilled}}disabled{{/if}}/>

          <span class="separator">/</span>

          <span class="resource-max" title="Maximum Destiny Points">{{system.destinyPoints.max}}</span>
        </div>

        <div class="destiny-point-status">
          {{#if system.destiny.fulfilled}}
          <span class="destiny-fulfilled" title="Destiny has been fulfilled">
            <i class="fas fa-crown" aria-hidden="true"></i> Fulfilled
          </span>
          {{else}}
          <span class="destiny-active" title="Destiny is active">
            <i class="fas fa-star" aria-hidden="true"></i> Active
          </span>
          {{/if}}
        </div>
      </div>
      {{/if}}
    </div>

  </div>

  <div class="header-right flex0">

    {{> "systems/foundryvtt-swse/templates/partials/ui/condition-track.hbs"}}

    {{!-- Species --}}
    {{#unless system.isDroid}}
    <div class="species-selector">
      <label class="species-label">
        <i class="fas fa-dna" aria-hidden="true"></i> Species
      </label>
      <div class="species-value">
        {{#if system.race}}
        <span class="species-name">{{system.race}}</span>
        {{else}}
        <span class="species-unselected">Unselected</span>
        {{/if}}
      </div>

      <button class="pick-species-btn" type="button" title="{{#if system.race}}Change species{{else}}Select a species{{/if}}" role="button" tabindex="0">
        <i class="fas fa-{{#if system.race}}exchange-alt{{else}}plus{{/if}}" aria-hidden="true"></i>
        {{#if system.race}}Change{{else}}Select{{/if}}
      </button>
    </div>
    {{/unless}}

    {{!-- Class Display --}}
    <div class="class-selector">
      <label class="class-label">
        <i class="fas fa-hat-wizard" aria-hidden="true"></i> Classes
      </label>
      <div class="class-value">
        {{#if chargenComplete}}
        <span class="class-display">{{classDisplay}}</span>
        {{else}}
        <span class="class-unselected">No classes</span>
        {{/if}}
      </div>
      <button class="add-class-btn" type="button" role="button" tabindex="0" title="Add a class">
        <i class="fas fa-plus" aria-hidden="true"></i> Add Class
      </button>
    </div>

    {{!-- Size --}}
    <div class="character-attribute">
      <label class="attribute-label">
        <i class="fas fa-expand-arrows-alt" aria-hidden="true"></i> Size
      </label>
      <div class="attribute-value">
        <span>{{system.size}}</span>
      </div>
    </div>

    {{!-- Force Sensitive --}}
    {{#unless system.isDroid}}
    <div class="character-attribute">
      <label class="attribute-label">
        <i class="fas fa-hand-sparkles" aria-hidden="true"></i> Force Sensitive
      </label>
      <div class="attribute-value">
        <input type="checkbox"
               name="system.forceSensitive"
               {{checked system.forceSensitive}}
               title="Force Sensitive"/>
      </div>
    </div>
    {{/unless}}
  </div>
</header>
