{{!-- ====================================================================== --}}
{{!-- SWSE Talent Abilities Panel â€” Functional Ability Cards               --}}
{{!-- Displays talent-granted abilities with rollable actions              --}}
{{!-- ====================================================================== --}}

<div class="swse-talent-abilities-container">

  {{#if talentAbilities.all.length}}

    {{!-- Filter Tabs --}}
    <div class="ability-filter-tabs">
      <button class="ability-filter-btn active" data-filter="all" type="button">
        <i class="fas fa-th"></i> All ({{talentAbilities.all.length}})
      </button>
      {{#if talentAbilities.byType.reaction.length}}
      <button class="ability-filter-btn" data-filter="reaction" type="button">
        <i class="fas fa-bolt"></i> Reactions ({{talentAbilities.byType.reaction.length}})
      </button>
      {{/if}}
      {{#if talentAbilities.byType.standard.length}}
      <button class="ability-filter-btn" data-filter="standard" type="button">
        <i class="fas fa-circle"></i> Standard ({{talentAbilities.byType.standard.length}})
      </button>
      {{/if}}
      {{#if talentAbilities.byType.swift.length}}
      <button class="ability-filter-btn" data-filter="swift" type="button">
        <i class="fas fa-wind"></i> Swift ({{talentAbilities.byType.swift.length}})
      </button>
      {{/if}}
      {{#if talentAbilities.byType.passive.length}}
      <button class="ability-filter-btn" data-filter="passive" type="button">
        <i class="fas fa-shield-alt"></i> Passive ({{talentAbilities.byType.passive.length}})
      </button>
      {{/if}}
    </div>

    {{!-- Ability Cards Grid --}}
    <div class="ability-cards-grid">

      {{#each talentAbilities.all as |ability|}}
      <div class="ability-card {{ability.typeBadgeClass}} {{#if ability.isToggleable}}toggleable{{/if}} {{#if ability.isToggled}}toggled{{/if}}"
           data-ability-id="{{ability.id}}"
           data-talent-id="{{ability.sourceTalentId}}"
           data-action-type="{{ability.actionType}}">

        {{!-- Card Header --}}
        <div class="ability-card-header {{#if ability.isMultiOption}}multi-option-header{{/if}}"
             data-action="{{#if ability.isMultiOption}}showMultiOptions{{else}}expandAbility{{/if}}"
             data-ability-id="{{ability.id}}">
          <div class="ability-icon">
            <i class="{{ability.icon}}"></i>
          </div>
          <div class="ability-title-block">
            <span class="ability-name">{{ability.name}}</span>
            {{#if ability.isMultiOption}}
            <span class="ability-source-label">{{ability.subAbilityCount}} Options</span>
            {{else}}
            <span class="ability-source-label">{{ability.talentTree}}</span>
            {{/if}}
          </div>
          <div class="ability-type-badge {{ability.typeBadgeClass}}">
            {{ability.typeLabel}}
          </div>
          <div class="ability-expand-icon">
            {{#if ability.isMultiOption}}
            <i class="fas fa-caret-right"></i>
            {{else}}
            <i class="fas fa-chevron-down"></i>
            {{/if}}
          </div>
        </div>

        {{!-- Card Body (expandable) --}}
        <div class="ability-card-body" id="ability-body-{{ability.id}}">

          {{!-- Multi-Option Sub-Abilities (displayed in popup/modal) --}}
          {{#if ability.isMultiOption}}
          <div class="multi-option-sub-abilities" style="display: none;">
            {{#each ability.subAbilities as |subAbility|}}
            <div class="sub-ability-card"
                 data-sub-ability-id="{{subAbility.id}}"
                 data-parent-ability-id="{{../ability.id}}">

              <div class="sub-ability-header">
                <div class="sub-ability-icon">
                  <i class="{{subAbility.icon}}"></i>
                </div>
                <div class="sub-ability-title">
                  <strong>{{subAbility.name}}</strong>
                  <span class="sub-ability-type">{{subAbility.typeLabel}}</span>
                </div>
                {{#if subAbility.usesData.isLimited}}
                <div class="sub-ability-uses">
                  {{subAbility.usesData.current}}/{{subAbility.usesData.max}}
                </div>
                {{/if}}
              </div>

              <div class="sub-ability-description">
                {{subAbility.description}}
              </div>

              {{#if subAbility.rollData.canRoll}}
              <button class="sub-ability-use-btn"
                      data-action="useSubAbility"
                      data-sub-ability-id="{{subAbility.id}}"
                      data-talent-id="{{subAbility.sourceTalentId}}"
                      type="button">
                <i class="fas fa-dice-d20"></i>
                Use {{subAbility.name}}
              </button>
              {{/if}}

            </div>
            {{/each}}
          </div>
          {{/if}}

          {{!-- Description --}}
          <div class="ability-description">
            {{ability.description}}
          </div>

          {{!-- Trigger/Condition Info --}}
          {{#if ability.trigger}}
          <div class="ability-trigger-info">
            <i class="fas fa-bolt"></i>
            <strong>Trigger:</strong> {{ability.trigger}}
          </div>
          {{/if}}

          {{#if ability.condition}}
          <div class="ability-condition-info">
            <i class="fas fa-check-circle"></i>
            <strong>Condition:</strong> {{ability.condition}}
          </div>
          {{/if}}

          {{!-- Force Point Cost --}}
          {{#if ability.costData}}
          <div class="ability-cost-info {{#unless ability.costData.hasEnough}}insufficient{{/unless}}">
            <i class="fas fa-hand-sparkles"></i>
            <strong>Cost:</strong> {{ability.costData.forcePoints}} Force Point{{#if (gt ability.costData.forcePoints 1)}}s{{/if}}
            <span class="current-fp">(You have: {{ability.costData.currentFP}})</span>
            {{#unless ability.costData.hasEnough}}
            <span class="insufficient-warning">Insufficient!</span>
            {{/unless}}
          </div>
          {{/if}}

          {{!-- Roll Button (for abilities with rolls) --}}
          {{#if ability.rollData.canRoll}}
          <div class="ability-roll-section">
            <button class="ability-roll-btn"
                    data-action="rollAbility"
                    data-ability-id="{{ability.id}}"
                    data-talent-id="{{ability.sourceTalentId}}"
                    type="button">
              <i class="fas fa-dice-d20"></i>
              Roll {{ability.rollData.skillName}}
              <span class="roll-modifier">{{#if (gt ability.rollData.modifier 0)}}+{{/if}}{{ability.rollData.modifier}}</span>
            </button>

            {{#if ability.rollData.vsDefense}}
            <span class="roll-vs-label">{{ability.rollData.vsLabel}}</span>
            {{/if}}

            {{#if ability.rollData.dcLabel}}
            <span class="roll-dc-label">{{ability.rollData.dcLabel}}</span>
            {{/if}}

            {{!-- Conditional Bonus Checkbox --}}
            {{#if ability.rollData.hasConditionalBonus}}
            <label class="conditional-bonus-toggle">
              <input type="checkbox"
                     class="conditional-bonus-checkbox"
                     data-ability-id="{{ability.id}}"
                     data-bonus="{{ability.rollData.conditionalBonus.bonus}}"/>
              <span>{{ability.rollData.conditionalBonus.condition}} (+{{ability.rollData.conditionalBonus.bonus}})</span>
            </label>
            {{/if}}
          </div>
          {{/if}}

          {{!-- Toggle Button (for toggleable abilities) --}}
          {{#if ability.isToggleable}}
          <div class="ability-toggle-section">
            <button class="ability-toggle-btn {{#if ability.isToggled}}active{{/if}}"
                    data-action="toggleAbility"
                    data-ability-id="{{ability.id}}"
                    data-talent-id="{{ability.sourceTalentId}}"
                    type="button">
              <i class="fas {{#if ability.isToggled}}fa-toggle-on{{else}}fa-toggle-off{{/if}}"></i>
              {{#if ability.isToggled}}Active{{else}}Inactive{{/if}}
            </button>
          </div>
          {{/if}}

          {{!-- Choices (for multi-option abilities) --}}
          {{#if ability.hasChoices}}
          <div class="ability-choices-section">
            <h4><i class="fas fa-list"></i> Options:</h4>
            <div class="ability-choices-list">
              {{#each ability.choices as |choice|}}
              <button class="ability-choice-btn"
                      data-action="useAbilityChoice"
                      data-ability-id="{{../ability.id}}"
                      data-choice-index="{{@index}}"
                      type="button">
                <span class="choice-type-badge">{{choice.actionType}}</span>
                <strong>{{choice.name}}</strong>
                <span class="choice-effect">{{choice.effect}}</span>
              </button>
              {{/each}}
            </div>
          </div>
          {{/if}}

          {{!-- Alternative Action --}}
          {{#if ability.hasAlternative}}
          <div class="ability-alternative-section">
            <div class="alternative-label">
              <i class="fas fa-exchange-alt"></i> <strong>Alternative ({{ability.alternativeAction.actionType}}):</strong>
            </div>
            <p>{{ability.alternativeAction.effect}}</p>
          </div>
          {{/if}}

          {{!-- Special Action (like Force Focus recharge) --}}
          {{#if ability.hasSpecialAction}}
          <div class="ability-special-action-section">
            <button class="ability-special-action-btn"
                    data-action="useSpecialAction"
                    data-ability-id="{{ability.id}}"
                    data-talent-id="{{ability.sourceTalentId}}"
                    type="button">
              <i class="fas fa-magic"></i>
              {{ability.specialActionData.name}}
              <span class="special-action-type">({{ability.specialActionData.typeLabel}})</span>
            </button>
            {{#if ability.specialActionData.uses}}
            <span class="special-action-uses">
              {{ability.specialActionData.uses.max}}/{{ability.specialActionData.uses.perEncounter}} per encounter
            </span>
            {{/if}}
          </div>
          {{/if}}

          {{!-- Uses Tracker --}}
          {{#if ability.usesData.isLimited}}
          <div class="ability-uses-tracker">
            <span class="uses-label">Uses:</span>
            <div class="uses-pips">
              {{#times ability.usesData.max}}
              <span class="use-pip {{#if (lte (add @index 1) ../ability.usesData.current)}}filled{{else}}empty{{/if}}"
                    data-use-index="{{@index}}">
              </span>
              {{/times}}
            </div>
            <span class="uses-text">
              {{ability.usesData.current}}/{{ability.usesData.max}}
              ({{ability.usesData.refreshLabel}})
            </span>
          </div>
          {{/if}}

          {{!-- Modifiers Applied --}}
          {{#if ability.isModified}}
          <div class="ability-modifiers-section">
            <h4><i class="fas fa-arrow-up"></i> Enhanced by:</h4>
            <ul class="modifiers-list">
              {{#each ability.modifiers as |mod|}}
              <li>
                <strong>{{mod.name}}</strong>
                <span class="modifier-description">{{mod.description}}</span>
              </li>
              {{/each}}
            </ul>
          </div>
          {{/if}}

          {{!-- Action Buttons --}}
          <div class="ability-action-buttons">
            <button class="ability-post-btn"
                    data-action="postAbility"
                    data-ability-id="{{ability.id}}"
                    data-talent-id="{{ability.sourceTalentId}}"
                    type="button"
                    title="Post ability details to chat">
              <i class="fas fa-comment"></i> Post to Chat
            </button>

            <button class="ability-view-talent-btn"
                    data-action="viewTalent"
                    data-talent-id="{{ability.sourceTalentId}}"
                    type="button"
                    title="View source talent">
              <i class="fas fa-eye"></i> View Talent
            </button>
          </div>

          {{!-- Tags --}}
          {{#if ability.tags}}
          <div class="ability-tags">
            {{#each ability.tags as |tag|}}
            <span class="ability-tag">{{tag}}</span>
            {{/each}}
          </div>
          {{/if}}

        </div>
      </div>
      {{/each}}

    </div>

    {{!-- Reset Uses Button --}}
    <div class="ability-reset-section">
      <button class="ability-reset-btn" data-action="resetEncounterUses" type="button">
        <i class="fas fa-sync"></i> Reset Encounter Uses
      </button>
      <button class="ability-reset-btn" data-action="resetDayUses" type="button">
        <i class="fas fa-sun"></i> Reset Daily Uses
      </button>
    </div>

  {{else}}

    <div class="talent-abilities-empty">
      <i class="fas fa-magic"></i>
      <p>No special abilities from talents yet.</p>
      <p class="empty-hint">Acquire talents to unlock special abilities that appear here as interactive cards!</p>
    </div>

  {{/if}}

</div>
