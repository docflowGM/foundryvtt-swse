<div class="swse-levelup">
  <header class="levelup-header">
    <h2>Level Up: {{actor.name}}</h2>
    <div class="level-indicator">
      <span>Current Level: <strong>{{currentLevel}}</strong></span>
      <i class="{{getIconClass 'arrowRight'}}"></i>
      <span>New Level: <strong>{{newLevel}}</strong></span>
    </div>
    <div class="free-build-controls">
      <label class="free-build-label">
        <input type="checkbox" class="free-build-toggle" {{checked freeBuild}}>
        <i class="{{getIconClass 'unlockAlt'}}"></i> <strong>Free Build Mode</strong>
        <span class="hint-text">Skip validation and build freely</span>
      </label>
    </div>
    <div class="suggestion-tools">
      <button type="button" class="show-prestige-roadmap" {{#if epicBlocked}}disabled{{/if}} title="View prestige class progress and recommendations">
        <i class="{{getIconClass 'route'}}"></i> Prestige Roadmap
      </button>
      {{#if isGM}}
      <button type="button" class="show-gm-debug-panel" {{#if epicBlocked}}disabled{{/if}} title="View BuildIntent analysis (GM only)">
        <i class="{{getIconClass 'bug'}}"></i> Debug
      </button>
      {{/if}}
      <button type="button" class="cancel-levelup btn-danger" title="Cancel level up and discard all selections">
        <i class="{{getIconClass 'times'}}"></i> Cancel
      </button>
    </div>
  </header>

    {{#if epicBlocked}}
    <div class="swse-epic-banner epic-blocked">
      <strong>Epic Override required.</strong> Levels beyond 20 are not officially supported.
      Enable <em>System Settings → Epic Override (Allow Level 21+)</em> to proceed.
    </div>
    {{else if epicAdvisory}}
    <div class="swse-epic-banner epic-advisory">
      <strong>Epic Advisory Mode.</strong> Suggestions are informational only (no ranking / synergy scoring).
    </div>
    {{/if}}

  {{!-- PROGRESS INDICATOR --}}
  <div class="progress-indicator">
    <div class="progress-steps">
      <div class="progress-step {{#if (eq currentStep 'class')}}active{{else if (stepCompleted 'class' currentStep)}}completed{{/if}}" data-step="class">
        <div class="step-number">1</div>
        <div class="step-label">Class</div>
      </div>
      {{#if showMulticlassBonus}}
      <div class="progress-step {{#if (eq currentStep 'multiclass-bonus')}}active{{else if (stepCompleted 'multiclass-bonus' currentStep)}}completed{{/if}}" data-step="multiclass-bonus">
        <div class="step-number">2</div>
        <div class="step-label">Multiclass</div>
      </div>
      {{/if}}
      {{#if getsAbilityIncrease}}
      <div class="progress-step {{#if (eq currentStep 'ability-increase')}}active{{else if (stepCompleted 'ability-increase' currentStep)}}completed{{/if}}" data-step="ability-increase">
        <div class="step-number">{{#if showMulticlassBonus}}3{{else}}2{{/if}}</div>
        <div class="step-label">Abilities</div>
      </div>
      {{/if}}
      {{#if getsBonusFeat}}
      <div class="progress-step {{#if (eq currentStep 'feat')}}active{{else if (stepCompleted 'feat' currentStep)}}completed{{/if}}" data-step="feat">
        <div class="step-number">•</div>
        <div class="step-label">Feat</div>
      </div>
      {{/if}}
      {{#if getsForcePowers}}
      <div class="progress-step {{#if (eq currentStep 'force-powers')}}active{{else if (stepCompleted 'force-powers' currentStep)}}completed{{/if}}" data-step="force-powers">
        <div class="step-number">•</div>
        <div class="step-label">Force Powers</div>
      </div>
      {{/if}}
      {{#if getsTalent}}
      <div class="progress-step {{#if (eq currentStep 'talent')}}active{{else if (stepCompleted 'talent' currentStep)}}completed{{/if}}" data-step="talent">
        <div class="step-number">•</div>
        <div class="step-label">Talent</div>
      </div>
      {{/if}}
      <div class="progress-step {{#if (eq currentStep 'summary')}}active{{/if}}" data-step="summary">
        <div class="step-number">✓</div>
        <div class="step-label">Summary</div>
      </div>
    </div>
  </div>

  {{!-- MENTOR NARRATION PANEL --}}
  {{#if mentor}}
  <aside class="mentor-panel">
    <div class="mentor-header">
      <div class="mentor-info">
        <h4>{{mentor.name}}</h4>
        <span class="mentor-title">{{mentor.title}}</span>
      </div>
      <div class="mentor-portrait">
        <img src="{{mentor.portrait}}" alt="{{mentor.name}}" onerror="this.style.display='none'" />
      </div>
    </div>
    <div class="mentor-message">
      <div class="mentor-greeting">
        <i class="{{getIconClass 'quoteLeft'}}"></i>
        <p>{{mentorGreeting}}</p>
        <i class="{{getIconClass 'quoteRight'}}"></i>
      </div>
      {{#if mentorGuidance}}
      <div class="mentor-guidance">
        <i class="{{getIconClass 'lightbulb'}}"></i>
        <p>{{mentorGuidance}}</p>
      </div>
      {{/if}}
    </div>
  </aside>
  {{/if}}

  <main class="levelup-body">

    {{!-- STEP 0A: SPECIES SELECTION (Level 0 only) --}}
    {{#if (eq currentStep "species")}}
    <section class="step-species-selection">
      <h3>Choose Your Species</h3>
      <p class="hint">Select the species for your character. Each species grants unique bonuses and abilities.</p>

      <div class="species-grid">
        {{#each availableSpecies}}
        <div class="species-card">
          <h5>{{this.name}}</h5>
          {{#if this.system.size}}
          <div class="species-size">
            <span class="size-label">Size: {{this.system.size}}</span>
          </div>
          {{/if}}
          <div class="species-bonuses">
            {{#if this.system.abilities}}
            <span class="bonus-label">{{this.system.abilities}}</span>
            {{/if}}
          </div>
          {{#if this.system.skillBonuses}}
          <div class="skill-bonuses">
            {{#each this.system.skillBonuses}}
            <span class="skill-bonus">{{this}}</span>
            {{/each}}
          </div>
          {{/if}}
          {{#if this.system.special}}
          <div class="special-abilities">
            {{#each this.system.special}}
            <span class="special-ability">{{this}}</span>
            {{/each}}
          </div>
          {{/if}}
          <button class="select-species-btn btn-primary" data-species-id="{{this.id}}" data-species-name="{{this.name}}">
            <i class="{{getIconClass 'dna'}}"></i> Select
          </button>
        </div>
        {{/each}}
      </div>
    </section>
    {{/if}}

    {{!-- STEP 0B: ATTRIBUTES SELECTION (Level 0 only) --}}
    {{#if (eq currentStep "attributes")}}
    <section class="step-attributes-selection">
      <h3>Set Your Ability Scores</h3>
      <p class="hint">Determine your character's base ability scores using the point-buy system or rolling dice.</p>

      {{!-- Reuse the ability generation UI from chargen --}}
      <div class="ability-methods">
        <button type="button" id="pb-init" class="method-button active">
          <i class="{{getIconClass 'calculator'}}"></i> Point Buy (32 points)
        </button>
        <button type="button" id="std-roll-btn" class="method-button">
          <i class="{{getIconClass 'diceD6'}}"></i> Standard Roll (4d6 drop lowest)
        </button>
        <button type="button" id="org-roll-btn" class="method-button">
          <i class="{{getIconClass 'diceD20'}}"></i> Organic Roll (24d6)
        </button>
      </div>

      <div id="point-mode" class="ability-mode">
        <div class="points-remaining">
          Points Remaining: <strong><span id="point-remaining">32</span></strong>
        </div>
        <div class="abilities-grid">
          <div class="ability-card">
            <label>STR</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="str">−</button>
              <input name="ability_str" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="str">+</button>
            </div>
            <div id="display_str" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
          <div class="ability-card">
            <label>DEX</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="dex">−</button>
              <input name="ability_dex" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="dex">+</button>
            </div>
            <div id="display_dex" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
          <div class="ability-card">
            <label>CON</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="con">−</button>
              <input name="ability_con" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="con">+</button>
            </div>
            <div id="display_con" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
          <div class="ability-card">
            <label>INT</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="int">−</button>
              <input name="ability_int" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="int">+</button>
            </div>
            <div id="display_int" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
          <div class="ability-card">
            <label>WIS</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="wis">−</button>
              <input name="ability_wis" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="wis">+</button>
            </div>
            <div id="display_wis" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
          <div class="ability-card">
            <label>CHA</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="cha">−</button>
              <input name="ability_cha" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="cha">+</button>
            </div>
            <div id="display_cha" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
        </div>
      </div>

      <div id="standard-mode" class="ability-mode" style="display:none;">
        <div id="roll-results" class="roll-results"></div>
        <p class="hint">Click a roll value, then click an ability to assign it.</p>
      </div>

      <div id="organic-mode" class="ability-mode" style="display:none;">
        <div id="organic-groups" class="organic-groups"></div>
        <p class="hint">Click a group, then click an ability to assign the total.</p>
      </div>

      <div class="form-actions">
        <button type="button" class="confirm-attributes-btn btn-primary">
          Confirm Attributes <i class="{{getIconClass 'arrowRight'}}"></i>
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 1: CLASS SELECTION --}}
    {{#if (eq currentStep "class")}}
    <section class="step-class-selection">
      <header class="creator-header">
        <h1><i class="{{getIconClass 'star'}}"></i> Choose Your Path</h1>
        <p class="subtitle">Select a class to advance your character</p>
      </header>

      <div class="current-classes">
        <h4>Current Classes:</h4>
        {{#each characterClasses}}
          <span class="class-badge">{{@key}} ({{this}})</span>
        {{else}}
          <span class="empty">No classes yet</span>
        {{/each}}
      </div>

      {{!-- Suggested Classes Section (only show if there are suggestions) --}}
      {{#if hasSuggestedClasses}}
      <div class="class-selection-container suggested-classes-section">
        <h4 class="class-category-title suggested-title">
          <i class="{{getIconClass 'lightbulb'}}"></i> Suggested for Your Build
        </h4>
        <div class="class-suggestion-legend">
          <div class="class-suggestion-legend-item tier-prestige">
            <span class="legend-icon"><i class="{{getIconClass 'star'}}"></i></span>
            <span>Qualified Prestige</span>
          </div>
          <div class="class-suggestion-legend-item tier-path">
            <span class="legend-icon"><i class="{{getIconClass 'route'}}"></i></span>
            <span>Continue Path</span>
          </div>
          <div class="class-suggestion-legend-item tier-unlock">
            <span class="legend-icon"><i class="{{getIconClass 'unlock'}}"></i></span>
            <span>Near Prestige</span>
          </div>
          <div class="class-suggestion-legend-item tier-synergy">
            <span class="legend-icon"><i class="{{getIconClass 'PLACEHOLDER_'}}"></i></span>
            <span>Build Synergy</span>
          </div>
        </div>
        <div class="class-grid-enhanced suggested-grid">
          {{#each availableClasses}}
            {{#if this.isSuggested}}
            <div class="class-choice-btn {{#if this.isPrestige}}prestige-class{{/if}} is-suggested {{this.suggestion.cssClass}}"
                 data-class-id="{{this.id}}"
                 data-suggestion-tier="{{this.suggestion.tier}}">
              {{!-- Suggestion Badge --}}
              {{#if this.suggestion.iconClass}}
              <span class="class-suggestion-badge {{this.suggestion.cssClass}}" title="{{this.suggestion.reason}}">
                <i class="{{this.suggestion.iconClass}}"></i>
              </span>
              {{/if}}
              <div class="class-icon {{#if this.isPrestige}}prestige-icon{{/if}}">
                <i class="fa-solid {{this.icon}}"></i>
              </div>
              <h3>{{this.name}}</h3>
              <p class="class-desc">{{this.description}}</p>
              <p class="suggestion-reason">{{this.suggestion.reason}}</p>
              <div class="class-stats">
                <span>Hit Die: d{{this.system.hitDie}}</span>
                <span>{{this.system.babProgression}}</span>
              </div>
              {{!-- Missing Prerequisites Tooltip --}}
              {{#if this.suggestion.hasMissingPrereqs}}
              <div class="missing-prereqs-hint">
                <i class="{{getIconClass 'exclamation'}}"></i>
                <span>{{#each this.suggestion.missingPrereqs}}{{#if @index}}, {{/if}}{{this.shortDisplay}}{{/each}}</span>
              </div>
              {{/if}}
              <div class="select-overlay {{#if this.isPrestige}}prestige-overlay{{/if}}">
                <span>Select {{this.name}}</span>
              </div>
            </div>
            {{/if}}
          {{/each}}
        </div>
      </div>
      {{/if}}

      {{!-- Core Base Classes with beautiful UI --}}
      <div class="class-selection-container">
        <h4 class="class-category-title">Core Classes</h4>
        <div class="class-grid-enhanced">
          {{#each availableClasses}}
            {{#if (and this.isBase (or (eq this.name "Jedi") (eq this.name "Noble") (eq this.name "Scout") (eq this.name "Scoundrel") (eq this.name "Soldier")))}}
            <div class="class-choice-btn {{#if this.isSuggested}}is-suggested {{this.suggestion.cssClass}}{{/if}}"
                 data-class-id="{{this.id}}"
                 {{#if this.suggestion}}data-suggestion-tier="{{this.suggestion.tier}}"{{/if}}>
              {{!-- Suggestion Badge --}}
              {{#if this.suggestion.iconClass}}
              <span class="class-suggestion-badge {{this.suggestion.cssClass}}" title="{{this.suggestion.reason}}">
                <i class="{{this.suggestion.iconClass}}"></i>
              </span>
              {{/if}}
              <div class="class-icon">
                <i class="fa-solid {{this.icon}}"></i>
              </div>
              <h3>{{this.name}}</h3>
              <p class="class-desc">{{this.description}}</p>
              {{#if this.suggestion.reason}}
              <p class="suggestion-reason">{{this.suggestion.reason}}</p>
              {{/if}}
              <div class="class-stats">
                <span>Hit Die: d{{this.system.hitDie}}</span>
                <span>{{this.system.babProgression}}</span>
              </div>
              <div class="select-overlay">
                <span>Select {{this.name}}</span>
              </div>
            </div>
            {{/if}}
          {{/each}}
        </div>

        {{!-- Prestige Classes Section --}}
        {{#if (or (gte newLevel 7) freeBuild)}}
        <div class="prestige-section">
          <button class="show-prestige-btn btn-prestige">
            <i class="{{getIconClass 'crown'}}"></i> Explore Prestige Classes
            <span class="prestige-hint">Advanced classes for experienced heroes{{#if freeBuild}} (Free Build){{/if}}</span>
          </button>
        </div>
        {{/if}}

        {{!-- Ask Mentor Button for Class Selection --}}
        <div class="class-mentor-actions">
          <button class="ask-mentor-class-suggestion btn-mentor" title="Get a suggestion from your mentor">
            <i class="{{getIconClass 'lightbulb'}}"></i> Ask {{mentor.name}} for Guidance
          </button>
        </div>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 1B: PRESTIGE CLASS SELECTION --}}
    {{#if (eq currentStep "prestige")}}
    <section class="step-prestige-selection">
      <header class="creator-header">
        <h1><i class="{{getIconClass 'crown'}}"></i> Prestige Classes</h1>
        <p class="subtitle">Advanced classes for experienced heroes (Level 7+)</p>
      </header>

      {{!-- Suggestion Legend for Prestige Classes --}}
      <div class="class-suggestion-legend prestige-legend">
        <div class="class-suggestion-legend-item tier-prestige">
          <span class="legend-icon"><i class="{{getIconClass 'star'}}"></i></span>
          <span>You Qualify Now</span>
        </div>
        <div class="class-suggestion-legend-item tier-unlock">
          <span class="legend-icon"><i class="{{getIconClass 'unlock'}}"></i></span>
          <span>Almost Qualified</span>
        </div>
        <div class="class-suggestion-legend-item tier-synergy">
          <span class="legend-icon"><i class="{{getIconClass 'PLACEHOLDER_'}}"></i></span>
          <span>Build Synergy</span>
        </div>
      </div>

      <div class="class-grid-enhanced">
        {{#each availableClasses}}
          {{#if this.isPrestige}}
          <div class="class-choice-btn prestige-class {{#if this.isSuggested}}is-suggested {{this.suggestion.cssClass}}{{/if}}"
               data-class-id="{{this.id}}"
               {{#if this.suggestion}}data-suggestion-tier="{{this.suggestion.tier}}"{{/if}}>
            {{!-- Suggestion Badge --}}
            {{#if this.suggestion.iconClass}}
            <span class="class-suggestion-badge {{this.suggestion.cssClass}}" title="{{this.suggestion.reason}}">
              <i class="{{this.suggestion.iconClass}}"></i>
            </span>
            {{/if}}
            <div class="class-icon prestige-icon">
              <i class="fa-solid {{#if this.isSuggested}}fa-star{{else}}fa-crown{{/if}}"></i>
            </div>
            <h3>{{this.name}}</h3>
            <p class="class-desc">{{this.description}}</p>
            {{#if this.suggestion.reason}}
            <p class="suggestion-reason">{{this.suggestion.reason}}</p>
            {{/if}}
            <div class="class-stats">
              <span>Hit Die: d{{this.system.hitDie}}</span>
              <span>{{this.system.babProgression}}</span>
            </div>
            {{!-- Missing Prerequisites Hint --}}
            {{#if this.suggestion.hasMissingPrereqs}}
            <div class="missing-prereqs-hint">
              <i class="{{getIconClass 'exclamation'}}"></i>
              <span>Missing: {{#each this.suggestion.missingPrereqs}}{{#if @index}}, {{/if}}{{this.shortDisplay}}{{/each}}</span>
            </div>
            {{/if}}
            <div class="select-overlay prestige-overlay">
              <span>Select {{this.name}}</span>
            </div>
          </div>
          {{/if}}
        {{/each}}
      </div>

      <div class="form-actions">
        <button class="back-to-base-classes btn-secondary">
          <i class="{{getIconClass 'arrowLeft'}}"></i> Back to Base Classes
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 2: MULTICLASS BONUS --}}
    {{#if (eq currentStep "multiclass-bonus")}}
    <section class="step-multiclass-bonus">
      <h3>Multi-class Bonus</h3>
      <p class="hint">You are taking a second base class! Choose your bonus (you can always choose feat OR skill):</p>

      <div class="multiclass-choice">
        {{#unless (eq multiclassBonusChoice "all_feats")}}
        <div class="bonus-options">
          <div class="bonus-option">
            <h4>Choose ONE Starting Feat</h4>
            <div class="feat-selection">
              {{#each selectedClass.system.startingFeatures}}
                {{#if (eq this.type "feat_grant")}}
                <button class="select-feat-btn choice-button" data-feat-id="{{this.name}}">
                  <i class="{{getIconClass 'star'}}"></i> {{this.name}}
                </button>
                {{/if}}
              {{/each}}
            </div>
          </div>

          <div class="bonus-option-divider">
            <span>OR</span>
          </div>

          <div class="bonus-option">
            <h4>Choose ONE Trained Skill</h4>
            <div class="skill-selection">
              {{#each selectedClass.system.classSkills}}
              <button class="select-skill-btn choice-button" data-skill="{{this}}">
                <i class="{{getIconClass 'success'}}"></i> {{this}}
              </button>
              {{/each}}
            </div>
          </div>
        </div>
        {{/unless}}

        {{#if (eq multiclassBonusChoice "all_feats")}}
        <p>You will receive ALL starting feats from {{selectedClass.name}}!</p>
        <button class="next-step btn-primary" {{#if epicBlocked}}disabled{{/if}}>
          Continue <i class="{{getIconClass 'arrowRight'}}"></i>
        </button>
        {{/if}}
      </div>
    </section>
    {{/if}}

    {{!-- STEP 3: ABILITY SCORE INCREASES --}}
    {{#if (eq currentStep "ability-increase")}}
    <section class="step-ability-increase">
      <h3>Ability Score Increase</h3>
      <p class="hint">
        At level {{newLevel}}, you gain +2 ability score points to allocate.
        {{#if (eq abilityIncreaseMethod "flexible")}}
          <br><strong>Flexible Method:</strong> You can apply 2 points to ONE attribute OR 1 point to TWO attributes.
        {{else}}
          <br><strong>Standard Method:</strong> You must apply 1 point to TWO different attributes.
        {{/if}}
      </p>
      <div class="ability-increase-actions">
        <button type="button" class="ask-mentor-attribute btn-info" title="Get mentor suggestion for which attribute to increase">
          <i class="{{getIconClass 'lightbulb'}}"></i> Ask Mentor
        </button>
      </div>

      <div class="ability-increase-grid">
        {{#each actor.system.attributes}}
        <div class="ability-increase-card">
          <h4>{{@key}}</h4>
          <div class="ability-current">
            <span>Current: {{this.base}}</span>
            <span>Mod: {{#if (gte this.mod 0)}}+{{/if}}{{this.mod}}</span>
          </div>
          <button class="ability-increase-btn btn-primary" data-ability="{{@key}}">
            <i class="{{getIconClass 'circle'}}-plus"></i> Add +1
          </button>
          {{#if (lookup ../abilityIncreases @key)}}
          <div class="ability-allocated">
            +{{lookup ../abilityIncreases @key}} allocated
          </div>
          {{/if}}
        </div>
        {{/each}}
      </div>

      <div class="ability-progress">
        <p>Points Allocated: <strong>{{#each abilityIncreases}}{{this}}{{#unless @last}}+{{/unless}}{{/each}} / 2</strong></p>
      </div>

      <div class="form-actions">
        <button class="prev-step btn-secondary">
          <i class="{{getIconClass 'arrowLeft'}}"></i> Back
        </button>
        <button class="skip-step btn-warning" title="Skip this step (you'll need to add missing selections later)">
          <i class="{{getIconClass 'forward'}}"></i> Skip
        </button>
        <button class="next-step btn-primary" {{#if epicBlocked}}disabled{{/if}}>
          Continue <i class="{{getIconClass 'arrowRight'}}"></i>
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 4: FEAT SELECTION --}}
    {{#if (eq currentStep "feat")}}
    <section class="step-feat-selection">
      <h3>Select a Bonus Feat</h3>
      <p class="hint">At level {{newLevel}}, you gain a bonus feat. Choose one that fits your character concept.</p>

      {{#if selectedFeats}}
      <div class="selected-feats-display">
        <h4>Selected Feats:</h4>
        {{#each selectedFeats}}
        <div class="selected-feat">
          <strong>{{this.name}}</strong> - {{this.system.benefit}}
        </div>
        {{/each}}
      </div>
      {{/if}}

      {{!-- FEAT SEARCH AND FILTER CONTROLS --}}
      <div class="feat-controls">
        <div class="feat-search-bar">
          <i class="{{getIconClass 'search'}}"></i>
          <input type="text" class="feat-search-input" placeholder="Search feats by name or tag..." />
          <button class="clear-search-btn" title="Clear search" style="display: none;">
            <i class="{{getIconClass 'times'}}"></i>
          </button>
        </div>

        <div class="feat-filter-controls">
          <label class="filter-label">
            <input type="checkbox" class="show-unavailable-toggle" />
            <span>Show unavailable feats (grayed)</span>
          </label>

          <button class="clear-filters-btn">
            <i class="{{getIconClass 'redo'}}"></i> Clear All Filters
          </button>
        </div>
      </div>

      {{!-- ACTIVE TAG FILTERS --}}
      <div class="active-tag-filters" style="display: none;">
        <span class="filter-label-text">Active Tags:</span>
        <div class="active-tags-container"></div>
      </div>

      {{!-- FEAT CATEGORIES --}}
      {{!-- Suggestion Legend --}}
      <div class="suggestion-legend">
        <div class="suggestion-legend-item tier-chain">
          <span class="legend-icon"><i class="{{getIconClass 'link'}}"></i></span>
          <span>Chain Continuation</span>
        </div>
        <div class="suggestion-legend-item tier-skill">
          <span class="legend-icon"><i class="{{getIconClass 'bullseye'}}"></i></span>
          <span>Uses Trained Skill</span>
        </div>
        <div class="suggestion-legend-item tier-ability">
          <span class="legend-icon"><i class="{{getIconClass 'fist'}}"></i></span>
          <span>Matches Highest Ability</span>
        </div>
        <div class="suggestion-legend-item tier-class">
          <span class="legend-icon"><i class="{{getIconClass 'users'}}-cog"></i></span>
          <span>Class Synergy</span>
        </div>
      </div>

      <div class="feat-categories-container">
        {{!-- Show "Future Available" section if there are items that will become available soon --}}
        {{#if futureAvailableFeats}}
        <div class="feat-category future-available-category">
          <div class="category-header">
            <div class="category-icon"><i class="{{getIconClass 'hourglassEnd'}}"></i></div>
            <div class="category-info">
              <h4>Future Available</h4>
              <p class="category-description">Feats that will become available with continued progression</p>
            </div>
            <div class="category-count">
              <span class="count-badge">{{futureAvailableFeats.length}}</span>
            </div>
            <button class="category-toggle-btn">
              <i class="{{getIconClass 'chevronDown'}}"></i>
            </button>
          </div>

          <div class="category-feats" style="display: none;">
            <div class="feat-selection-grid" data-category-grid="future">
              {{#each futureAvailableFeats}}
              <div class="feat-card feat-with-tooltip {{#if this.isSuggested}}is-suggested{{/if}} {{#if this.suggestion.cssClass}}{{this.suggestion.cssClass}}{{/if}} suggestion-future-available"
                   data-feat-id="{{this._id}}"
                   data-feat-name="{{this.name}}"
                   data-suggestion-tier="{{this.suggestion.tier}}"
                   title="{{this.suggestion.reason}}">
                <span class="suggestion-badge {{this.suggestion.cssClass}}" title="{{this.suggestion.reason}}">
                  <i class="{{this.suggestion.iconClass}}"></i>
                </span>
                <h4>{{this.name}}</h4>

                {{#if this.system.prerequisites}}
                <div class="feat-prereqs">
                  <strong>Prerequisites:</strong> {{this.system.prerequisites}}
                </div>
                {{/if}}

                {{#if this.suggestion.unmetRequirements}}
                <div class="feat-unmet-prereqs" style="color: #f59e0b; margin: 0.5em 0; font-weight: bold; font-size: 0.9em;">
                  <i class="{{getIconClass 'hourglassEnd'}}"></i> Available in {{this.suggestion.levelsToQualify}} level(s)
                  {{#if this.suggestion.recommendations}}
                  <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                  {{#each this.suggestion.recommendations}}
                    <li style="font-size: 0.85em;">{{this}}</li>
                  {{/each}}
                  </ul>
                  {{/if}}
                </div>
                {{/if}}

                <button class="select-bonus-feat choice-button" disabled title="Prerequisites not yet met">
                  <i class="{{getIconClass 'hourglassEnd'}}"></i> Coming Soon
                </button>
              </div>
              {{/each}}
            </div>
          </div>
        </div>
        {{/if}}

        {{#each featCategories}}
        <div class="feat-category" data-category="{{this.id}}">
          <div class="category-header">
            <div class="category-icon">{{this.icon}}</div>
            <div class="category-info">
              <h4>{{this.name}}</h4>
              <p class="category-description">{{this.description}}</p>
            </div>
            <div class="category-count">
              <span class="count-badge">{{this.count}}</span>
            </div>
            <button class="category-toggle-btn">
              <i class="{{getIconClass 'chevronDown'}}"></i>
            </button>
          </div>

          <div class="category-feats" style="display: none;">
            <div class="feat-selection-grid" data-category-grid="{{this.id}}">
              {{#each this.feats}}
              <div class="feat-card feat-with-tooltip {{#if this.isSelected}}selected{{/if}} {{#if this.isUnavailable}}unavailable{{/if}} {{#if this.isOwned}}{{#unless this.isRepeatable}}owned{{/unless}}{{/if}} {{#if this.indentLevel}}feat-indent-{{this.indentLevel}}{{/if}} {{#if this.isSuggested}}is-suggested{{/if}} {{#if this.suggestion.cssClass}}{{this.suggestion.cssClass}}{{/if}}"
                   data-feat-id="{{this._id}}"
                   data-feat-name="{{this.name}}"
                   data-feat-tags="{{this.tagsString}}"
                   data-feat-category="{{../this.id}}"
                   data-indent-level="{{this.indentLevel}}"
                   data-is-repeatable="{{this.isRepeatable}}"
                   data-suggestion-tier="{{this.suggestion.tier}}"
                   data-tooltip="{{this.system.benefit}}">
                {{#if this.isOwned}}
                <div class="feat-owned-badge {{#if this.isRepeatable}}repeatable{{/if}}">
                  <i class="{{getIconClass 'success'}}"></i> {{#if this.isRepeatable}}Owned (Repeatable){{else}}Owned{{/if}}
                </div>
                {{/if}}
                {{#if this.isSuggested}}
                <span class="suggestion-badge {{this.suggestion.cssClass}}" title="{{this.suggestion.reason}}">
                  <i class="{{this.suggestion.iconClass}}"></i>
                </span>
                {{/if}}
                <h4>{{this.name}}</h4>

                {{#if this.chain}}
                <div class="feat-chain-badge">
                  <i class="{{getIconClass 'link'}}"></i> {{this.chain}}
                </div>
                {{/if}}

                {{#if this.system.prerequisites}}
                <div class="feat-prereqs {{#if this.isUnavailable}}prereqs-unmet{{/if}}">
                  <strong>Prerequisites:</strong> {{this.system.prerequisites}}
                </div>
                {{/if}}

                {{#if this.prereqReasons}}
                <div class="feat-unmet-prereqs" style="color: #ff5555; margin: 0.5em 0; font-weight: bold; font-size: 0.9em;">
                  ⚠ Cannot take:
                  <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                  {{#each this.prereqReasons}}
                    <li style="font-size: 0.9em;">{{this}}</li>
                  {{/each}}
                  </ul>
                </div>
                {{/if}}

                {{#if this.tags}}
                <div class="feat-tags">
                  {{#each this.tags}}
                  <span class="feat-tag" data-tag="{{this}}">{{this}}</span>
                  {{/each}}
                </div>
                {{/if}}

                <button class="select-bonus-feat choice-button"
                        data-feat-id="{{this._id}}"
                        {{#if this.isUnavailable}}disabled title="Prerequisites not met"{{/if}}
                        {{#if this.isOwned}}{{#unless this.isRepeatable}}disabled title="Already owned"{{/unless}}{{/if}}>
                  <i class="fa-solid {{#if this.isOwned}}fa-circle-check{{else}}fa-star{{/if}}"></i> {{#if this.isOwned}}{{#if this.isRepeatable}}Select Again{{else}}Owned{{/if}}{{else if this.isUnavailable}}Unavailable{{else}}Select{{/if}}
                </button>
              </div>
              {{/each}}
            </div>
          </div>
        </div>
        {{/each}}
      </div>

      <div class="form-actions">
        <button class="prev-step btn-secondary">
          <i class="{{getIconClass 'arrowLeft'}}"></i> Back
        </button>
        <button class="ask-mentor-feat-suggestion btn-mentor" title="Get a suggestion from your mentor">
          <i class="{{getIconClass 'star'}}"></i> Ask {{mentor.name}}
        </button>
        <button class="skip-step btn-warning" title="Skip this step (you'll need to add missing selections later)">
          <i class="{{getIconClass 'forward'}}"></i> Skip
        </button>
        <button class="next-step btn-primary" {{#if epicBlocked}}disabled{{/if}}>
          Continue <i class="{{getIconClass 'arrowRight'}}"></i>
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 4.5: FORCE POWER SELECTION --}}
    {{#if (eq currentStep "force-powers")}}
    <section class="step-force-powers-selection">
      <h3>Select Force Powers</h3>

      {{!-- Mentor Guidance --}}
      {{#if mentorGuidance}}
      <div class="mentor-guidance-box">
        <p><strong>{{mentor.name}}:</strong> {{mentorGuidance}}</p>
      </div>
      {{/if}}

      <div class="power-selection-header">
        <p class="hint">Select <strong>{{forcePowerCount}}</strong> Force Power{{#if (ne forcePowerCount 1)}}s{{/if}} ({{selectedForcePowers.length}}/{{forcePowerCount}} selected)</p>
      </div>

      <div class="force-powers-grid">
        {{#each availableForcePowers}}
        <div class="force-power-card feat-with-tooltip {{#if (eq this.id ../selectedForcePowers.*.id)}}selected{{/if}}"
             data-power-id="{{this.id}}"
             data-tooltip="{{this.system.description}}"
             title="{{this.system.description}}">
          {{#if this.img}}
          <div class="power-image">
            <img src="{{this.img}}" alt="{{this.name}}" onerror="this.src='icons/svg/mystery-man.svg'" />
          </div>
          {{else}}
          <div class="power-image no-image">
            <i class="{{getIconClass 'star'}}"></i>
          </div>
          {{/if}}
          <h4 class="power-name">{{this.name}}</h4>
          <button class="select-force-power choice-button" data-power-id="{{this.id}}">
            <i class="fa-solid {{#if (eq this.id ../selectedForcePowers.*.id)}}fa-circle-check{{else}}fa-circle-plus{{/if}}"></i> {{#if (eq this.id ../selectedForcePowers.*.id)}}Selected{{else}}Select{{/if}}
          </button>
        </div>
        {{/each}}
      </div>

      {{#if selectedForcePowers}}
      <div class="selected-powers-summary">
        <h4>Selected Powers:</h4>
        <div class="selected-powers-list">
          {{#each selectedForcePowers}}
          <div class="selected-power-item">
            <i class="{{getIconClass 'success'}}"></i>
            <strong>{{this.name}}</strong>
          </div>
          {{/each}}
        </div>
      </div>
      {{/if}}

      <div class="form-actions">
        <button class="prev-step btn-secondary">
          <i class="{{getIconClass 'arrowLeft'}}"></i> Back
        </button>
        <button class="ask-mentor-force-power-suggestion btn-mentor" title="Get a suggestion from your mentor">
          <i class="{{getIconClass 'lightbulb'}}"></i> Ask {{mentor.name}}
        </button>
        <button class="next-step btn-primary" {{#if epicBlocked}}disabled{{/if}}>
          Continue <i class="{{getIconClass 'arrowRight'}}"></i>
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 5: TALENT SELECTION (Dual Progression) --}}
    {{#if (eq currentStep "talent")}}
    <section class="step-talent-selection dual-talent">
      <h3>Select Talents</h3>

      {{!-- Progress Indicator --}}
      {{#if talentState}}
      <div class="talent-progress-indicator">
        <div class="progress-item {{#if selectedTalents.heroic}}completed{{/if}} {{#if talentState.needsHeroicTalent}}required{{/if}}">
          <i class="fa-solid {{#if selectedTalents.heroic}}fa-circle-check{{else}}fa-circle{{/if}}"></i>
          <span>Heroic Talent</span>
          {{#if selectedTalents.heroic}}
            <small>{{selectedTalents.heroic.name}}</small>
          {{/if}}
        </div>
        {{#if talentState.total}}
        <div class="progress-connector"></div>
        {{/if}}
        {{#if talentState.needsClassTalent}}
        <div class="progress-item {{#if selectedTalents.class}}completed{{/if}} required">
          <i class="fa-solid {{#if selectedTalents.class}}fa-circle-check{{else}}fa-circle{{/if}}"></i>
          <span>Class Talent ({{selectedClass.name}})</span>
          {{#if selectedTalents.class}}
            <small>{{selectedTalents.class.name}}</small>
          {{/if}}
        </div>
        {{/if}}
      </div>
      {{/if}}

      {{!-- Heroic Talent Selection --}}
      {{#if talentState.needsHeroicTalent}}
      <div class="talent-selection-block heroic-talent">
        <div class="talent-block-header">
          <h4>
            <i class="{{getIconClass 'crown'}}"></i> Heroic Talent
            {{#if selectedTalents.heroic}}<span class="badge-success">Selected</span>{{/if}}
          </h4>
          <p class="talent-block-description">
            Choose from any talent tree available to your classes.
          </p>
        </div>

        {{#if selectedTalents.heroic}}
        <div class="selected-talent-card">
          <div class="talent-check"><i class="{{getIconClass 'success'}}"></i></div>
          <div class="talent-details">
            <h5>{{selectedTalents.heroic.name}}</h5>
            <p class="talent-tree">{{selectedTalents.heroic.system.tree}}</p>
            <p class="talent-benefit">{{selectedTalents.heroic.system.benefit}}</p>
          </div>
        </div>
        {{else}}
        <div class="talent-selection-intro">
          <div class="talent-intro-card">
            <div class="talent-intro-icon">
              <i class="{{getIconClass 'projectDiagram'}}"></i>
            </div>
            <h4>Explore Talent Trees</h4>
            <p>View an interactive visualization of available talent trees. Hover to preview, click to explore in detail.</p>
            <button class="select-talent-tree btn-primary-large" data-talent-type="heroic">
              <i class="{{getIconClass 'search'}}-plus"></i>
              Browse Talent Trees
            </button>
          </div>

          {{#if heroicTalentTrees}}
          <div class="quick-tree-buttons">
            <p class="quick-select-label">Or quickly select a tree:</p>
            <div class="talent-tree-grid">
              {{#each heroicTalentTrees}}
              <button class="select-talent-tree choice-button" data-tree="{{this}}" data-talent-type="heroic" title="{{lookup @root.talentTreeDescriptions this}}">
                <i class="{{getIconClass 'tree'}}"></i>
                <span>{{this}}</span>
              </button>
              {{/each}}
            </div>
          </div>
          {{/if}}
        </div>
        {{/if}}
      </div>
      {{/if}}

      {{!-- Class Talent Selection --}}
      {{#if talentState.needsClassTalent}}
      <div class="talent-selection-block class-talent">
        <div class="talent-block-header">
          <h4>
            <i class="{{getIconClass 'shieldAlt'}}"></i> Class Talent
            {{#if selectedTalents.class}}<span class="badge-success">Selected</span>{{/if}}
          </h4>
          <p class="talent-block-description">
            Choose from {{selectedClass.name}}'s talent trees only.
          </p>
        </div>

        {{#if selectedTalents.class}}
        <div class="selected-talent-card">
          <div class="talent-check"><i class="{{getIconClass 'success'}}"></i></div>
          <div class="talent-details">
            <h5>{{selectedTalents.class.name}}</h5>
            <p class="talent-tree">{{selectedTalents.class.system.tree}}</p>
            <p class="talent-benefit">{{selectedTalents.class.system.benefit}}</p>
          </div>
        </div>
        {{else}}
        <div class="talent-selection-intro">
          <div class="talent-intro-card">
            <div class="talent-intro-icon">
              <i class="{{getIconClass 'projectDiagram'}}"></i>
            </div>
            <h4>Explore Talent Trees</h4>
            <p>View an interactive visualization of {{selectedClass.name}}'s talent trees. Hover to preview, click to explore in detail.</p>
            <button class="select-talent-tree btn-primary-large" data-talent-type="class">
              <i class="{{getIconClass 'search'}}-plus"></i>
              Browse Talent Trees
            </button>
          </div>

          {{#if classTalentTrees}}
          <div class="quick-tree-buttons">
            <p class="quick-select-label">Or quickly select a tree:</p>
            <div class="talent-tree-grid">
              {{#each classTalentTrees}}
              <button class="select-talent-tree choice-button" data-tree="{{this}}" data-talent-type="class" title="{{lookup @root.talentTreeDescriptions this}}">
                <i class="{{getIconClass 'tree'}}"></i>
                <span>{{this}}</span>
              </button>
              {{/each}}
            </div>
          </div>
          {{/if}}
        </div>
        {{/if}}
      </div>
      {{/if}}

      <div class="form-actions">
        <button class="prev-step btn-secondary">
          <i class="{{getIconClass 'arrowLeft'}}"></i> Back
        </button>
        <button class="ask-mentor-talent-suggestion btn-mentor" title="Get a suggestion from your mentor">
          <i class="{{getIconClass 'star'}}"></i> Ask {{mentor.name}}
        </button>
        <button class="skip-step btn-warning" title="Skip this step (you'll need to add missing selections later)">
          <i class="{{getIconClass 'forward'}}"></i> Skip
        </button>
        <button class="next-step btn-primary" {{#if epicBlocked}}disabled{{/if}}>
          Continue <i class="{{getIconClass 'arrowRight'}}"></i>
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 5: SUMMARY --}}
    {{#if (eq currentStep "summary")}}
    <section class="step-summary">
      <h3>Level Up Summary</h3>

      <div class="summary-grid">
        <div class="summary-section">
          <h4>Class</h4>
          <p><strong>{{selectedClass.name}}</strong></p>
          <p>Hit Die: d{{selectedClass.system.hitDie}}</p>
        </div>

        <div class="summary-section">
          <h4>HP Gain</h4>
          <p><strong>+{{hpGain}} HP</strong></p>
          <p>New Total: {{add actor.system.hp.max hpGain}}</p>
        </div>

        {{#if selectedTalent}}
        <div class="summary-section">
          <h4>Talent</h4>
          <p><strong>{{selectedTalent.name}}</strong></p>
        </div>
        {{/if}}

        {{#if selectedFeats}}
        <div class="summary-section">
          <h4>Feats</h4>
          {{#each selectedFeats}}
          <p>{{this.name}}</p>
          {{/each}}
        </div>
        {{/if}}

        {{#if selectedSkills}}
        <div class="summary-section">
          <h4>Trained Skills</h4>
          {{#each selectedSkills}}
          <p>{{this}}</p>
          {{/each}}
        </div>
        {{/if}}
      </div>

      <div class="form-actions">
        <button class="prev-step btn-secondary">
          <i class="{{getIconClass 'arrowLeft'}}"></i> Back
        </button>
        <button class="complete-levelup btn-success">
          <i class="{{getIconClass 'check'}}"></i> Complete Level Up
        </button>
      </div>
    </section>
    {{/if}}

  </main>
</div>

