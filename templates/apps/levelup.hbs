<div class="swse-levelup">
  <header class="levelup-header">
    <h2>Level Up: {{actor.name}}</h2>
    <div class="level-indicator">
      <span>Current Level: <strong>{{currentLevel}}</strong></span>
      <i class="fas fa-arrow-right"></i>
      <span>New Level: <strong>{{newLevel}}</strong></span>
    </div>
    <div class="free-build-controls">
      <label class="free-build-label">
        <input type="checkbox" class="free-build-toggle" {{checked freeBuild}}>
        <i class="fas fa-unlock-alt"></i> <strong>Free Build Mode</strong>
        <span class="hint-text">Skip validation and build freely</span>
      </label>
    </div>
    <div class="suggestion-tools">
      <button type="button" class="show-prestige-roadmap" title="View prestige class progress and recommendations">
        <i class="fas fa-route"></i> Prestige Roadmap
      </button>
      {{#if isGM}}
      <button type="button" class="show-gm-debug-panel" title="View BuildIntent analysis (GM only)">
        <i class="fas fa-bug"></i> Debug
      </button>
      {{/if}}
    </div>
  </header>

  {{!-- PROGRESS INDICATOR --}}
  <div class="progress-indicator">
    <div class="progress-steps">
      <div class="progress-step {{#if (eq currentStep 'class')}}active{{else if (stepCompleted 'class' currentStep)}}completed{{/if}}" data-step="class">
        <div class="step-number">1</div>
        <div class="step-label">Class</div>
      </div>
      {{#if showMulticlassBonus}}
      <div class="progress-step {{#if (eq currentStep 'multiclass-bonus')}}active{{else if (stepCompleted 'multiclass-bonus' currentStep)}}completed{{/if}}" data-step="multiclass-bonus">
        <div class="step-number">2</div>
        <div class="step-label">Multiclass</div>
      </div>
      {{/if}}
      {{#if getsAbilityIncrease}}
      <div class="progress-step {{#if (eq currentStep 'ability-increase')}}active{{else if (stepCompleted 'ability-increase' currentStep)}}completed{{/if}}" data-step="ability-increase">
        <div class="step-number">{{#if showMulticlassBonus}}3{{else}}2{{/if}}</div>
        <div class="step-label">Abilities</div>
      </div>
      {{/if}}
      {{#if getsBonusFeat}}
      <div class="progress-step {{#if (eq currentStep 'feat')}}active{{else if (stepCompleted 'feat' currentStep)}}completed{{/if}}" data-step="feat">
        <div class="step-number">•</div>
        <div class="step-label">Feat</div>
      </div>
      {{/if}}
      {{#if getsTalent}}
      <div class="progress-step {{#if (eq currentStep 'talent')}}active{{else if (stepCompleted 'talent' currentStep)}}completed{{/if}}" data-step="talent">
        <div class="step-number">•</div>
        <div class="step-label">Talent</div>
      </div>
      {{/if}}
      <div class="progress-step {{#if (eq currentStep 'summary')}}active{{/if}}" data-step="summary">
        <div class="step-number">✓</div>
        <div class="step-label">Summary</div>
      </div>
    </div>
  </div>

  {{!-- MENTOR NARRATION PANEL --}}
  {{#if mentor}}
  <aside class="mentor-panel">
    <div class="mentor-header">
      <div class="mentor-info">
        <h4>{{mentor.name}}</h4>
        <span class="mentor-title">{{mentor.title}}</span>
      </div>
      <div class="mentor-portrait">
        <img src="{{mentor.portrait}}" alt="{{mentor.name}}" onerror="this.style.display='none'" />
      </div>
    </div>
    <div class="mentor-message">
      <div class="mentor-greeting">
        <i class="fas fa-quote-left"></i>
        <p>{{mentorGreeting}}</p>
        <i class="fas fa-quote-right"></i>
      </div>
      {{#if mentorGuidance}}
      <div class="mentor-guidance">
        <i class="fas fa-lightbulb"></i>
        <p>{{mentorGuidance}}</p>
      </div>
      {{/if}}
    </div>
  </aside>
  {{/if}}

  <main class="levelup-body">

    {{!-- STEP 0A: SPECIES SELECTION (Level 0 only) --}}
    {{#if (eq currentStep "species")}}
    <section class="step-species-selection">
      <h3>Choose Your Species</h3>
      <p class="hint">Select the species for your character. Each species grants unique bonuses and abilities.</p>

      <div class="species-grid">
        {{#each availableSpecies}}
        <div class="species-card">
          <h5>{{this.name}}</h5>
          {{#if this.system.size}}
          <div class="species-size">
            <span class="size-label">Size: {{this.system.size}}</span>
          </div>
          {{/if}}
          <div class="species-bonuses">
            {{#if this.system.abilities}}
            <span class="bonus-label">{{this.system.abilities}}</span>
            {{/if}}
          </div>
          {{#if this.system.skillBonuses}}
          <div class="skill-bonuses">
            {{#each this.system.skillBonuses}}
            <span class="skill-bonus">{{this}}</span>
            {{/each}}
          </div>
          {{/if}}
          {{#if this.system.special}}
          <div class="special-abilities">
            {{#each this.system.special}}
            <span class="special-ability">{{this}}</span>
            {{/each}}
          </div>
          {{/if}}
          <button class="select-species-btn btn-primary" data-species-id="{{this.id}}" data-species-name="{{this.name}}">
            <i class="fas fa-dna"></i> Select
          </button>
        </div>
        {{/each}}
      </div>
    </section>
    {{/if}}

    {{!-- STEP 0B: ATTRIBUTES SELECTION (Level 0 only) --}}
    {{#if (eq currentStep "attributes")}}
    <section class="step-attributes-selection">
      <h3>Set Your Ability Scores</h3>
      <p class="hint">Determine your character's base ability scores using the point-buy system or rolling dice.</p>

      {{!-- Reuse the ability generation UI from chargen --}}
      <div class="ability-methods">
        <button type="button" id="pb-init" class="method-button active">
          <i class="fas fa-calculator"></i> Point Buy (32 points)
        </button>
        <button type="button" id="std-roll-btn" class="method-button">
          <i class="fas fa-dice"></i> Standard Roll (4d6 drop lowest)
        </button>
        <button type="button" id="org-roll-btn" class="method-button">
          <i class="fas fa-dice-d20"></i> Organic Roll (24d6)
        </button>
      </div>

      <div id="point-mode" class="ability-mode">
        <div class="points-remaining">
          Points Remaining: <strong><span id="point-remaining">32</span></strong>
        </div>
        <div class="abilities-grid">
          <div class="ability-card">
            <label>STR</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="str">−</button>
              <input name="ability_str" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="str">+</button>
            </div>
            <div id="display_str" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
          <div class="ability-card">
            <label>DEX</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="dex">−</button>
              <input name="ability_dex" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="dex">+</button>
            </div>
            <div id="display_dex" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
          <div class="ability-card">
            <label>CON</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="con">−</button>
              <input name="ability_con" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="con">+</button>
            </div>
            <div id="display_con" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
          <div class="ability-card">
            <label>INT</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="int">−</button>
              <input name="ability_int" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="int">+</button>
            </div>
            <div id="display_int" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
          <div class="ability-card">
            <label>WIS</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="wis">−</button>
              <input name="ability_wis" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="wis">+</button>
            </div>
            <div id="display_wis" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
          <div class="ability-card">
            <label>CHA</label>
            <div class="ability-controls">
              <button type="button" class="ability-btn" data-minus="cha">−</button>
              <input name="ability_cha" class="ability-input" type="number" value="8" min="8" max="18" />
              <button type="button" class="ability-btn" data-plus="cha">+</button>
            </div>
            <div id="display_cha" class="ability-display">Total: 8 (Mod: -1)</div>
          </div>
        </div>
      </div>

      <div id="standard-mode" class="ability-mode" style="display:none;">
        <div id="roll-results" class="roll-results"></div>
        <p class="hint">Click a roll value, then click an ability to assign it.</p>
      </div>

      <div id="organic-mode" class="ability-mode" style="display:none;">
        <div id="organic-groups" class="organic-groups"></div>
        <p class="hint">Click a group, then click an ability to assign the total.</p>
      </div>

      <div class="form-actions">
        <button type="button" class="confirm-attributes-btn btn-primary">
          Confirm Attributes <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 1: CLASS SELECTION --}}
    {{#if (eq currentStep "class")}}
    <section class="step-class-selection">
      <header class="creator-header">
        <h1><i class="fas fa-star"></i> Choose Your Path</h1>
        <p class="subtitle">Select a class to advance your character</p>
      </header>

      <div class="current-classes">
        <h4>Current Classes:</h4>
        {{#each characterClasses}}
          <span class="class-badge">{{@key}} ({{this}})</span>
        {{else}}
          <span class="empty">No classes yet</span>
        {{/each}}
      </div>

      {{!-- Suggested Classes Section (only show if there are suggestions) --}}
      {{#if hasSuggestedClasses}}
      <div class="class-selection-container suggested-classes-section">
        <h4 class="class-category-title suggested-title">
          <i class="fas fa-lightbulb"></i> Suggested for Your Build
        </h4>
        <div class="class-suggestion-legend">
          <div class="class-suggestion-legend-item tier-prestige">
            <span class="legend-icon"><i class="fas fa-star"></i></span>
            <span>Qualified Prestige</span>
          </div>
          <div class="class-suggestion-legend-item tier-path">
            <span class="legend-icon"><i class="fas fa-route"></i></span>
            <span>Continue Path</span>
          </div>
          <div class="class-suggestion-legend-item tier-unlock">
            <span class="legend-icon"><i class="fas fa-unlock"></i></span>
            <span>Near Prestige</span>
          </div>
          <div class="class-suggestion-legend-item tier-synergy">
            <span class="legend-icon"><i class="fas fa-cogs"></i></span>
            <span>Build Synergy</span>
          </div>
        </div>
        <div class="class-grid-enhanced suggested-grid">
          {{#each availableClasses}}
            {{#if this.isSuggested}}
            <div class="class-choice-btn {{#if this.isPrestige}}prestige-class{{/if}} is-suggested {{this.suggestion.cssClass}}"
                 data-class-id="{{this.id}}"
                 data-suggestion-tier="{{this.suggestion.tier}}">
              {{!-- Suggestion Badge --}}
              {{#if this.suggestion.iconClass}}
              <span class="class-suggestion-badge {{this.suggestion.cssClass}}" title="{{this.suggestion.reason}}">
                <i class="{{this.suggestion.iconClass}}"></i>
              </span>
              {{/if}}
              <div class="class-icon {{#if this.isPrestige}}prestige-icon{{/if}}">
                <i class="fas {{this.icon}}"></i>
              </div>
              <h3>{{this.name}}</h3>
              <p class="class-desc">{{this.description}}</p>
              <p class="suggestion-reason">{{this.suggestion.reason}}</p>
              <div class="class-stats">
                <span>Hit Die: d{{this.system.hitDie}}</span>
                <span>{{this.system.babProgression}}</span>
              </div>
              {{!-- Missing Prerequisites Tooltip --}}
              {{#if this.suggestion.hasMissingPrereqs}}
              <div class="missing-prereqs-hint">
                <i class="fas fa-exclamation-triangle"></i>
                <span>{{#each this.suggestion.missingPrereqs}}{{#if @index}}, {{/if}}{{this.shortDisplay}}{{/each}}</span>
              </div>
              {{/if}}
              <div class="select-overlay {{#if this.isPrestige}}prestige-overlay{{/if}}">
                <span>Select {{this.name}}</span>
              </div>
            </div>
            {{/if}}
          {{/each}}
        </div>
      </div>
      {{/if}}

      {{!-- Core Base Classes with beautiful UI --}}
      <div class="class-selection-container">
        <h4 class="class-category-title">Core Classes</h4>
        <div class="class-grid-enhanced">
          {{#each availableClasses}}
            {{#if (and this.isBase (or (eq this.name "Jedi") (eq this.name "Noble") (eq this.name "Scout") (eq this.name "Scoundrel") (eq this.name "Soldier")))}}
            <div class="class-choice-btn {{#if this.isSuggested}}is-suggested {{this.suggestion.cssClass}}{{/if}}"
                 data-class-id="{{this.id}}"
                 {{#if this.suggestion}}data-suggestion-tier="{{this.suggestion.tier}}"{{/if}}>
              {{!-- Suggestion Badge --}}
              {{#if this.suggestion.iconClass}}
              <span class="class-suggestion-badge {{this.suggestion.cssClass}}" title="{{this.suggestion.reason}}">
                <i class="{{this.suggestion.iconClass}}"></i>
              </span>
              {{/if}}
              <div class="class-icon">
                <i class="fas {{this.icon}}"></i>
              </div>
              <h3>{{this.name}}</h3>
              <p class="class-desc">{{this.description}}</p>
              {{#if this.suggestion.reason}}
              <p class="suggestion-reason">{{this.suggestion.reason}}</p>
              {{/if}}
              <div class="class-stats">
                <span>Hit Die: d{{this.system.hitDie}}</span>
                <span>{{this.system.babProgression}}</span>
              </div>
              <div class="select-overlay">
                <span>Select {{this.name}}</span>
              </div>
            </div>
            {{/if}}
          {{/each}}
        </div>

        {{!-- Prestige Classes Section --}}
        {{#if (or (gte newLevel 7) freeBuild)}}
        <div class="prestige-section">
          <button class="show-prestige-btn btn-prestige">
            <i class="fas fa-crown"></i> Explore Prestige Classes
            <span class="prestige-hint">Advanced classes for experienced heroes{{#if freeBuild}} (Free Build){{/if}}</span>
          </button>
        </div>
        {{/if}}

        {{!-- Ask Mentor Button for Class Selection --}}
        <div class="class-mentor-actions">
          <button class="ask-mentor-class-suggestion btn-mentor" title="Get a suggestion from your mentor">
            <i class="fas fa-lightbulb"></i> Ask {{mentor.name}} for Guidance
          </button>
        </div>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 1B: PRESTIGE CLASS SELECTION --}}
    {{#if (eq currentStep "prestige")}}
    <section class="step-prestige-selection">
      <header class="creator-header">
        <h1><i class="fas fa-crown"></i> Prestige Classes</h1>
        <p class="subtitle">Advanced classes for experienced heroes (Level 7+)</p>
      </header>

      {{!-- Suggestion Legend for Prestige Classes --}}
      <div class="class-suggestion-legend prestige-legend">
        <div class="class-suggestion-legend-item tier-prestige">
          <span class="legend-icon"><i class="fas fa-star"></i></span>
          <span>You Qualify Now</span>
        </div>
        <div class="class-suggestion-legend-item tier-unlock">
          <span class="legend-icon"><i class="fas fa-unlock"></i></span>
          <span>Almost Qualified</span>
        </div>
        <div class="class-suggestion-legend-item tier-synergy">
          <span class="legend-icon"><i class="fas fa-cogs"></i></span>
          <span>Build Synergy</span>
        </div>
      </div>

      <div class="class-grid-enhanced">
        {{#each availableClasses}}
          {{#if this.isPrestige}}
          <div class="class-choice-btn prestige-class {{#if this.isSuggested}}is-suggested {{this.suggestion.cssClass}}{{/if}}"
               data-class-id="{{this.id}}"
               {{#if this.suggestion}}data-suggestion-tier="{{this.suggestion.tier}}"{{/if}}>
            {{!-- Suggestion Badge --}}
            {{#if this.suggestion.iconClass}}
            <span class="class-suggestion-badge {{this.suggestion.cssClass}}" title="{{this.suggestion.reason}}">
              <i class="{{this.suggestion.iconClass}}"></i>
            </span>
            {{/if}}
            <div class="class-icon prestige-icon">
              <i class="fas {{#if this.isSuggested}}fa-star{{else}}fa-crown{{/if}}"></i>
            </div>
            <h3>{{this.name}}</h3>
            <p class="class-desc">{{this.description}}</p>
            {{#if this.suggestion.reason}}
            <p class="suggestion-reason">{{this.suggestion.reason}}</p>
            {{/if}}
            <div class="class-stats">
              <span>Hit Die: d{{this.system.hitDie}}</span>
              <span>{{this.system.babProgression}}</span>
            </div>
            {{!-- Missing Prerequisites Hint --}}
            {{#if this.suggestion.hasMissingPrereqs}}
            <div class="missing-prereqs-hint">
              <i class="fas fa-exclamation-triangle"></i>
              <span>Missing: {{#each this.suggestion.missingPrereqs}}{{#if @index}}, {{/if}}{{this.shortDisplay}}{{/each}}</span>
            </div>
            {{/if}}
            <div class="select-overlay prestige-overlay">
              <span>Select {{this.name}}</span>
            </div>
          </div>
          {{/if}}
        {{/each}}
      </div>

      <div class="form-actions">
        <button class="back-to-base-classes btn-secondary">
          <i class="fas fa-arrow-left"></i> Back to Base Classes
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 2: MULTICLASS BONUS --}}
    {{#if (eq currentStep "multiclass-bonus")}}
    <section class="step-multiclass-bonus">
      <h3>Multi-class Bonus</h3>
      <p class="hint">You are taking a second base class! Choose your bonus (you can always choose feat OR skill):</p>

      <div class="multiclass-choice">
        {{#unless (eq multiclassBonusChoice "all_feats")}}
        <div class="bonus-options">
          <div class="bonus-option">
            <h4>Choose ONE Starting Feat</h4>
            <div class="feat-selection">
              {{#each selectedClass.system.startingFeatures}}
                {{#if (eq this.type "feat_grant")}}
                <button class="select-feat-btn choice-button" data-feat-id="{{this.name}}">
                  <i class="fas fa-star"></i> {{this.name}}
                </button>
                {{/if}}
              {{/each}}
            </div>
          </div>

          <div class="bonus-option-divider">
            <span>OR</span>
          </div>

          <div class="bonus-option">
            <h4>Choose ONE Trained Skill</h4>
            <div class="skill-selection">
              {{#each selectedClass.system.classSkills}}
              <button class="select-skill-btn choice-button" data-skill="{{this}}">
                <i class="fas fa-check-circle"></i> {{this}}
              </button>
              {{/each}}
            </div>
          </div>
        </div>
        {{/unless}}

        {{#if (eq multiclassBonusChoice "all_feats")}}
        <p>You will receive ALL starting feats from {{selectedClass.name}}!</p>
        <button class="next-step btn-primary">
          Continue <i class="fas fa-arrow-right"></i>
        </button>
        {{/if}}
      </div>
    </section>
    {{/if}}

    {{!-- STEP 3: ABILITY SCORE INCREASES --}}
    {{#if (eq currentStep "ability-increase")}}
    <section class="step-ability-increase">
      <h3>Ability Score Increase</h3>
      <p class="hint">
        At level {{newLevel}}, you gain +2 ability score points to allocate.
        {{#if (eq abilityIncreaseMethod "flexible")}}
          <br><strong>Flexible Method:</strong> You can apply 2 points to ONE attribute OR 1 point to TWO attributes.
        {{else}}
          <br><strong>Standard Method:</strong> You must apply 1 point to TWO different attributes.
        {{/if}}
      </p>
      <div class="ability-increase-actions">
        <button type="button" class="ask-mentor-attribute btn-info" title="Get mentor suggestion for which attribute to increase">
          <i class="fas fa-lightbulb"></i> Ask Mentor
        </button>
      </div>

      <div class="ability-increase-grid">
        {{#each actor.system.attributes}}
        <div class="ability-increase-card">
          <h4>{{@key}}</h4>
          <div class="ability-current">
            <span>Current: {{this.base}}</span>
            <span>Mod: {{#if (gte this.mod 0)}}+{{/if}}{{this.mod}}</span>
          </div>
          <button class="ability-increase-btn btn-primary" data-ability="{{@key}}">
            <i class="fas fa-plus-circle"></i> Add +1
          </button>
          {{#if (lookup ../abilityIncreases @key)}}
          <div class="ability-allocated">
            +{{lookup ../abilityIncreases @key}} allocated
          </div>
          {{/if}}
        </div>
        {{/each}}
      </div>

      <div class="ability-progress">
        <p>Points Allocated: <strong>{{#each abilityIncreases}}{{this}}{{#unless @last}}+{{/unless}}{{/each}} / 2</strong></p>
      </div>

      <div class="form-actions">
        <button class="prev-step btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button class="skip-step btn-warning" title="Skip this step (you'll need to add missing selections later)">
          <i class="fas fa-forward"></i> Skip
        </button>
        <button class="next-step btn-primary">
          Continue <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 4: FEAT SELECTION --}}
    {{#if (eq currentStep "feat")}}
    <section class="step-feat-selection">
      <h3>Select a Bonus Feat</h3>
      <p class="hint">At level {{newLevel}}, you gain a bonus feat. Choose one that fits your character concept.</p>

      {{#if selectedFeats}}
      <div class="selected-feats-display">
        <h4>Selected Feats:</h4>
        {{#each selectedFeats}}
        <div class="selected-feat">
          <strong>{{this.name}}</strong> - {{this.system.benefit}}
        </div>
        {{/each}}
      </div>
      {{/if}}

      {{!-- FEAT SEARCH AND FILTER CONTROLS --}}
      <div class="feat-controls">
        <div class="feat-search-bar">
          <i class="fas fa-search"></i>
          <input type="text" class="feat-search-input" placeholder="Search feats by name or tag..." />
          <button class="clear-search-btn" title="Clear search" style="display: none;">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="feat-filter-controls">
          <label class="filter-label">
            <input type="checkbox" class="show-unavailable-toggle" />
            <span>Show unavailable feats (grayed)</span>
          </label>

          <button class="clear-filters-btn">
            <i class="fas fa-redo"></i> Clear All Filters
          </button>
        </div>
      </div>

      {{!-- ACTIVE TAG FILTERS --}}
      <div class="active-tag-filters" style="display: none;">
        <span class="filter-label-text">Active Tags:</span>
        <div class="active-tags-container"></div>
      </div>

      {{!-- FEAT CATEGORIES --}}
      {{!-- Suggestion Legend --}}
      <div class="suggestion-legend">
        <div class="suggestion-legend-item tier-chain">
          <span class="legend-icon"><i class="fas fa-link"></i></span>
          <span>Chain Continuation</span>
        </div>
        <div class="suggestion-legend-item tier-skill">
          <span class="legend-icon"><i class="fas fa-bullseye"></i></span>
          <span>Uses Trained Skill</span>
        </div>
        <div class="suggestion-legend-item tier-ability">
          <span class="legend-icon"><i class="fas fa-fist-raised"></i></span>
          <span>Matches Highest Ability</span>
        </div>
        <div class="suggestion-legend-item tier-class">
          <span class="legend-icon"><i class="fas fa-users-cog"></i></span>
          <span>Class Synergy</span>
        </div>
      </div>

      <div class="feat-categories-container">
        {{!-- Show "Future Available" section if there are items that will become available soon --}}
        {{#if futureAvailableFeats}}
        <div class="feat-category future-available-category">
          <div class="category-header">
            <div class="category-icon"><i class="fas fa-hourglass-end"></i></div>
            <div class="category-info">
              <h4>Future Available</h4>
              <p class="category-description">Feats that will become available with continued progression</p>
            </div>
            <div class="category-count">
              <span class="count-badge">{{futureAvailableFeats.length}}</span>
            </div>
            <button class="category-toggle-btn">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>

          <div class="category-feats" style="display: none;">
            <div class="feat-selection-grid" data-category-grid="future">
              {{#each futureAvailableFeats}}
              <div class="feat-card feat-with-tooltip {{#if this.isSuggested}}is-suggested{{/if}} {{#if this.suggestion.cssClass}}{{this.suggestion.cssClass}}{{/if}} suggestion-future-available"
                   data-feat-id="{{this._id}}"
                   data-feat-name="{{this.name}}"
                   data-suggestion-tier="{{this.suggestion.tier}}"
                   title="{{this.suggestion.reason}}">
                <span class="suggestion-badge {{this.suggestion.cssClass}}" title="{{this.suggestion.reason}}">
                  <i class="{{this.suggestion.iconClass}}"></i>
                </span>
                <h4>{{this.name}}</h4>

                {{#if this.system.prerequisites}}
                <div class="feat-prereqs">
                  <strong>Prerequisites:</strong> {{this.system.prerequisites}}
                </div>
                {{/if}}

                {{#if this.suggestion.unmetRequirements}}
                <div class="feat-unmet-prereqs" style="color: #f59e0b; margin: 0.5em 0; font-weight: bold; font-size: 0.9em;">
                  <i class="fas fa-hourglass-end"></i> Available in {{this.suggestion.levelsToQualify}} level(s)
                  {{#if this.suggestion.recommendations}}
                  <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                  {{#each this.suggestion.recommendations}}
                    <li style="font-size: 0.85em;">{{this}}</li>
                  {{/each}}
                  </ul>
                  {{/if}}
                </div>
                {{/if}}

                <button class="select-bonus-feat choice-button" disabled title="Prerequisites not yet met">
                  <i class="fas fa-hourglass-end"></i> Coming Soon
                </button>
              </div>
              {{/each}}
            </div>
          </div>
        </div>
        {{/if}}

        {{#each featCategories}}
        <div class="feat-category" data-category="{{this.id}}">
          <div class="category-header">
            <div class="category-icon">{{this.icon}}</div>
            <div class="category-info">
              <h4>{{this.name}}</h4>
              <p class="category-description">{{this.description}}</p>
            </div>
            <div class="category-count">
              <span class="count-badge">{{this.count}}</span>
            </div>
            <button class="category-toggle-btn">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>

          <div class="category-feats" style="display: none;">
            <div class="feat-selection-grid" data-category-grid="{{this.id}}">
              {{#each this.feats}}
              <div class="feat-card feat-with-tooltip {{#if this.isSelected}}selected{{/if}} {{#if this.isUnavailable}}unavailable{{/if}} {{#if this.isOwned}}{{#unless this.isRepeatable}}owned{{/unless}}{{/if}} {{#if this.indentLevel}}feat-indent-{{this.indentLevel}}{{/if}} {{#if this.isSuggested}}is-suggested{{/if}} {{#if this.suggestion.cssClass}}{{this.suggestion.cssClass}}{{/if}}"
                   data-feat-id="{{this._id}}"
                   data-feat-name="{{this.name}}"
                   data-feat-tags="{{this.tagsString}}"
                   data-feat-category="{{../this.id}}"
                   data-indent-level="{{this.indentLevel}}"
                   data-is-repeatable="{{this.isRepeatable}}"
                   data-suggestion-tier="{{this.suggestion.tier}}"
                   data-tooltip="{{this.system.benefit}}">
                {{#if this.isOwned}}
                <div class="feat-owned-badge {{#if this.isRepeatable}}repeatable{{/if}}">
                  <i class="fas fa-check-circle"></i> {{#if this.isRepeatable}}Owned (Repeatable){{else}}Owned{{/if}}
                </div>
                {{/if}}
                {{#if this.isSuggested}}
                <span class="suggestion-badge {{this.suggestion.cssClass}}" title="{{this.suggestion.reason}}">
                  <i class="{{this.suggestion.iconClass}}"></i>
                </span>
                {{/if}}
                <h4>{{this.name}}</h4>

                {{#if this.chain}}
                <div class="feat-chain-badge">
                  <i class="fas fa-link"></i> {{this.chain}}
                </div>
                {{/if}}

                {{#if this.system.prerequisites}}
                <div class="feat-prereqs {{#if this.isUnavailable}}prereqs-unmet{{/if}}">
                  <strong>Prerequisites:</strong> {{this.system.prerequisites}}
                </div>
                {{/if}}

                {{#if this.prereqReasons}}
                <div class="feat-unmet-prereqs" style="color: #ff5555; margin: 0.5em 0; font-weight: bold; font-size: 0.9em;">
                  ⚠ Cannot take:
                  <ul style="margin: 0.3em 0 0 1.2em; padding: 0;">
                  {{#each this.prereqReasons}}
                    <li style="font-size: 0.9em;">{{this}}</li>
                  {{/each}}
                  </ul>
                </div>
                {{/if}}

                {{#if this.tags}}
                <div class="feat-tags">
                  {{#each this.tags}}
                  <span class="feat-tag" data-tag="{{this}}">{{this}}</span>
                  {{/each}}
                </div>
                {{/if}}

                <button class="select-bonus-feat choice-button"
                        data-feat-id="{{this._id}}"
                        {{#if this.isUnavailable}}disabled title="Prerequisites not met"{{/if}}
                        {{#if this.isOwned}}{{#unless this.isRepeatable}}disabled title="Already owned"{{/unless}}{{/if}}>
                  <i class="fas {{#if this.isOwned}}fa-check-circle{{else}}fa-star{{/if}}"></i> {{#if this.isOwned}}{{#if this.isRepeatable}}Select Again{{else}}Owned{{/if}}{{else if this.isUnavailable}}Unavailable{{else}}Select{{/if}}
                </button>
              </div>
              {{/each}}
            </div>
          </div>
        </div>
        {{/each}}
      </div>

      <div class="form-actions">
        <button class="prev-step btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button class="ask-mentor-feat-suggestion btn-mentor" title="Get a suggestion from your mentor">
          <i class="fas fa-star"></i> Ask {{mentor.name}}
        </button>
        <button class="skip-step btn-warning" title="Skip this step (you'll need to add missing selections later)">
          <i class="fas fa-forward"></i> Skip
        </button>
        <button class="next-step btn-primary">
          Continue <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 5: TALENT SELECTION --}}
    {{#if (eq currentStep "talent")}}
    <section class="step-talent-selection">
      <h3>Select a Talent</h3>
      <p class="hint">
        {{#if (eq talentTreeRestriction "current")}}
          Choose a talent tree from {{selectedClass.name}}
        {{else}}
          Choose a talent tree from any of your classes
        {{/if}}
      </p>

      <div class="selected-talent-display">
        {{#if selectedTalent}}
        <div class="selected-talent-card">
          <i class="fas fa-check-circle"></i>
          <h4>Selected: {{selectedTalent.name}}</h4>
          <p>{{selectedTalent.system.benefit}}</p>
        </div>
        {{/if}}
      </div>

      <div class="talent-selection-intro">
        <div class="talent-intro-card">
          <div class="talent-intro-icon">
            <i class="fas fa-project-diagram"></i>
          </div>
          <h4>Explore Talent Trees</h4>
          <p>View an interactive visualization of available talent trees. Hover to preview, click to explore in detail.</p>
          <button class="select-talent-tree btn-primary-large">
            <i class="fas fa-search-plus"></i>
            Browse Talent Trees
          </button>
        </div>

        {{#if talentTrees}}
        <div class="quick-tree-buttons">
          <p class="quick-select-label">Or quickly select a tree:</p>
          <div class="talent-tree-grid">
            {{#each talentTrees}}
            <button class="select-talent-tree choice-button" data-tree="{{this}}">
              <i class="fas fa-tree"></i>
              <span>{{this}}</span>
            </button>
            {{/each}}
          </div>
        </div>
        {{/if}}
      </div>

      <div class="form-actions">
        <button class="prev-step btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button class="ask-mentor-talent-suggestion btn-mentor" title="Get a suggestion from your mentor">
          <i class="fas fa-star"></i> Ask {{mentor.name}}
        </button>
        <button class="skip-step btn-warning" title="Skip this step (you'll need to add missing selections later)">
          <i class="fas fa-forward"></i> Skip
        </button>
        <button class="next-step btn-primary">
          Continue <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </section>
    {{/if}}

    {{!-- STEP 5: SUMMARY --}}
    {{#if (eq currentStep "summary")}}
    <section class="step-summary">
      <h3>Level Up Summary</h3>

      <div class="summary-grid">
        <div class="summary-section">
          <h4>Class</h4>
          <p><strong>{{selectedClass.name}}</strong></p>
          <p>Hit Die: d{{selectedClass.system.hitDie}}</p>
        </div>

        <div class="summary-section">
          <h4>HP Gain</h4>
          <p><strong>+{{hpGain}} HP</strong></p>
          <p>New Total: {{add actor.system.hp.max hpGain}}</p>
        </div>

        {{#if selectedTalent}}
        <div class="summary-section">
          <h4>Talent</h4>
          <p><strong>{{selectedTalent.name}}</strong></p>
        </div>
        {{/if}}

        {{#if selectedFeats}}
        <div class="summary-section">
          <h4>Feats</h4>
          {{#each selectedFeats}}
          <p>{{this.name}}</p>
          {{/each}}
        </div>
        {{/if}}

        {{#if selectedSkills}}
        <div class="summary-section">
          <h4>Trained Skills</h4>
          {{#each selectedSkills}}
          <p>{{this}}</p>
          {{/each}}
        </div>
        {{/if}}
      </div>

      <div class="form-actions">
        <button class="prev-step btn-secondary">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button class="complete-levelup btn-success">
          <i class="fas fa-check"></i> Complete Level Up
        </button>
      </div>
    </section>
    {{/if}}

  </main>
</div>

<style>
.swse-levelup {
  font-family: "Roboto", Arial, sans-serif;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  color: #e4e4e4;
  border-radius: 8px;
}

.levelup-header {
  background: rgba(0, 0, 0, 0.3);
  padding: 1.5rem;
  border-bottom: 2px solid #0a74da;
  text-align: center;
}

.levelup-header h2 {
  margin: 0 0 0.5rem 0;
  color: #00d9ff;
}

.level-indicator {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  font-size: 1.1rem;
}

.level-indicator i {
  color: #00d9ff;
}

/* MENTOR PANEL STYLES */
.mentor-panel {
  background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(10, 116, 218, 0.1) 100%);
  border-left: 4px solid #00d9ff;
  border-right: 4px solid #0a74da;
  padding: 1.5rem;
  margin: 0;
}

.mentor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.mentor-info h4 {
  margin: 0;
  color: #00d9ff;
  font-size: 1.3rem;
  font-weight: bold;
}

.mentor-title {
  color: #aaa;
  font-size: 0.9rem;
  font-style: italic;
}

.mentor-portrait {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 3px solid #00d9ff;
  overflow: hidden;
}

.mentor-portrait img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.mentor-message {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.mentor-greeting {
  position: relative;
  padding: 1rem 1.5rem;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  border-left: 3px solid #00d9ff;
  font-style: italic;
  line-height: 1.6;
}

.mentor-greeting p {
  margin: 0;
  color: #fff;
  font-size: 1.05rem;
}

.mentor-greeting .fa-quote-left {
  position: absolute;
  top: 0.5rem;
  left: 0.5rem;
  color: rgba(0, 217, 255, 0.3);
  font-size: 1.5rem;
}

.mentor-greeting .fa-quote-right {
  position: absolute;
  bottom: 0.5rem;
  right: 0.5rem;
  color: rgba(0, 217, 255, 0.3);
  font-size: 1.5rem;
}

.mentor-guidance {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  background: rgba(255, 193, 7, 0.1);
  border-radius: 6px;
  border-left: 3px solid #ffc107;
}

.mentor-guidance i {
  color: #ffc107;
  font-size: 1.2rem;
}

.mentor-guidance p {
  margin: 0;
  color: #f0f0f0;
  font-size: 0.95rem;
}

.levelup-body {
  padding: 2rem;
  min-height: 400px;
}

.hint {
  text-align: center;
  color: #aaa;
  font-style: italic;
  margin-bottom: 1.5rem;
}

.current-classes {
  margin-bottom: 2rem;
  padding: 1rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 6px;
}

.class-badge {
  display: inline-block;
  padding: 0.5rem 1rem;
  background: linear-gradient(135deg, #0a74da 0%, #0056b3 100%);
  border-radius: 4px;
  margin: 0.25rem;
  font-weight: bold;
}

.class-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.class-card {
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid #0a74da;
  border-radius: 8px;
  transition: all 0.3s;
}

.class-card:hover {
  background: rgba(10, 116, 218, 0.2);
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(10, 116, 218, 0.3);
}

.class-card.prestige {
  border-color: #ffd700;
}

.class-card h5 {
  margin: 0 0 0.5rem 0;
  color: #00d9ff;
  font-size: 1.1rem;
}

.class-stats {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  margin-bottom: 1rem;
  font-size: 0.9rem;
}

.prestige-label {
  color: #ffd700;
  font-weight: bold;
}

.choice-button {
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid #0a74da;
  border-radius: 8px;
  color: #fff;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
}

.choice-button:hover {
  background: rgba(10, 116, 218, 0.2);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(10, 116, 218, 0.4);
}

.bonus-options {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
}

.bonus-option {
  flex: 1;
}

.bonus-option h4 {
  color: #00d9ff;
  margin-bottom: 1rem;
  text-align: center;
}

.bonus-option-divider {
  display: flex;
  align-items: center;
  padding-top: 3rem;
}

.bonus-option-divider span {
  padding: 0.5rem 1rem;
  background: rgba(0, 217, 255, 0.2);
  border: 2px solid #00d9ff;
  border-radius: 50%;
  font-weight: bold;
  color: #00d9ff;
}

.feat-selection, .skill-selection {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.ability-increase-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.ability-increase-card {
  padding: 1.5rem;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid #0a74da;
  border-radius: 8px;
  text-align: center;
  transition: all 0.3s;
}

.ability-increase-card:hover {
  background: rgba(10, 116, 218, 0.1);
  border-color: #00d9ff;
}

.ability-increase-card h4 {
  margin: 0 0 1rem 0;
  color: #00d9ff;
  font-size: 1.3rem;
  text-transform: uppercase;
}

.ability-current {
  display: flex;
  justify-content: space-between;
  margin-bottom: 1rem;
  padding: 0.5rem;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 4px;
  font-size: 0.9rem;
}

.ability-increase-btn {
  width: 100%;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
}

.ability-allocated {
  color: #00ff88;
  font-weight: bold;
  font-size: 1.1rem;
  margin-top: 0.5rem;
}

.ability-progress {
  text-align: center;
  padding: 1rem;
  background: rgba(0, 217, 255, 0.1);
  border: 2px solid #00d9ff;
  border-radius: 6px;
  margin-bottom: 1.5rem;
}

.ability-progress strong {
  color: #00d9ff;
  font-size: 1.2rem;
}

/* FEAT SEARCH AND FILTER CONTROLS */
.feat-controls {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  border: 1px solid #0a74da;
}

.feat-search-bar {
  position: relative;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.feat-search-bar i.fa-search {
  position: absolute;
  left: 12px;
  color: #00d9ff;
  font-size: 1rem;
  pointer-events: none;
}

.feat-search-input {
  width: 100%;
  padding: 0.75rem 2.5rem;
  background: rgba(0, 0, 0, 0.4);
  border: 2px solid #0a74da;
  border-radius: 6px;
  color: #fff;
  font-size: 1rem;
  transition: all 0.3s;
}

.feat-search-input:focus {
  outline: none;
  border-color: #00d9ff;
  box-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
}

.clear-search-btn {
  position: absolute;
  right: 8px;
  padding: 0.5rem;
  background: transparent;
  border: none;
  color: #888;
  cursor: pointer;
  transition: color 0.2s;
}

.clear-search-btn:hover {
  color: #00d9ff;
}

.feat-filter-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.filter-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #ccc;
  cursor: pointer;
}

.filter-label input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.clear-filters-btn {
  padding: 0.5rem 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid #0a74da;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.9rem;
}

.clear-filters-btn:hover {
  background: rgba(10, 116, 218, 0.2);
  border-color: #00d9ff;
}

/* ACTIVE TAG FILTERS */
.active-tag-filters {
  margin-bottom: 1rem;
  padding: 0.75rem 1rem;
  background: rgba(0, 217, 255, 0.1);
  border: 2px solid #00d9ff;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.filter-label-text {
  font-weight: bold;
  color: #00d9ff;
  font-size: 0.95rem;
}

.active-tags-container {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  flex: 1;
}

.active-tag-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.4rem 0.75rem;
  background: rgba(0, 217, 255, 0.3);
  border: 1px solid #00d9ff;
  border-radius: 20px;
  color: #fff;
  font-size: 0.85rem;
  font-weight: 600;
}

.active-tag-badge i {
  cursor: pointer;
  transition: color 0.2s;
}

.active-tag-badge i:hover {
  color: #ff5555;
}

/* FEAT CATEGORIES */
.feat-categories-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 2rem;
}

.feat-category {
  background: rgba(0, 0, 0, 0.2);
  border: 2px solid #0a74da;
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.3s;
}

.feat-category.expanded {
  border-color: #00d9ff;
  box-shadow: 0 4px 12px rgba(0, 217, 255, 0.2);
}

.category-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem 1.5rem;
  background: rgba(10, 116, 218, 0.15);
  cursor: pointer;
  transition: all 0.3s;
  user-select: none;
}

.category-header:hover {
  background: rgba(10, 116, 218, 0.25);
}

.category-icon {
  font-size: 2rem;
  min-width: 50px;
  text-align: center;
}

.category-info {
  flex: 1;
}

.category-info h4 {
  margin: 0 0 0.25rem 0;
  color: #00d9ff;
  font-size: 1.2rem;
}

.category-description {
  margin: 0;
  color: #aaa;
  font-size: 0.9rem;
  font-style: italic;
}

.category-count {
  min-width: 60px;
  text-align: center;
}

.count-badge {
  display: inline-block;
  padding: 0.4rem 0.8rem;
  background: rgba(0, 217, 255, 0.3);
  border: 1px solid #00d9ff;
  border-radius: 20px;
  color: #fff;
  font-weight: bold;
  font-size: 0.95rem;
}

.category-toggle-btn {
  padding: 0.5rem;
  background: transparent;
  border: none;
  color: #00d9ff;
  cursor: pointer;
  font-size: 1.2rem;
  transition: transform 0.3s;
}

.feat-category.expanded .category-toggle-btn i {
  transform: rotate(180deg);
}

.category-feats {
  padding: 1rem 1.5rem;
  background: rgba(0, 0, 0, 0.1);
}

.feat-selection-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 0;
  max-height: none;
  overflow-y: visible;
}

.feat-card {
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid #0a74da;
  border-radius: 8px;
  transition: all 0.3s;
  display: flex;
  flex-direction: column;
}

.feat-card:hover {
  background: rgba(10, 116, 218, 0.2);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(10, 116, 218, 0.3);
}

.feat-card.selected {
  border-color: #00d966;
  background: rgba(0, 217, 102, 0.1);
}

.feat-card.unavailable {
  opacity: 0.4;
  border-color: #555;
  background: rgba(100, 100, 100, 0.1);
  pointer-events: none;
}

.feat-card.unavailable:hover {
  transform: none;
  box-shadow: none;
}

.feat-card.owned {
  opacity: 0.7;
  border-color: #00d966;
  background: rgba(0, 217, 102, 0.05);
}

.feat-card.owned:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 217, 102, 0.2);
}

.feat-owned-badge {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  padding: 0.25rem 0.5rem;
  background: rgba(0, 217, 102, 0.2);
  border: 1px solid #00d966;
  border-radius: 4px;
  color: #00d966;
  font-size: 0.75rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.feat-owned-badge i {
  font-size: 0.85rem;
}

.feat-owned-badge.repeatable {
  background: rgba(255, 193, 7, 0.2);
  border-color: #ffc107;
  color: #ffc107;
}

.show-unavailable-toggle:checked ~ .feat-categories-container .feat-card.unavailable {
  opacity: 0.6;
  pointer-events: auto;
}

/* Feat chain indentation - hierarchical levels */
.feat-card.feat-indent-1 {
  margin-left: 2rem;
  border-left: 3px solid rgba(255, 193, 7, 0.3);
  position: relative;
}

.feat-card.feat-indent-1::before {
  content: "└─";
  position: absolute;
  left: -1.5rem;
  top: 1rem;
  color: rgba(255, 193, 7, 0.5);
  font-weight: bold;
}

.feat-card.feat-indent-2 {
  margin-left: 4rem;
  border-left: 3px solid rgba(255, 193, 7, 0.3);
  position: relative;
}

.feat-card.feat-indent-2::before {
  content: "└──";
  position: absolute;
  left: -2rem;
  top: 1rem;
  color: rgba(255, 193, 7, 0.5);
  font-weight: bold;
}

.feat-card.feat-indent-3 {
  margin-left: 6rem;
  border-left: 3px solid rgba(255, 193, 7, 0.3);
  position: relative;
}

.feat-card.feat-indent-3::before {
  content: "└───";
  position: absolute;
  left: -2.5rem;
  top: 1rem;
  color: rgba(255, 193, 7, 0.5);
  font-weight: bold;
}

.feat-card.feat-indent-4 {
  margin-left: 8rem;
  border-left: 3px solid rgba(255, 193, 7, 0.3);
  position: relative;
}

.feat-card.feat-indent-4::before {
  content: "└────";
  position: absolute;
  left: -3rem;
  top: 1rem;
  color: rgba(255, 193, 7, 0.5);
  font-weight: bold;
}

.feat-card h4 {
  margin: 0 0 0.5rem 0;
  color: #00d9ff;
  font-size: 1rem;
}

.feat-chain-badge {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  background: rgba(255, 193, 7, 0.2);
  border: 1px solid #ffc107;
  border-radius: 4px;
  color: #ffc107;
  font-size: 0.75rem;
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.feat-chain-badge i {
  margin-right: 0.25rem;
}

.feat-description {
  font-size: 0.9rem;
  color: #e0e0e0;
  margin-bottom: 0.75rem;
  line-height: 1.4;
  flex: 1;
}

/* Tooltip styles for feat descriptions */
.feat-with-tooltip {
  position: relative;
}

.feat-with-tooltip::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%) translateY(-8px);
  background: rgba(0, 0, 0, 0.95);
  color: #ffffff;
  padding: 12px 16px;
  border-radius: 6px;
  font-size: 0.9rem;
  line-height: 1.4;
  white-space: normal;
  max-width: 350px;
  width: max-content;
  border: 1px solid #00d9ff;
  box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
  z-index: 1000;
}

.feat-with-tooltip:hover::after {
  opacity: 1;
  visibility: visible;
  transform: translateX(-50%) translateY(-4px);
}

/* Tooltip arrow */
.feat-with-tooltip::before {
  content: '';
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%) translateY(2px);
  border: 6px solid transparent;
  border-top-color: #00d9ff;
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
  z-index: 1001;
}

.feat-with-tooltip:hover::before {
  opacity: 1;
  visibility: visible;
}

.feat-prereqs {
  font-size: 0.85rem;
  color: #ffc107;
  margin-bottom: 0.75rem;
  font-style: italic;
}

.feat-prereqs.prereqs-unmet {
  color: #ff5555;
}

.feat-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  margin-bottom: 0.75rem;
}

.feat-tag {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  background: rgba(0, 217, 255, 0.15);
  border: 1px solid rgba(0, 217, 255, 0.3);
  border-radius: 12px;
  color: #00d9ff;
  font-size: 0.7rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: lowercase;
}

.feat-tag:hover {
  background: rgba(0, 217, 255, 0.3);
  border-color: #00d9ff;
  transform: scale(1.05);
}

.feat-card .choice-button:disabled {
  background: rgba(100, 100, 100, 0.3);
  border-color: #555;
  color: #888;
  cursor: not-allowed;
  opacity: 0.6;
}

.selected-feats-display {
  padding: 1rem;
  background: rgba(0, 217, 102, 0.1);
  border-left: 4px solid #00d966;
  border-radius: 6px;
  margin-bottom: 1.5rem;
}

.selected-feats-display h4 {
  margin: 0 0 0.75rem 0;
  color: #00d966;
}

.selected-feat {
  padding: 0.5rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
  margin-bottom: 0.5rem;
}

.talent-selection-intro {
  margin-bottom: 2rem;
}

.talent-intro-card {
  text-align: center;
  padding: 2rem;
  background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(10, 116, 218, 0.1) 100%);
  border: 3px solid #00d9ff;
  border-radius: 12px;
  margin-bottom: 2rem;
}

.talent-intro-icon {
  font-size: 4rem;
  color: #00d9ff;
  margin-bottom: 1rem;
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.talent-intro-card h4 {
  color: #00d9ff;
  font-size: 1.6rem;
  margin: 0 0 1rem 0;
}

.talent-intro-card p {
  color: #aaa;
  margin: 0 0 1.5rem 0;
  font-size: 1rem;
}

.btn-primary-large {
  padding: 1rem 2rem;
  font-size: 1.2rem;
  font-weight: bold;
  background: linear-gradient(135deg, #0a74da 0%, #0056b3 100%);
  border: 2px solid #00d9ff;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(10, 116, 218, 0.3);
}

.btn-primary-large:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(0, 217, 255, 0.5);
  border-color: #00ffff;
}

.quick-tree-buttons {
  padding: 1.5rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  border: 1px dashed #0a74da;
}

.quick-select-label {
  text-align: center;
  color: #aaa;
  font-style: italic;
  margin: 0 0 1rem 0;
}

.talent-tree-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 1rem;
}

.selected-talent-display {
  padding: 1rem;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 6px;
  min-height: 80px;
  margin-bottom: 1.5rem;
}

.selected-talent-card {
  padding: 1.5rem;
  background: linear-gradient(135deg, rgba(0, 217, 102, 0.2) 0%, rgba(0, 168, 74, 0.2) 100%);
  border: 2px solid #00d966;
  border-radius: 8px;
  border-left-width: 5px;
}

.selected-talent-card i {
  color: #00d966;
  font-size: 1.5rem;
  margin-right: 0.5rem;
}

.selected-talent-card h4 {
  color: #00d966;
  margin: 0.5rem 0;
  font-size: 1.3rem;
}

.selected-talent-card p {
  margin: 0.5rem 0 0 0;
  color: #e4e4e4;
  line-height: 1.5;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.summary-section {
  padding: 1rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 6px;
  border-left: 4px solid #00d9ff;
}

.summary-section h4 {
  margin: 0 0 0.5rem 0;
  color: #00d9ff;
}

.form-actions {
  display: flex;
  justify-content: space-between;
  gap: 1rem;
  margin-top: 2rem;
}

.btn-primary, .btn-secondary, .btn-success {
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
  font-weight: bold;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-primary {
  background: linear-gradient(135deg, #0a74da 0%, #0056b3 100%);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(10, 116, 218, 0.4);
}

.btn-secondary {
  background: linear-gradient(135deg, #555 0%, #333 100%);
  color: white;
}

.btn-success {
  background: linear-gradient(135deg, #00d966 0%, #00a84a 100%);
  color: white;
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 217, 102, 0.4);
}

.btn-mentor {
  background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
  color: white;
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
  font-weight: bold;
  border: 2px solid #ffd54f;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-mentor:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 193, 7, 0.5);
  border-color: #ffeb3b;
}

.btn-warning {
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  color: white;
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
  font-weight: bold;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
}

/* Species Selection Styles */
.species-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.species-card {
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid #0a74da;
  border-radius: 8px;
  transition: all 0.3s;
  text-align: center;
}

.species-card:hover {
  background: rgba(10, 116, 218, 0.2);
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(10, 116, 218, 0.3);
}

.species-card h5 {
  margin: 0 0 0.5rem 0;
  color: #00d9ff;
  font-size: 1.1rem;
}

.species-bonuses {
  margin-bottom: 1rem;
  font-size: 0.9rem;
  color: #aaa;
}

.bonus-label {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  background: rgba(0, 217, 255, 0.1);
  border-radius: 4px;
  color: #00d9ff;
}

/* Abilities Mode Styles */
.ability-methods {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 2rem;
}

.method-button {
  padding: 0.75rem 1.5rem;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid #0a74da;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.95rem;
}

.method-button:hover {
  background: rgba(10, 116, 218, 0.2);
  transform: translateY(-2px);
}

.method-button.active {
  background: rgba(10, 116, 218, 0.3);
  border-color: #00d9ff;
  box-shadow: 0 0 10px rgba(0, 217, 255, 0.4);
}

.ability-mode {
  margin-bottom: 2rem;
}

.points-remaining {
  text-align: center;
  padding: 1rem;
  background: rgba(0, 217, 255, 0.1);
  border: 2px solid #00d9ff;
  border-radius: 6px;
  margin-bottom: 1.5rem;
  font-size: 1.1rem;
}

.points-remaining strong {
  color: #00d9ff;
  font-size: 1.3rem;
}

.abilities-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
}

.ability-card {
  padding: 1rem;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid #0a74da;
  border-radius: 8px;
  text-align: center;
}

.ability-card label {
  display: block;
  color: #00d9ff;
  font-size: 1.1rem;
  font-weight: bold;
  margin-bottom: 0.75rem;
  text-transform: uppercase;
}

.ability-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.ability-btn {
  width: 32px;
  height: 32px;
  background: rgba(10, 116, 218, 0.3);
  border: 2px solid #0a74da;
  border-radius: 4px;
  color: #fff;
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s;
}

.ability-btn:hover {
  background: rgba(10, 116, 218, 0.5);
  border-color: #00d9ff;
}

.ability-input {
  width: 60px;
  padding: 0.5rem;
  text-align: center;
  background: rgba(0, 0, 0, 0.3);
  border: 2px solid #0a74da;
  border-radius: 4px;
  color: #fff;
  font-size: 1.1rem;
  font-weight: bold;
}

.ability-display {
  color: #aaa;
  font-size: 0.85rem;
  margin-top: 0.5rem;
}

.roll-results {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1rem;
}

.assign-roll {
  padding: 1rem 1.5rem;
  background: rgba(0, 217, 102, 0.2);
  border: 2px solid #00d966;
  border-radius: 6px;
  color: #fff;
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.assign-roll:hover {
  background: rgba(0, 217, 102, 0.3);
  transform: scale(1.1);
}

.organic-groups {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.organic-group {
  padding: 1rem;
  background: rgba(255, 170, 0, 0.2);
  border: 2px solid #ffa500;
  border-radius: 6px;
  color: #fff;
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
}

.organic-group:hover {
  background: rgba(255, 170, 0, 0.3);
  transform: translateX(5px);
}

.organic-group.selected-group {
  background: rgba(0, 217, 255, 0.3);
  border-color: #00d9ff;
  box-shadow: 0 0 15px rgba(0, 217, 255, 0.5);
}

/* Enhanced Class Selection Styles (matching chargen) */
.step-class-selection .creator-header,
.step-prestige-selection .creator-header {
  text-align: center;
  padding: 1.5rem 2rem;
  background: linear-gradient(180deg, rgba(0, 0, 0, 0.3) 0%, transparent 100%);
  margin-bottom: 1.5rem;
}

.step-class-selection .creator-header h1,
.step-prestige-selection .creator-header h1 {
  margin: 0 0 0.5rem 0;
  font-size: 2rem;
  color: #4a90e2;
  text-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
}

.step-class-selection .creator-header .subtitle,
.step-prestige-selection .creator-header .subtitle {
  margin: 0;
  font-size: 1rem;
  color: #aaa;
  font-style: italic;
}

.class-selection-container {
  margin-top: 1.5rem;
}

.class-category-title {
  text-align: center;
  color: #00d9ff;
  font-size: 1.3rem;
  margin: 1.5rem 0 1rem 0;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid rgba(0, 217, 255, 0.3);
}

.class-grid-enhanced {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.class-choice-btn {
  position: relative;
  background: linear-gradient(135deg, rgba(30, 30, 40, 0.9), rgba(20, 20, 30, 0.9));
  border: 3px solid #444;
  border-radius: 12px;
  padding: 2rem;
  cursor: pointer;
  transition: all 0.4s ease;
  overflow: hidden;
}

.class-choice-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #4a90e2, #357abd);
  transform: scaleX(0);
  transition: transform 0.4s ease;
}

.class-choice-btn:hover {
  border-color: #4a90e2;
  transform: translateY(-8px);
  box-shadow: 0 10px 30px rgba(74, 144, 226, 0.4);
}

.class-choice-btn:hover::before {
  transform: scaleX(1);
}

.class-choice-btn.prestige-class {
  border-color: #ffd700;
}

.class-choice-btn.prestige-class:hover {
  border-color: #ffd700;
  box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
}

.class-choice-btn.prestige-class::before {
  background: linear-gradient(90deg, #ffd700, #ffaa00);
}

.class-icon {
  font-size: 4rem;
  color: #4a90e2;
  margin-bottom: 1rem;
  text-align: center;
  transition: all 0.3s ease;
}

.class-icon.prestige-icon {
  color: #ffd700;
}

.class-choice-btn:hover .class-icon {
  transform: scale(1.1);
  text-shadow: 0 0 20px rgba(74, 144, 226, 0.8);
}

.class-choice-btn.prestige-class:hover .class-icon {
  text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
}

.class-choice-btn h3 {
  margin: 0 0 0.75rem 0;
  font-size: 1.8rem;
  color: #4a90e2;
  text-align: center;
  font-weight: bold;
}

.class-choice-btn.prestige-class h3 {
  color: #ffd700;
}

.class-choice-btn .class-desc {
  margin: 0 0 1rem 0;
  color: #aaa;
  text-align: center;
  line-height: 1.5;
  font-size: 0.95rem;
  min-height: 2.85rem;
}

.class-choice-btn .class-stats {
  display: flex;
  justify-content: space-around;
  gap: 1rem;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(74, 144, 226, 0.3);
  font-size: 0.85rem;
  color: #ccc;
}

.class-choice-btn.prestige-class .class-stats {
  border-top-color: rgba(255, 215, 0, 0.3);
}

.select-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #4a90e2, #357abd);
  padding: 1rem;
  text-align: center;
  color: white;
  font-weight: bold;
  transform: translateY(100%);
  transition: transform 0.3s ease;
}

.select-overlay.prestige-overlay {
  background: linear-gradient(135deg, #ffd700, #ffaa00);
}

.class-choice-btn:hover .select-overlay {
  transform: translateY(0);
}

/* Prestige Classes Button */
.prestige-section {
  text-align: center;
  margin: 2rem 0;
}

.btn-prestige {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 1.5rem 3rem;
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 170, 0, 0.2));
  border: 3px solid #ffd700;
  border-radius: 12px;
  color: #ffd700;
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
}

.btn-prestige:hover {
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 170, 0, 0.3));
  transform: translateY(-4px);
  box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
}

.btn-prestige i {
  font-size: 2.5rem;
}

.prestige-hint {
  font-size: 0.85rem;
  color: #ccc;
  font-style: italic;
  font-weight: normal;
}
</style>
