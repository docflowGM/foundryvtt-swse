<div class="gm-store-dashboard-container" title="This dashboard allows the GM to review store transactions, resolve pending sales, and control store availability and pricing. No purchases or sales are initiated from this screen.">
  <div class="dashboard-header">
    <h2>GM STORE CONTROL</h2>
    <p class="subtitle">Commerce oversight, transaction review, and store governance</p>
  </div>

  {{!-- Tab Navigation --}}
  <nav class="dashboard-tabs">
    <button class="tab-button" data-tab="transactions" title="Review all completed buy and sell transactions. Transactions may be reversed here if a correction is required.">Transactions</button>
    <button class="tab-button" data-tab="pending" title="View and resolve sell offers that have not yet been accepted or denied.">Pending Sales</button>
    <button class="tab-button" data-tab="controls" title="Configure store availability, pricing modifiers, item visibility, and selling house rules.">Store Controls</button>
  </nav>

  {{!-- Tab Content --}}
  <div class="dashboard-content">

    {{!-- TAB 1: TRANSACTIONS LEDGER --}}
    <div class="dashboard-tab" data-tab="transactions">
      <h3>TRANSACTION LEDGER</h3>
      <p class="tab-description" title="A chronological record of all finalized store transactions. This ledger exists for auditing and correction, not for initiating trades.">A chronological record of all finalized store transactions. Use this to audit purchases, identify mistakes, or reverse transactions if necessary.</p>

      {{!-- Filters --}}
      <div class="filters-row">
        <select class="filter-select" id="actor-filter" title="Filter transactions by the character involved in the trade.">
          <option value="">All Players</option>
          {{#each actors}}
            <option value="{{this.id}}">{{this.name}}</option>
          {{/each}}
        </select>

        <div class="checkbox-group">
          <label title="Show transactions where an item was purchased from the store."><input type="checkbox" checked data-type="Buy"> Buy</label>
          <label title="Show transactions where an item was sold to the store."><input type="checkbox" checked data-type="Sell"> Sell</label>
        </div>

        <select class="filter-select" id="time-filter" title="Limit the transaction list to a specific time window. Useful for reviewing recent activity or the current session.">
          <option value="">All Time</option>
          <option value="hour">Last Hour</option>
          <option value="day">Today</option>
          <option value="week">This Week</option>
        </select>
      </div>

      {{!-- Transactions Table --}}
      <table class="transactions-table">
        <thead>
          <tr>
            <th data-sort="timestamp" title="The time at which the transaction was finalized.">Time</th>
            <th data-sort="actor" title="The character involved in the transaction.">Actor</th>
            <th data-sort="type" title="Whether the transaction was a purchase or a sale.">Type</th>
            <th data-sort="item" title="The item that was exchanged.">Item</th>
            <th data-sort="amount" title="Credits transferred. Negative values indicate spending; positive values indicate income.">Amount</th>
            <th data-sort="source" title="How the transaction was resolved (store purchase, automatic selling, or GM override).">Source</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {{#each transactions}}
            <tr data-index="{{@index}}">
              <td>{{#formatDate this.timestamp}}{{/formatDate}}</td>
              <td>{{this.actor}}</td>
              <td><span class="type-badge {{lowercase this.type}}">{{this.type}}</span></td>
              <td>{{this.item}}</td>
              <td class="amount {{#if (gt this.amount 0)}}positive{{else}}negative{{/if}}">
                {{#if (gt this.amount 0)}}+{{/if}}{{this.amount}}
              </td>
              <td><span class="source-badge">{{this.source}}</span></td>
              <td>
                <button class="action-btn" data-action="reverse-transaction" data-index="{{@index}}"
                        title="Reverse this transaction. Purchases will remove the item and restore credits. Sales will re-add the item and remove credits. Use only to correct mistakes.">
                  Reverse
                </button>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>

      {{#if (eq transactions.length 0)}}
        <p class="empty-state">No transactions yet.</p>
      {{/if}}
    </div>

    {{!-- TAB 2: PENDING SALES --}}
    <div class="dashboard-tab" data-tab="pending">
      <h3>PENDING SELL ATTEMPTS</h3>
      <p class="tab-description" title="Sell offers awaiting GM resolution. Offers appear here if they were not automatically accepted or if the original prompt was dismissed.">Sell offers awaiting GM resolution. These appear if a sell request was not immediately resolved or was dismissed earlier.</p>

      {{!-- Pending Sales Table --}}
      <table class="pending-table">
        <thead>
          <tr>
            <th title="When the sell offer was submitted by the player.">Time</th>
            <th title="The character offering the item for sale.">Actor</th>
            <th title="The item the player is attempting to sell.">Item</th>
            <th title="The proposed credit value. Items without a base price cannot be automatically valued.">Requested Value</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {{#each pendingSales}}
            <tr data-index="{{@index}}">
              <td>{{#formatDate this.timestamp}}{{/formatDate}}</td>
              <td>{{this.actor}}</td>
              <td>{{this.item}}</td>
              <td>
                {{#if this.value}}
                  {{this.value}} cr
                {{else}}
                  <span class="no-price">No base price</span>
                {{/if}}
              </td>
              <td>
                <button class="action-btn" data-action="accept-pending" data-index="{{@index}}"
                        title="Accept this sale at the listed value. The item will be removed from the actor and credits will be transferred.">
                  Accept
                </button>
                <button class="action-btn secondary" data-action="deny-pending" data-index="{{@index}}"
                        title="Deny this sale. No inventory or credit changes will occur.">
                  Deny
                </button>
                <button class="action-btn" data-action="set-amount-pending" data-index="{{@index}}"
                        title="Manually specify a different credit value for this sale. This overrides the standard valuation.">
                  Set Amount
                </button>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>

      {{#if (eq pendingSales.length 0)}}
        <p class="empty-state">No pending sales.</p>
      {{/if}}
    </div>

    {{!-- TAB 3: STORE CONTROLS --}}
    <div class="dashboard-tab" data-tab="controls">
      <h3>STORE CONTROLS</h3>

      {{!-- Store Availability --}}
      <div class="control-section">
        <h4>STORE AVAILABILITY</h4>
        <label class="toggle-label">
          <input type="checkbox" name="storeOpen" {{#if storeOpen}}checked{{/if}}>
          <span class="toggle-text">Store Open</span>
          <span class="tooltip-icon" title="When disabled, players may view store items but cannot purchase them. Selling and GM controls are unaffected.">?</span>
        </label>
        {{#unless storeOpen}}
          <p class="warning-text">Store is currently closed to purchases.</p>
        {{/unless}}
      </div>

      {{!-- Pricing Controls --}}
      <div class="control-section">
        <h4>PRICING MODIFIERS</h4>
        <label>Global Buy Price Modifier (%)
          <span class="tooltip-icon" title="Applies a global price modifier to all store purchases. Positive values increase prices; negative values reduce them. Selling prices are never affected.">?</span>
        </label>
        <div class="slider-container">
          <input type="range" name="buyModifier" min="-50" max="200" step="5" value="{{buyModifier}}" class="slider">
          <span class="slider-value">{{buyModifier}}%</span>
        </div>
        <p class="helper-text">Example: +25% represents scarcity or wartime inflation.</p>
      </div>

      {{!-- Item Visibility --}}
      <div class="control-section">
        <h4>ITEM VISIBILITY</h4>

        <div class="visibility-subsection">
          <h5>By Rarity</h5>
          <label><input type="checkbox" name="rarity-common" {{#if visibleRarities.common}}checked{{/if}}> Common</label>
          <label><input type="checkbox" name="rarity-uncommon" {{#if visibleRarities.uncommon}}checked{{/if}}> Uncommon</label>
          <label><input type="checkbox" name="rarity-rare" {{#if visibleRarities.rare}}checked{{/if}}> Rare</label>
          <label><input type="checkbox" name="rarity-restricted" {{#if visibleRarities.restricted}}checked{{/if}}> Restricted</label>
          <label><input type="checkbox" name="rarity-illegal" {{#if visibleRarities.illegal}}checked{{/if}}> Illegal</label>
          <p class="tooltip-text">Items with unchecked rarities will not appear in the store.</p>
        </div>

        <div class="visibility-subsection">
          <h5>By Item Type</h5>
          <label><input type="checkbox" name="type-weapons" {{#if visibleTypes.weapons}}checked{{/if}}> Weapons</label>
          <label><input type="checkbox" name="type-armor" {{#if visibleTypes.armor}}checked{{/if}}> Armor</label>
          <label><input type="checkbox" name="type-gear" {{#if visibleTypes.gear}}checked{{/if}}> Gear</label>
          <label><input type="checkbox" name="type-droids" {{#if visibleTypes.droids}}checked{{/if}}> Droids</label>
          <label><input type="checkbox" name="type-vehicles" {{#if visibleTypes.vehicles}}checked{{/if}}> Vehicles</label>
          <p class="tooltip-text">Entire item categories can be hidden from the store.</p>
        </div>
      </div>

      {{!-- Selling Rules --}}
      <div class="control-section">
        <h4>SELLING RULES (HOUSE RULES)</h4>

        <label class="toggle-label">
          <input type="checkbox" name="autoAcceptSelling" {{#if autoAcceptSelling}}checked{{/if}}>
          <span class="toggle-text">Automatically accept item sales</span>
          <span class="tooltip-icon" title="When enabled, sell offers are automatically accepted without GM approval.">?</span>
        </label>

        <label>Automatic Sale Value (%)
          <span class="tooltip-icon" title="Sets the percentage of an item's base price paid when automatic selling is enabled. Saga RAW default is 50%.">?</span>
        </label>
        <div class="slider-container {{#unless autoAcceptSelling}}disabled{{/unless}}">
          <input type="range" name="autoSalePercent" min="10" max="100" step="5" value="{{autoSalePercent}}" class="slider" {{#unless autoAcceptSelling}}disabled{{/unless}}>
          <span class="slider-value">{{autoSalePercent}}%</span>
        </div>

        <label class="toggle-label">
          <input type="checkbox" name="disallowAutoSellNoPrice" {{#if disallowAutoSellNoPrice}}checked{{/if}}>
          <span class="toggle-text">Disallow auto-selling items with no base price</span>
          <span class="tooltip-icon" title="Items without a defined base price will always require GM approval.">?</span>
        </label>
      </div>

      {{!-- Footer --}}
      <div class="control-footer">
        <p class="credit-contract">All credit values are integers. Percentage calculations are rounded down.</p>
      </div>
    </div>

  </div>
</div>
