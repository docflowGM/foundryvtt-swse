<div class="mentor-chat-dialog swse kotor-style">

  {{#if selectedMentor}}
    <!-- MENTOR SELECTED - SHOW CHAT INTERFACE -->
    <div class="chat-view">

      <!-- Back to Mentors Button -->
      <button class="back-to-mentors" type="button">
        <i class="{{getIconClass 'arrowLeft'}}"></i> Back to Mentors
      </button>

      <!-- Mentor Conversation Box (KOTOR-style) -->
      <div class="kotor-conversation-box">

        <!-- Mentor Portrait (central, larger) -->
        <div class="kotor-portrait-area">
          {{#if selectedMentor.mentor.portrait}}
            <img src="{{selectedMentor.mentor.portrait}}" alt="{{selectedMentor.mentor.name}}" class="kotor-mentor-portrait" />
          {{/if}}
        </div>

        <!-- Mentor Name/Title below portrait -->
        <div class="kotor-mentor-nameplate">
          <h2>{{selectedMentor.mentor.name}}</h2>
          <p class="mentor-title">{{selectedMentor.mentor.title}}</p>
        </div>

        {{#if currentTopic}}
          <!-- TOPIC SELECTED - SHOW RESPONSE -->
          <div class="kotor-response-section">

            <!-- Mentor Dialogue Box -->
            <div class="kotor-dialogue-box">
              {{#if currentResponse.introduction}}
                <div class="dialogue-line">
                  {{{currentResponse.introduction}}}
                </div>
              {{/if}}

              {{#if currentResponse.advice}}
                <div class="dialogue-line advice-line">
                  {{{currentResponse.advice}}}
                </div>
              {{/if}}

              {{#if currentResponse.suggestions}}
                <div class="dialogue-suggestions">
                  <p class="suggestions-header">Top Recommendations:</p>
                  <ul>
                    {{#each currentResponse.suggestions}}
                      <li><span class="suggestion-name">{{this.name}}</span> — {{this.reason}}</li>
                    {{/each}}
                  </ul>
                </div>
              {{/if}}
            </div>

            <!-- System Analysis Panel (Reasoning) -->
            {{#if currentResponse.reasonTexts}}
              {{#if currentResponse.reasonTexts.length}}
                <div class="system-analysis-panel">
                  <p class="analysis-label">System Analysis</p>
                  <ul class="reason-list">
                    {{#each currentResponse.reasonTexts}}
                      <li class="reason-item">{{this.text}}</li>
                    {{/each}}
                  </ul>
                </div>
              {{/if}}
            {{/if}}

            <!-- Response Options -->
            <div class="kotor-response-options">
              <button class="back-to-topics response-option" type="button">
                <i class="{{getIconClass 'arrowLeft'}}"></i> Back to Topics
              </button>
            </div>

          </div>

        {{else}}
          <!-- NO TOPIC SELECTED - SHOW TOPIC LIST -->
          <div class="kotor-topics-section">

            <!-- Mentor Greeting -->
            <div class="kotor-dialogue-box">
              {{#if currentResponse.introduction}}
                <p class="dialogue-line">{{{currentResponse.introduction}}}</p>
              {{else}}
                <p class="dialogue-line">What can I help you with?</p>
              {{/if}}
            </div>

            <!-- Topic Selection (conversation options) -->
            <div class="kotor-response-options topics-options">
              <p class="options-label">What would you like to discuss?</p>
              {{#each topics}}
                <button class="topic-button response-option" data-topic="{{this.key}}" type="button">
                  <i class="fas {{this.icon}}"></i>
                  {{this.title}}
                </button>
              {{/each}}
            </div>

          </div>
        {{/if}}

      </div>

    </div>

  {{else}}
    <!-- NO MENTOR SELECTED - SHOW MENTOR LIST -->
    <div class="mentor-selection">

      {{#if hasMentors}}
        <!-- Intro Text -->
        <div class="selection-intro">
          <p>Select a mentor to seek their guidance. These mentors have been unlocked through your class training:</p>
        </div>

        <!-- Mentor Grid -->
        <div class="mentors-grid">
          {{#each unlockedMentors}}
            <div class="mentor-card" data-mentor="{{this.key}}">
              {{#if this.mentor.portrait}}
                <img src="{{this.mentor.portrait}}" alt="{{this.mentor.name}}" class="mentor-card-portrait" />
              {{/if}}
              <div class="mentor-card-info">
                <h4>{{this.mentor.name}}</h4>
                <p class="mentor-card-title">{{this.mentor.title}}</p>
                <p class="mentor-card-unlocked">Unlocked via: <em>{{this.unlockedBy}}</em></p>
              </div>
            </div>
          {{/each}}
        </div>

      {{else}}
        <!-- No Mentors Available -->
        <div class="no-mentors">
          <i class="{{getIconClass 'user'}}-slash" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
          <p>You haven't unlocked any mentors yet.</p>
          <p>Take a class to gain access to mentor guidance!</p>
        </div>
      {{/if}}

    </div>
  {{/if}}

</div>

<style>
  .mentor-chat-dialog {
    padding: 15px;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* Mentor Selection View */
  .mentor-selection {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .selection-intro {
    margin-bottom: 15px;
    padding: 12px;
    background: rgba(0, 217, 255, 0.1);
    border-left: 3px solid #00d9ff;
    border-radius: 4px;
  }

  .selection-intro p {
    margin: 0;
    color: #ddd;
  }

  .mentors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    overflow-y: auto;
    flex: 1;
  }

  .mentor-card {
    display: flex;
    flex-direction: column;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(0, 217, 255, 0.3);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .mentor-card:hover {
    background: rgba(0, 217, 255, 0.15);
    border-color: rgba(0, 217, 255, 0.7);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 217, 255, 0.3);
  }

  .mentor-card-portrait {
    width: 100%;
    aspect-ratio: 1/1;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 10px;
  }

  .mentor-card-info h4 {
    margin: 0 0 4px 0;
    color: #00d9ff;
    font-size: 1em;
  }

  .mentor-card-title {
    margin: 0 0 8px 0;
    color: #999;
    font-size: 0.85em;
    line-height: 1.3;
  }

  .mentor-card-unlocked {
    margin: 0;
    padding-top: 8px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    color: #aaa;
    font-size: 0.8em;
  }

  .mentor-card-unlocked em {
    color: #00d9ff;
  }

  .no-mentors {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    color: #999;
  }

  /* Chat View */
  .chat-view {
    display: flex;
    flex-direction: column;
    gap: 15px;
    height: 100%;
  }

  .back-to-mentors,
  .back-to-topics {
    align-self: flex-start;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 3px;
    color: #fff;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s ease;
  }

  .back-to-mentors:hover,
  .back-to-topics:hover {
    background: rgba(255, 255, 255, 0.15);
  }

  .mentor-header {
    display: flex;
    gap: 15px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    border-left: 3px solid #00d9ff;
  }

  .mentor-portrait {
    width: 60px;
    height: 60px;
    border-radius: 4px;
    object-fit: cover;
  }

  .mentor-info h2 {
    margin: 0;
    color: #00d9ff;
    font-size: 1.2em;
  }

  .mentor-title {
    margin: 3px 0 0 0;
    color: #999;
    font-size: 0.9em;
  }

  /* Topics List */
  .topics-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    flex: 1;
    overflow-y: auto;
  }

  .mentor-greeting {
    padding: 12px;
    background: rgba(0, 217, 255, 0.1);
    border-left: 3px solid #00d9ff;
    border-radius: 4px;
  }

  .mentor-greeting p {
    margin: 0;
    color: #ddd;
    font-style: italic;
    font-size: 0.95em;
  }

  .topics-grid h3 {
    margin: 10px 0;
    color: #00d9ff;
    font-size: 1em;
  }

  .topic-button {
    display: flex;
    gap: 15px;
    padding: 12px;
    background: rgba(0, 217, 255, 0.1);
    border: 1px solid rgba(0, 217, 255, 0.3);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
  }

  .topic-button:hover {
    background: rgba(0, 217, 255, 0.2);
    border-color: rgba(0, 217, 255, 0.6);
    transform: translateX(5px);
  }

  .topic-icon {
    font-size: 24px;
    color: #00d9ff;
    display: flex;
    align-items: center;
    min-width: 30px;
  }

  .topic-text h4 {
    margin: 0;
    color: #fff;
    font-size: 0.9em;
  }

  .topic-text p {
    margin: 3px 0 0 0;
    color: #999;
    font-size: 0.85em;
  }

  /* Topic Response */
  .topic-response {
    display: flex;
    flex-direction: column;
    gap: 15px;
    flex: 1;
    overflow-y: auto;
  }

  .topic-display {
    padding: 12px;
    background: rgba(0, 217, 255, 0.05);
    border-radius: 4px;
    border-left: 2px solid #00d9ff;
  }

  .topic-display h3 {
    margin: 0;
    color: #00d9ff;
    font-size: 1.1em;
  }

  .topic-desc {
    margin: 5px 0 0 0;
    color: #aaa;
    font-size: 0.9em;
  }

  .mentor-response {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 15px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
  }

  .response-intro {
    padding: 12px;
    background: rgba(100, 200, 255, 0.1);
    border-left: 3px solid rgba(100, 200, 255, 0.6);
    border-radius: 4px;
  }

  .response-intro p {
    margin: 0;
    color: #ddd;
    font-style: italic;
    font-size: 0.95em;
  }

  .response-advice {
    padding: 12px;
    background: rgba(150, 200, 100, 0.1);
    border-left: 3px solid rgba(150, 200, 100, 0.6);
    border-radius: 4px;
  }

  .response-advice p {
    margin: 0;
    color: #ddd;
    line-height: 1.6;
    white-space: pre-line;
  }

  .response-suggestions {
    padding: 12px;
    background: rgba(200, 150, 100, 0.1);
    border-left: 3px solid rgba(200, 150, 100, 0.6);
    border-radius: 4px;
  }

  .response-suggestions h4 {
    margin: 0 0 10px 0;
    color: #00d9ff;
    font-size: 0.95em;
  }

  .response-suggestions ul {
    margin: 0;
    padding-left: 20px;
  }

  .response-suggestions li {
    color: #ddd;
    margin-bottom: 6px;
    line-height: 1.5;
  }

  .response-suggestions strong {
    color: #00d9ff;
  }

  /* KOTOR-Style Conversation UI */
  .mentor-chat-dialog.kotor-style .chat-view {
    display: flex;
    flex-direction: column;
    gap: 12px;
    height: 100%;
  }

  .kotor-conversation-box {
    display: flex;
    flex-direction: column;
    flex: 1;
    background: linear-gradient(135deg, rgba(10, 20, 40, 0.6) 0%, rgba(15, 35, 60, 0.6) 100%);
    border: 2px solid #0af;
    border-radius: 6px;
    box-shadow: 0 0 20px rgba(0, 170, 255, 0.3), inset 0 0 15px rgba(0, 170, 255, 0.1);
    overflow: hidden;
    padding: 15px;
  }

  .kotor-portrait-area {
    display: flex;
    justify-content: center;
    align-items: center;
    flex: 0 1 auto;
    margin-bottom: 12px;
  }

  .kotor-mentor-portrait {
    width: 180px;
    height: 220px;
    object-fit: cover;
    border: 2px solid #0af;
    border-radius: 4px;
    box-shadow: 0 0 20px rgba(0, 170, 255, 0.5);
  }

  .kotor-mentor-nameplate {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    margin-bottom: 15px;
    text-align: center;
  }

  .kotor-mentor-nameplate h2 {
    margin: 0;
    color: #0af;
    font-size: 1.3em;
    text-shadow: 0 0 10px rgba(0, 170, 255, 0.6);
  }

  .kotor-mentor-nameplate .mentor-title {
    margin: 0;
    color: #88ccff;
    font-size: 0.9em;
    font-style: italic;
  }

  .kotor-dialogue-box {
    flex: 1;
    padding: 15px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(0, 170, 255, 0.4);
    border-radius: 4px;
    margin-bottom: 12px;
    overflow-y: auto;
    color: #e0f4ff;
    line-height: 1.6;
    font-size: 0.95em;
  }

  .dialogue-line {
    margin-bottom: 10px;
    color: #c0e0ff;
  }

  .dialogue-line:last-child {
    margin-bottom: 0;
  }

  .advice-line {
    color: #96ff96;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(0, 170, 255, 0.2);
  }

  .dialogue-suggestions {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(0, 170, 255, 0.3);
  }

  .suggestions-header {
    margin: 0 0 8px 0;
    color: #0af;
    font-weight: bold;
    font-size: 0.9em;
    text-shadow: 0 0 5px rgba(0, 170, 255, 0.3);
  }

  .dialogue-suggestions ul {
    margin: 0;
    padding-left: 18px;
  }

  .dialogue-suggestions li {
    margin-bottom: 6px;
    color: #dde0ff;
    font-size: 0.9em;
  }

  .suggestion-name {
    color: #88ff00;
    font-weight: bold;
  }

  .kotor-response-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 280px;
    overflow-y: auto;
  }

  .kotor-response-section .kotor-response-options {
    justify-content: flex-end;
  }

  .response-option {
    padding: 12px 15px;
    background: rgba(0, 170, 255, 0.12);
    border: 1px solid rgba(0, 170, 255, 0.4);
    border-radius: 3px;
    color: #e0f4ff;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    font-size: 0.95em;
    font-weight: 500;
  }

  .response-option:hover {
    background: rgba(0, 170, 255, 0.25);
    border-color: rgba(0, 170, 255, 0.7);
    box-shadow: 0 0 12px rgba(0, 170, 255, 0.3);
    transform: translateX(3px);
  }

  .response-option i {
    margin-right: 8px;
    color: #0af;
  }

  .topics-options {
    align-items: flex-start;
  }

  .options-label {
    margin: 0 0 8px 0;
    color: #88ccff;
    font-size: 0.9em;
    font-style: italic;
  }

  .topic-button.response-option {
    background: rgba(0, 170, 255, 0.12);
  }

  .topic-button.response-option:hover {
    background: rgba(0, 170, 255, 0.25);
  }

  .kotor-topics-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex: 1;
    overflow-y: auto;
  }

  .kotor-topics-section .kotor-dialogue-box {
    min-height: 60px;
  }

  .kotor-response-section {
    display: flex;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
  }

  .kotor-response-section .kotor-dialogue-box {
    flex: 1;
    margin-bottom: 12px;
  }

  .back-to-mentors {
    padding: 10px 14px;
    background: rgba(0, 170, 255, 0.1);
    border: 1px solid rgba(0, 170, 255, 0.3);
    border-radius: 3px;
    color: #0af;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s ease;
    align-self: flex-start;
  }

  .back-to-mentors:hover {
    background: rgba(0, 170, 255, 0.2);
    border-color: rgba(0, 170, 255, 0.6);
  }

  /* System Analysis Panel */
  .system-analysis-panel {
    padding: 12px;
    background: rgba(200, 200, 200, 0.08);
    border: 1px solid rgba(200, 200, 200, 0.3);
    border-radius: 4px;
    margin-top: 8px;
  }

  .analysis-label {
    margin: 0 0 8px 0;
    color: #aaa;
    font-size: 0.85em;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .reason-list {
    margin: 0;
    padding-left: 18px;
    list-style: none;
  }

  .reason-item {
    margin-bottom: 6px;
    color: #bbb;
    font-size: 0.9em;
    line-height: 1.5;
  }

  .reason-item:before {
    content: "• ";
    color: #999;
    margin-right: 6px;
  }

  .reason-item:last-child {
    margin-bottom: 0;
  }
</style>
