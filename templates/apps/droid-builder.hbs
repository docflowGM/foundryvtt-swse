<div class="droid-builder-container">
  {{!-- Seraphim Narrator Section --}}
  {{#if this.seraphim}}
    <div class="seraphim-section">
      <div class="seraphim-header">
        <span class="seraphim-label">Seraphim</span>
      </div>

      {{#if this.seraphim.intro}}
        <div class="seraphim-intro">
          {{this.seraphim.intro}}
        </div>
      {{/if}}

      {{#if this.seraphim.reaction}}
        <div class="seraphim-reaction">
          {{this.seraphim.reaction}}
        </div>
      {{/if}}

      {{#if this.seraphim.warnings.length}}
        <div class="seraphim-warnings">
          {{#each this.seraphim.warnings}}
            <div class="warning-item">• {{this}}</div>
          {{/each}}
        </div>
      {{/if}}

      {{#if this.seraphim.budget}}
        <div class="seraphim-budget">
          {{this.seraphim.budget}}
        </div>
      {{/if}}

      {{#if this.seraphim.review}}
        <div class="seraphim-review">
          {{this.seraphim.review}}
        </div>
      {{/if}}
    </div>
  {{/if}}

  {{#if this.validationErrors.length}}
    <div class="alert alert-error">
      <strong>Validation Errors:</strong>
      <ul>
        {{#each this.validationErrors}}
          <li>{{this}}</li>
        {{/each}}
      </ul>
    </div>
  {{/if}}

  {{#if (eq this.currentStep 'intro')}}
    <div class="builder-step intro-step">
      <h2>Welcome to Droid Builder</h2>
      <p>Let's create your droid. First, select a degree of sentience.</p>

      <div class="degree-selection">
        {{#each this.degrees}}
          <button class="select-degree {{#if (eq ../this.droidSystems.degree this.id)}}selected{{/if}}" data-degree="{{this.id}}">
            {{this.label}}
          </button>
        {{/each}}
      </div>

      {{#if this.droidSystems.degree}}
        <button class="next-step btn btn-primary">
          Continue to Size Selection →
        </button>
      {{/if}}
    </div>
  {{/if}}

  {{#if (eq this.currentStep 'size')}}
    <div class="builder-step size-step">
      <h2>Select Droid Size</h2>
      <p><strong>Degree:</strong> {{this.droidSystems.degree}}</p>
      <p>Choose your droid's physical size.</p>

      <div class="size-selection">
        {{#each this.sizes}}
          <button class="select-size {{#if (eq ../this.droidSystems.size this.id)}}selected{{/if}}" data-size="{{this.id}}">
            {{this.label}}
          </button>
        {{/each}}
      </div>

      {{#if this.droidSystems.size}}
        <button class="next-step btn btn-primary">
          Continue to Review →
        </button>
      {{/if}}
    </div>
  {{/if}}

  {{!-- Phase 2: Locomotion Selection --}}
  {{#if (eq this.currentStep 'locomotion')}}
    <div class="builder-step phase2-step">
      <h2>{{this.stepConfig.label}} (Step {{this.stepNumber}}/{{this.totalSteps}})</h2>

      <div class="step-info">
        <p><strong>Degree:</strong> {{this.droidSystems.degree}} | <strong>Size:</strong> {{this.droidSystems.size}}</p>
      </div>

      {{> "systems/foundryvtt-swse/templates/partials/droid-builder-budget.hbs" budget=this.budget}}

      <div class="systems-selector">
        <div class="available-systems">
          <h3>Available Systems</h3>
          {{#each this.availableItems as |item|}}
            <label class="system-item single-select">
              <input
                type="radio"
                name="system-select"
                value="{{item.id}}"
                {{#if (eq this.selectedItems.id item.id)}}checked{{/if}}
                {{#unless item.canAfford}}disabled{{/unless}}
                data-step="locomotion"
              />
              <span class="system-name">{{item.name}}</span>
              <span class="system-cost">[{{item.cost}} credits]</span>
              {{#if item.speed}}
                <span class="system-stat">Speed: {{item.speed}}</span>
              {{/if}}
              {{#unless item.canAfford}}
                <span class="system-unavailable">✗ Insufficient credits</span>
              {{/unless}}
            </label>
          {{/each}}
        </div>

        {{#if this.selectedItems.id}}
          <div class="selected-systems">
            <h3>Selected</h3>
            <div class="selected-item">
              <span class="system-name">{{this.selectedItems.name}}</span>
              <span class="system-cost">[{{this.selectedItems.cost}} credits]</span>
              {{#if this.selectedItems.speed}}
                <span class="system-stat">Speed: {{this.selectedItems.speed}}</span>
              {{/if}}
            </div>
          </div>
        {{/if}}
      </div>

      <div class="action-buttons">
        {{#if this.canGoBack}}
          <button class="back-step btn btn-secondary">← Back</button>
        {{/if}}
        {{#if this.selectedItems.id}}
          <button class="next-step btn btn-primary">Next →</button>
        {{/if}}
      </div>
    </div>
  {{/if}}

  {{!-- Phase 2: Generic multi-select step (manipulators, sensors, weapons, accessories) --}}
  {{#if (or (eq this.currentStep 'manipulators') (eq this.currentStep 'sensors') (eq this.currentStep 'weapons') (eq this.currentStep 'accessories'))}}
    <div class="builder-step phase2-step">
      <h2>{{this.stepConfig.label}} (Step {{this.stepNumber}}/{{this.totalSteps}})</h2>

      <div class="step-info">
        <p><strong>Degree:</strong> {{this.droidSystems.degree}} | <strong>Size:</strong> {{this.droidSystems.size}}</p>
        {{#if (eq this.stepConfig.selectionType 'multiple')}}
          <p class="selection-count">Selected: {{this.selectedItems.length}}</p>
        {{/if}}
      </div>

      {{> "systems/foundryvtt-swse/templates/partials/droid-builder-budget.hbs" budget=this.budget}}

      <div class="systems-selector">
        <div class="available-systems">
          <h3>Available Systems</h3>
          {{#each this.availableItems as |item|}}
            <label class="system-item multi-select">
              <input
                type="checkbox"
                name="system-select"
                value="{{item.id}}"
                {{#if item.isSelected}}checked{{/if}}
                {{#unless item.canAfford}}disabled{{/unless}}
                data-step="{{../this.currentStep}}"
              />
              <span class="system-name">{{item.name}}</span>
              <span class="system-cost">[{{item.cost}} credits]</span>
              {{#unless item.canAfford}}
                <span class="system-unavailable">✗ Insufficient credits</span>
              {{/unless}}
            </label>
          {{/each}}
        </div>

        {{#if this.selectedItems.length}}
          <div class="selected-systems">
            <h3>Selected ({{this.selectedItems.length}})</h3>
            {{#each this.selectedItems as |item|}}
              <div class="selected-item">
                <span class="system-name">{{item.name}}</span>
                <span class="system-cost">[{{item.cost}} credits]</span>
              </div>
            {{/each}}
          </div>
        {{/if}}
      </div>

      <div class="action-buttons">
        {{#if this.canGoBack}}
          <button class="back-step btn btn-secondary">← Back</button>
        {{/if}}
        <button class="next-step btn btn-primary">Next →</button>
      </div>
    </div>
  {{/if}}

  {{!-- Phase 2: Single-select steps (processor, armor) --}}
  {{#if (or (eq this.currentStep 'processor') (eq this.currentStep 'armor'))}}
    <div class="builder-step phase2-step">
      <h2>{{this.stepConfig.label}} (Step {{this.stepNumber}}/{{this.totalSteps}})</h2>

      <div class="step-info">
        <p><strong>Degree:</strong> {{this.droidSystems.degree}} | <strong>Size:</strong> {{this.droidSystems.size}}</p>
      </div>

      {{> "systems/foundryvtt-swse/templates/partials/droid-builder-budget.hbs" budget=this.budget}}

      <div class="systems-selector">
        <div class="available-systems">
          <h3>Available Systems</h3>
          {{#each this.availableItems as |item|}}
            <label class="system-item single-select">
              <input
                type="radio"
                name="system-select"
                value="{{item.id}}"
                {{#if (eq this.selectedItems.id item.id)}}checked{{/if}}
                {{#unless item.canAfford}}disabled{{/unless}}
                data-step="{{../this.currentStep}}"
              />
              <span class="system-name">{{item.name}}</span>
              <span class="system-cost">[{{item.cost}} credits]</span>
              {{#if item.bonus}}
                <span class="system-stat">Bonus: +{{item.bonus}}</span>
              {{/if}}
              {{#unless item.canAfford}}
                <span class="system-unavailable">✗ Insufficient credits</span>
              {{/unless}}
            </label>
          {{/each}}
        </div>

        {{#if this.selectedItems.id}}
          <div class="selected-systems">
            <h3>Selected</h3>
            <div class="selected-item">
              <span class="system-name">{{this.selectedItems.name}}</span>
              <span class="system-cost">[{{this.selectedItems.cost}} credits]</span>
              {{#if this.selectedItems.bonus}}
                <span class="system-stat">Bonus: +{{this.selectedItems.bonus}}</span>
              {{/if}}
            </div>
          </div>
        {{/if}}
      </div>

      <div class="action-buttons">
        {{#if this.canGoBack}}
          <button class="back-step btn btn-secondary">← Back</button>
        {{/if}}
        {{#if this.selectedItems.id}}
          <button class="next-step btn btn-primary">Next →</button>
        {{/if}}
      </div>
    </div>
  {{/if}}

  {{#if (eq this.currentStep 'review')}}
    <div class="builder-step review-step">
      <h2>Configuration Review</h2>

      <div class="config-summary">
        <p><strong>Degree:</strong> {{this.droidSystems.degree}}</p>
        <p><strong>Size:</strong> {{this.droidSystems.size}}</p>
        <p><strong>Locomotion:</strong> {{this.droidSystems.locomotion.name}}</p>
        <p><strong>Manipulators:</strong> {{this.droidSystems.appendages.length}}</p>
        {{#if this.droidSystems.sensors.length}}
          <p><strong>Sensors:</strong> {{this.droidSystems.sensors.length}}</p>
        {{/if}}
        <p><strong>Processor:</strong> {{this.droidSystems.processor.name}}</p>
        <p><strong>Armor:</strong> {{this.droidSystems.armor.name}}</p>
        {{#if this.droidSystems.weapons.length}}
          <p><strong>Weapons:</strong> {{this.droidSystems.weapons.length}}</p>
        {{/if}}
        {{#if this.droidSystems.accessories.length}}
          <p><strong>Accessories:</strong> {{this.droidSystems.accessories.length}}</p>
        {{/if}}
        <p><strong>Budget:</strong> {{this.budget.spent}} / {{this.budget.total}} credits</p>
      </div>

      {{#if this.isValid}}
        <button class="finalize-droid btn btn-success">
          ✓ Finalize Droid
        </button>
      {{else}}
        <div class="alert alert-warning">
          Fix validation errors before finalizing.
        </div>
      {{/if}}

      <button class="back-step btn btn-secondary">← Back</button>
      <button class="reset-droid btn btn-secondary">Reset</button>
    </div>
  {{/if}}
</div>

<template id="droid-builder-budget">
  <div class="budget-display">
    <div class="budget-bar-label">
      Credits: {{this.spent}} / {{this.total}}
      {{#if (gte this.remaining 0)}}
        <span class="budget-remaining">({{this.remaining}} remaining)</span>
      {{else}}
        <span class="budget-over">OVER BUDGET by {{this.remaining}} credits</span>
      {{/if}}
    </div>
    <div class="budget-bar" data-budget-total="{{this.total}}" data-budget-spent="{{this.spent}}">
      <div class="budget-spent"></div>
    </div>
  </div>
</template>

