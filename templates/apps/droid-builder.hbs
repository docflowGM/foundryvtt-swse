<div class="droid-builder-container">
  {{!-- Seraphim Narrator Section --}}
  {{#if this.seraphim}}
    <div class="seraphim-section">
      <div class="seraphim-header">
        <span class="seraphim-label">Seraphim</span>
      </div>

      {{#if this.seraphim.intro}}
        <div class="seraphim-intro">
          {{this.seraphim.intro}}
        </div>
      {{/if}}

      {{#if this.seraphim.reaction}}
        <div class="seraphim-reaction">
          {{this.seraphim.reaction}}
        </div>
      {{/if}}

      {{#if this.seraphim.warnings.length}}
        <div class="seraphim-warnings">
          {{#each this.seraphim.warnings}}
            <div class="warning-item">• {{this}}</div>
          {{/each}}
        </div>
      {{/if}}

      {{#if this.seraphim.budget}}
        <div class="seraphim-budget">
          {{this.seraphim.budget}}
        </div>
      {{/if}}

      {{#if this.seraphim.review}}
        <div class="seraphim-review">
          {{this.seraphim.review}}
        </div>
      {{/if}}
    </div>
  {{/if}}

  {{#if this.validationErrors.length}}
    <div class="alert alert-error">
      <strong>Validation Errors:</strong>
      <ul>
        {{#each this.validationErrors}}
          <li>{{this}}</li>
        {{/each}}
      </ul>
    </div>
  {{/if}}

  {{#if (eq this.currentStep 'intro')}}
    <div class="builder-step intro-step">
      <h2>Welcome to Droid Builder</h2>
      <p>Let's create your droid. First, select a degree of sentience.</p>

      <div class="degree-selection">
        {{#each this.degrees}}
          <button class="select-degree {{#if (eq ../this.droidSystems.degree this.id)}}selected{{/if}}" data-degree="{{this.id}}">
            {{this.label}}
          </button>
        {{/each}}
      </div>

      {{#if this.droidSystems.degree}}
        <button class="next-step btn btn-primary">
          Continue to Size Selection →
        </button>
      {{/if}}
    </div>
  {{/if}}

  {{#if (eq this.currentStep 'size')}}
    <div class="builder-step size-step">
      <h2>Select Droid Size</h2>
      <p><strong>Degree:</strong> {{this.droidSystems.degree}}</p>
      <p>Choose your droid's physical size.</p>

      <div class="size-selection">
        {{#each this.sizes}}
          <button class="select-size {{#if (eq ../this.droidSystems.size this.id)}}selected{{/if}}" data-size="{{this.id}}">
            {{this.label}}
          </button>
        {{/each}}
      </div>

      {{#if this.droidSystems.size}}
        <button class="next-step btn btn-primary">
          Continue to Review →
        </button>
      {{/if}}
    </div>
  {{/if}}

  {{!-- Phase 2: Locomotion Selection --}}
  {{#if (eq this.currentStep 'locomotion')}}
    <div class="builder-step phase2-step">
      <h2>{{this.stepConfig.label}} (Step {{this.stepNumber}}/{{this.totalSteps}})</h2>

      <div class="step-info">
        <p><strong>Degree:</strong> {{this.droidSystems.degree}} | <strong>Size:</strong> {{this.droidSystems.size}}</p>
      </div>

      {{> droid-builder-budget budget=this.budget}}

      <div class="systems-selector">
        <div class="available-systems">
          <h3>Available Systems</h3>
          {{#each this.availableItems as |item|}}
            <label class="system-item single-select">
              <input
                type="radio"
                name="system-select"
                value="{{item.id}}"
                {{#if (eq this.selectedItems.id item.id)}}checked{{/if}}
                {{#unless item.canAfford}}disabled{{/unless}}
                data-step="locomotion"
              />
              <span class="system-name">{{item.name}}</span>
              <span class="system-cost">[{{item.cost}} credits]</span>
              {{#if item.speed}}
                <span class="system-stat">Speed: {{item.speed}}</span>
              {{/if}}
              {{#unless item.canAfford}}
                <span class="system-unavailable">✗ Insufficient credits</span>
              {{/unless}}
            </label>
          {{/each}}
        </div>

        {{#if this.selectedItems.id}}
          <div class="selected-systems">
            <h3>Selected</h3>
            <div class="selected-item">
              <span class="system-name">{{this.selectedItems.name}}</span>
              <span class="system-cost">[{{this.selectedItems.cost}} credits]</span>
              {{#if this.selectedItems.speed}}
                <span class="system-stat">Speed: {{this.selectedItems.speed}}</span>
              {{/if}}
            </div>
          </div>
        {{/if}}
      </div>

      <div class="action-buttons">
        {{#if this.canGoBack}}
          <button class="back-step btn btn-secondary">← Back</button>
        {{/if}}
        {{#if this.selectedItems.id}}
          <button class="next-step btn btn-primary">Next →</button>
        {{/if}}
      </div>
    </div>
  {{/if}}

  {{!-- Phase 2: Generic multi-select step (manipulators, sensors, weapons, accessories) --}}
  {{#if (or (eq this.currentStep 'manipulators') (eq this.currentStep 'sensors') (eq this.currentStep 'weapons') (eq this.currentStep 'accessories'))}}
    <div class="builder-step phase2-step">
      <h2>{{this.stepConfig.label}} (Step {{this.stepNumber}}/{{this.totalSteps}})</h2>

      <div class="step-info">
        <p><strong>Degree:</strong> {{this.droidSystems.degree}} | <strong>Size:</strong> {{this.droidSystems.size}}</p>
        {{#if (eq this.stepConfig.selectionType 'multiple')}}
          <p class="selection-count">Selected: {{this.selectedItems.length}}</p>
        {{/if}}
      </div>

      {{> droid-builder-budget budget=this.budget}}

      <div class="systems-selector">
        <div class="available-systems">
          <h3>Available Systems</h3>
          {{#each this.availableItems as |item|}}
            <label class="system-item multi-select">
              <input
                type="checkbox"
                name="system-select"
                value="{{item.id}}"
                {{#if item.isSelected}}checked{{/if}}
                {{#unless item.canAfford}}disabled{{/unless}}
                data-step="{{../this.currentStep}}"
              />
              <span class="system-name">{{item.name}}</span>
              <span class="system-cost">[{{item.cost}} credits]</span>
              {{#unless item.canAfford}}
                <span class="system-unavailable">✗ Insufficient credits</span>
              {{/unless}}
            </label>
          {{/each}}
        </div>

        {{#if this.selectedItems.length}}
          <div class="selected-systems">
            <h3>Selected ({{this.selectedItems.length}})</h3>
            {{#each this.selectedItems as |item|}}
              <div class="selected-item">
                <span class="system-name">{{item.name}}</span>
                <span class="system-cost">[{{item.cost}} credits]</span>
              </div>
            {{/each}}
          </div>
        {{/if}}
      </div>

      <div class="action-buttons">
        {{#if this.canGoBack}}
          <button class="back-step btn btn-secondary">← Back</button>
        {{/if}}
        <button class="next-step btn btn-primary">Next →</button>
      </div>
    </div>
  {{/if}}

  {{!-- Phase 2: Single-select steps (processor, armor) --}}
  {{#if (or (eq this.currentStep 'processor') (eq this.currentStep 'armor'))}}
    <div class="builder-step phase2-step">
      <h2>{{this.stepConfig.label}} (Step {{this.stepNumber}}/{{this.totalSteps}})</h2>

      <div class="step-info">
        <p><strong>Degree:</strong> {{this.droidSystems.degree}} | <strong>Size:</strong> {{this.droidSystems.size}}</p>
      </div>

      {{> droid-builder-budget budget=this.budget}}

      <div class="systems-selector">
        <div class="available-systems">
          <h3>Available Systems</h3>
          {{#each this.availableItems as |item|}}
            <label class="system-item single-select">
              <input
                type="radio"
                name="system-select"
                value="{{item.id}}"
                {{#if (eq this.selectedItems.id item.id)}}checked{{/if}}
                {{#unless item.canAfford}}disabled{{/unless}}
                data-step="{{../this.currentStep}}"
              />
              <span class="system-name">{{item.name}}</span>
              <span class="system-cost">[{{item.cost}} credits]</span>
              {{#if item.bonus}}
                <span class="system-stat">Bonus: +{{item.bonus}}</span>
              {{/if}}
              {{#unless item.canAfford}}
                <span class="system-unavailable">✗ Insufficient credits</span>
              {{/unless}}
            </label>
          {{/each}}
        </div>

        {{#if this.selectedItems.id}}
          <div class="selected-systems">
            <h3>Selected</h3>
            <div class="selected-item">
              <span class="system-name">{{this.selectedItems.name}}</span>
              <span class="system-cost">[{{this.selectedItems.cost}} credits]</span>
              {{#if this.selectedItems.bonus}}
                <span class="system-stat">Bonus: +{{this.selectedItems.bonus}}</span>
              {{/if}}
            </div>
          </div>
        {{/if}}
      </div>

      <div class="action-buttons">
        {{#if this.canGoBack}}
          <button class="back-step btn btn-secondary">← Back</button>
        {{/if}}
        {{#if this.selectedItems.id}}
          <button class="next-step btn btn-primary">Next →</button>
        {{/if}}
      </div>
    </div>
  {{/if}}

  {{#if (eq this.currentStep 'review')}}
    <div class="builder-step review-step">
      <h2>Configuration Review</h2>

      <div class="config-summary">
        <p><strong>Degree:</strong> {{this.droidSystems.degree}}</p>
        <p><strong>Size:</strong> {{this.droidSystems.size}}</p>
        <p><strong>Locomotion:</strong> {{this.droidSystems.locomotion.name}}</p>
        <p><strong>Manipulators:</strong> {{this.droidSystems.appendages.length}}</p>
        {{#if this.droidSystems.sensors.length}}
          <p><strong>Sensors:</strong> {{this.droidSystems.sensors.length}}</p>
        {{/if}}
        <p><strong>Processor:</strong> {{this.droidSystems.processor.name}}</p>
        <p><strong>Armor:</strong> {{this.droidSystems.armor.name}}</p>
        {{#if this.droidSystems.weapons.length}}
          <p><strong>Weapons:</strong> {{this.droidSystems.weapons.length}}</p>
        {{/if}}
        {{#if this.droidSystems.accessories.length}}
          <p><strong>Accessories:</strong> {{this.droidSystems.accessories.length}}</p>
        {{/if}}
        <p><strong>Budget:</strong> {{this.budget.spent}} / {{this.budget.total}} credits</p>
      </div>

      {{#if this.isValid}}
        <button class="finalize-droid btn btn-success">
          ✓ Finalize Droid
        </button>
      {{else}}
        <div class="alert alert-warning">
          Fix validation errors before finalizing.
        </div>
      {{/if}}

      <button class="back-step btn btn-secondary">← Back</button>
      <button class="reset-droid btn btn-secondary">Reset</button>
    </div>
  {{/if}}
</div>

<template id="droid-builder-budget">
  <div class="budget-display">
    <div class="budget-bar-label">
      Credits: {{this.spent}} / {{this.total}}
      {{#if (gte this.remaining 0)}}
        <span class="budget-remaining">({{this.remaining}} remaining)</span>
      {{else}}
        <span class="budget-over">OVER BUDGET by {{this.remaining}} credits</span>
      {{/if}}
    </div>
    <div class="budget-bar" data-budget-total="{{this.total}}" data-budget-spent="{{this.spent}}">
      <div class="budget-spent"></div>
    </div>
  </div>
</template>

<style>
  .droid-builder-container {
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
  }

  /* Seraphim Narrator Section */
  .seraphim-section {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border-left: 4px solid #5e35b1;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 15px;
    font-size: 13px;
    line-height: 1.5;
  }

  .seraphim-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-weight: bold;
    color: #5e35b1;
  }

  .seraphim-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .seraphim-intro {
    margin-bottom: 8px;
    color: #3a3a3a;
    font-weight: 500;
  }

  .seraphim-reaction {
    margin-bottom: 8px;
    color: #4a4a4a;
    font-style: italic;
  }

  .seraphim-warnings {
    background: #fff3e0;
    border-left: 3px solid #f57c00;
    padding: 8px;
    margin: 8px 0;
    border-radius: 2px;
  }

  .warning-item {
    color: #e65100;
    font-size: 12px;
    margin: 3px 0;
  }

  .seraphim-budget {
    background: #e8f5e9;
    border-left: 3px solid #2e7d32;
    padding: 8px;
    margin: 8px 0;
    border-radius: 2px;
    color: #1b5e20;
    font-size: 12px;
  }

  .seraphim-review {
    background: #f1f8e9;
    border: 1px solid #9ccc65;
    padding: 10px;
    margin: 8px 0;
    border-radius: 2px;
    color: #33691e;
    font-family: monospace;
    font-size: 11px;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .builder-step {
    margin-bottom: 20px;
  }

  .builder-step h2 {
    margin: 0 0 15px 0;
  }

  /* Phase 1: Degree/Size Selection */
  .degree-selection,
  .size-selection {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin: 15px 0;
  }

  .select-degree,
  .select-size {
    padding: 12px;
    border: 2px solid #ccc;
    background: white;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
    text-align: left;
    font-size: 14px;
  }

  .select-degree:hover,
  .select-size:hover {
    border-color: #666;
    background: #f5f5f5;
  }

  .select-degree.selected,
  .select-size.selected {
    border-color: #2a9d00;
    background: #e8f5e9;
    font-weight: bold;
  }

  /* Phase 2: System Selection */
  .phase2-step {
    display: flex;
    flex-direction: column;
  }

  .step-info {
    background: #f9f9f9;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 15px;
    font-size: 13px;
  }

  .step-info p {
    margin: 4px 0;
  }

  .selection-count {
    font-weight: bold;
    color: #2a9d00;
  }

  /* Budget Display */
  .budget-display {
    background: #f0f4f8;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 15px;
  }

  .budget-bar-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 13px;
    font-weight: 500;
  }

  .budget-remaining {
    color: #2a9d00;
    font-weight: bold;
  }

  .budget-over {
    color: #c62828;
    font-weight: bold;
  }

  .budget-bar {
    width: 100%;
    height: 20px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
  }

  .budget-spent {
    height: 100%;
    background: linear-gradient(90deg, #2a9d00, #4caf50);
    transition: width 0.3s ease;
  }

  /* Systems Selector */
  .systems-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .available-systems,
  .selected-systems {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    background: #fafafa;
  }

  .available-systems h3,
  .selected-systems h3 {
    margin: 0 0 12px 0;
    font-size: 14px;
    font-weight: bold;
  }

  .system-item {
    display: flex;
    flex-direction: column;
    padding: 10px;
    margin-bottom: 8px;
    border: 1px solid #e0e0e0;
    border-radius: 3px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
  }

  .system-item:hover {
    border-color: #2a9d00;
    background: #f5fff5;
  }

  .system-item input[type="radio"],
  .system-item input[type="checkbox"] {
    margin-right: 8px;
    margin-bottom: 4px;
  }

  .system-item input[type="radio"]:checked + .system-name,
  .system-item input[type="checkbox"]:checked + .system-name {
    font-weight: bold;
    color: #2a9d00;
  }

  .system-item input:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .system-name {
    font-weight: 500;
    font-size: 13px;
  }

  .system-cost {
    font-size: 12px;
    color: #666;
  }

  .system-stat {
    font-size: 11px;
    color: #999;
    margin-top: 2px;
  }

  .system-unavailable {
    font-size: 11px;
    color: #c62828;
    font-weight: bold;
  }

  .selected-item {
    display: flex;
    flex-direction: column;
    padding: 10px;
    margin-bottom: 8px;
    border: 2px solid #2a9d00;
    border-radius: 3px;
    background: #e8f5e9;
  }

  .selected-item .system-name {
    color: #1b5e20;
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  /* Review Step */
  .config-summary {
    background: #f9f9f9;
    border-left: 4px solid #2a9d00;
    padding: 15px;
    margin: 15px 0;
    border-radius: 4px;
  }

  .config-summary p {
    margin: 8px 0;
    font-size: 13px;
  }

  /* Alerts */
  .alert {
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 4px;
  }

  .alert-error {
    background: #ffebee;
    border-left: 4px solid #c62828;
    color: #b71c1c;
  }

  .alert-warning {
    background: #fff3e0;
    border-left: 4px solid #e65100;
    color: #bf360c;
  }

  /* Buttons */
  .btn {
    padding: 10px 16px;
    margin-top: 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
    margin-right: 8px;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-primary {
    background: #2a9d00;
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: #1e7e34;
  }

  .btn-success {
    background: #4caf50;
    color: white;
    flex: 1;
  }

  .btn-success:hover:not(:disabled) {
    background: #388e3c;
  }

  .btn-secondary {
    background: #9e9e9e;
    color: white;
  }

  .btn-secondary:hover:not(:disabled) {
    background: #616161;
  }

  /* Responsive: On smaller screens, stack the systems selector */
  @media (max-width: 700px) {
    .systems-selector {
      grid-template-columns: 1fr;
    }

    .action-buttons {
      flex-direction: column-reverse;
    }

    .btn {
      width: 100%;
      margin-right: 0;
      margin-bottom: 8px;
    }
  }
</style>
