<div class="swse-sheet swse-character-sheet v2">
  <div class="sheet-inner">
   <!-- COMPACT HEADER -->


  <!-- ==========================================================
       SWSE DATAPAD HEADER REFACTOR
  ========================================================== -->

  <div class="swse-datapad-title">
    {{actor.name}} DATAPAD
  </div>

  <section class="swse-header">

    <!-- ROW 1: IDENTITY -->
    <div class="header-row identity-row">

      <img src="{{actor.img}}"
           data-edit="img"
           title="Click to change portrait"
           class="header-portrait"/>

      <div class="identity-block">

        <input name="name"
               type="text"
               value="{{actor.name}}"
               class="header-name"/>

        <div class="identity-subline">
          {{actor.system.species}} | {{actor.system.class}}
        </div>

        <div class="level-line">
          Heroic Level {{actor.system.level}}
          <span class="half-level">
            (½ Lvl {{derived.identity.halfLevel}})
          </span>
        </div>

      </div>

    </div>

    <!-- ROW 2: STATUS STRIP -->
    <div class="header-row status-row">

      <div class="status-block hp-block">
        <div class="status-label">HP</div>
        <div class="status-bar hp-bar">
          <div class="fill" style="width: {{hp.percent}}%;"></div>
        </div>
      </div>

      {{#if xpEnabled}}
      <div class="status-block xp-block">
        <div class="status-label">XP</div>
        <div class="status-bar xp-bar {{#if xpLevelReady}}xp-ready{{/if}}">
          <div class="fill" style="width: {{xpPercent}}%;"></div>
        </div>
      </div>
      {{/if}}

      <div class="status-block fp-block">
        <div class="status-label">FP</div>
        <div class="fp-dots">
          {{#each forcePoints as |fp|}}
            <span class="fp-dot {{#if fp.used}}used{{/if}}"></span>
          {{/each}}
        </div>
      </div>

      <div class="status-block ct-block">
        <div class="status-label">CT</div>
        <div class="ct-mini">
          {{#each conditionSteps as |step|}}
            <span class="ct-dot {{#if step.active}}active{{/if}}"></span>
          {{/each}}
        </div>
      </div>

    </div>

    <!-- ROW 3: COMMANDS -->
    <div class="header-row command-row">

      {{#if isLevel0}}
        <button data-action="cmd-chargen" class="header-btn">
          Chargen
        </button>
      {{else}}
        <button data-action="cmd-levelup"
                class="header-btn {{#if xpLevelReady}}ready{{/if}}">
          Level Up
        </button>
      {{/if}}

      <button data-action="cmd-store" class="header-btn">
        Store
      </button>

      <button type="button" class="header-btn mentor-button" data-action="open-mentor">
        <i class="fas fa-user-astronaut"></i> Talk to Mentor
      </button>

      <button data-action="cmd-conditions" class="header-btn">
        Conditions
      </button>

    </div>

  </section>


  <!-- PHASE 3: BUILD MODE INDICATOR -->
  {{#if (eq buildMode "free")}}
    <div style="background: #fff3e0; border: 2px solid #ff6b35; border-radius: 6px; padding: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
      <span style="color: #e65100; font-weight: bold;">
        ⚠ Free Build Mode — Prerequisites not enforced
      </span>
      <button type="button" class="revalidate-build" style="background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; data-action="revalidate-build">
        Revalidate Build
      </button>
    </div>
  {{/if}}

  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item active" data-tab="overview">Overview</a>
    <a class="item" data-tab="combat">Combat</a>
    <a class="item" data-tab="skills">Skills</a>
    <a class="item" data-tab="talents">Talents</a>
    <a class="item" data-tab="feats">Feats</a>
    <a class="item" data-tab="feats">Feats</a>
    {{#if actor.system.forceSensitive}}<a class="item" data-tab="force">Force</a>{{/if}}
    <a class="item" data-tab="gear">Gear</a>
    <a class="item" data-tab="other">Other</a>
    <a class="item" data-tab="biography">Biography</a>
  </nav>

  <section class="sheet-body">
    <section class="tab active" data-group="primary" data-tab="overview">
      <div class="swse-v2-sheet-grid">
        <div class="swse-v2-left">
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/identity-strip.hbs"}}
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/abilities-panel.hbs"}}
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/hp-condition-panel.hbs"}}
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/defenses-panel.hbs"}}
        </div>
        <div class="swse-v2-right">
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/xp-panel.hbs"}}
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/second-wind-panel.hbs"}}
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/dark-side-panel.hbs"}}
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/languages-panel.hbs"}}
        </div>
      </div>
    </section>

    <section class="tab" data-group="primary" data-tab="combat">
      <div class="swse-v2-sheet-grid">

        <!-- INITIATIVE DISPLAY -->
        <div class="swse-v2-full">
          <div class="holo-panel initiative-panel">
            <div class="section-bar">
              <h3 class="section-header">Initiative</h3>
            </div>
            <div class="initiative-panel-body">
              <div class="initiative-mod-label">Total Modifier</div>
              <div class="initiative-mod-value">{{initiativeTotal}}</div>
              <div class="initiative-controls">
                <button type="button" class="initiative-btn roll-initiative">
                  Roll
                </button>
                <button type="button" class="initiative-btn take10-initiative">
                  Take 10
                </button>
                {{#if fpAvailable}}
                <button type="button" class="initiative-btn roll-initiative-force">
                  Roll + Force
                </button>
                {{/if}}
              </div>
            </div>
          </div>
        </div>

        <div class="swse-v2-full">
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/attacks-panel.hbs"}}
        </div>

        <div class="swse-v2-full">
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/actions-panel.hbs"}}
        </div>
      </div>
    </section>

    <section class="tab" data-group="primary" data-tab="skills">
      <div class="swse-v2-sheet-grid">
        <div class="swse-v2-full">
          {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/skills-panel.hbs"}}
        </div>
      </div>
    </section>

    

    

<section class="tab" data-group="primary" data-tab="talents">
  <div class="swse-v2-sheet-grid">
    <div class="swse-v2-full">
      {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/Talents.hbs"}}
    </div>
  </div>
</section>



    {{#if actor.system.forceSensitive}}
    
<section class="tab" data-group="primary" data-tab="feats">
  <div class="swse-v2-sheet-grid">
    <div class="swse-v2-full">
      {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/Racial-ability.hbs"}}
      {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/Feats.hbs"}}
    </div>
  </div>
</section>


<section class="tab" data-group="primary" data-tab="feats">
  <div class="swse-v2-sheet-grid">
    <div class="swse-v2-full">
      {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/Racial-ability.hbs"}}
      {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/Feats.hbs"}}
    </div>
  </div>
</section>


<section class="tab" data-group="primary" data-tab="force">
  <div class="swse-v2-sheet-grid">
    <div class="swse-v2-full">
      {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/Force.hbs"}}
    </div>
  </div>
</section>

    {{/if}}

    <section class="tab" data-group="primary" data-tab="gear" data-drop-zone="inventory">
      <div class="swse-v2-sheet-grid">
        <div class="swse-v2-full">
          <section class="gear-section">
            <h3>Equipment</h3>

            <!-- PHASE 2: INVENTORY SUMMARY & SEARCH -->
            <div class="inventory-summary" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px;">
              <div style="font-size: 0.85rem;">
                <strong>Weight:</strong> {{totalWeight}} lbs
              </div>
              <div style="font-size: 0.85rem; padding: 4px 8px; border-radius: 4px; {{encumbranceStateCss}}">
                {{encumbranceLabel}}
              </div>
            </div>

            <!-- PHASE 2: INVENTORY SEARCH -->
            <div class="inventory-search" style="margin-bottom: 10px;">
              <input type="text"
                     class="inventory-search-input"
                     data-action="inventory-search"
                     placeholder="Search inventory..."
                     value="{{inventorySearch}}"
                     style="width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; background: #fff;" />
            </div>

            <!-- V2 INVENTORY PANEL (NEW) -->
            {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/inventory-panel.hbs"}}

            {{#if equipment}}
              <div class="equipment-list" style="border-top: 1px solid #ddd;">
                {{#each equipment as |item|}}
                  <div class="equipment-row" style="display: grid; grid-template-columns: 20px 1fr 80px 100px 60px 60px 60px; gap: 8px; padding: 8px; border-bottom: 1px solid #eee; align-items: center;">
                    <!-- PHASE 2: EXPAND/COLLAPSE TOGGLE -->
                    <button type="button"
                            class="item-expand-toggle"
                            data-action="toggle-item-expand"
                            data-item-id="{{item.id}}"
                            style="background: none; border: none; cursor: pointer; padding: 0; width: 20px; text-align: center;">
                      {{#if item._expanded}}▼{{else}}▶{{/if}}
                    </button>
                    <div class="equipment-name">
                      <button type="button"
                              class="equipment-name-btn swse-v2-open-item"
                              data-item-id="{{item.id}}"
                              style="background: none; border: none; color: #0066cc; cursor: pointer; text-decoration: underline;">
                        {{item.name}}
                      </button>
                    </div>
                    <input type="number"
                           name="items.{{item.id}}.system.quantity"
                           value="{{item.system.quantity}}"
                           min="0"
                           style="padding: 4px; border: 1px solid #ccc; border-radius: 2px;">
                    <div class="equipment-weight" style="text-align: right;">
                      {{item.system.weight}} lbs
                    </div>
                    <!-- PHASE 2: SPLIT BUTTON (if qty > 1) -->
                    {{#if (gt item.system.quantity 1)}}
                      <button type="button"
                              class="equipment-split"
                              data-action="split-stack"
                              data-item-id="{{item.id}}"
                              style="background: #2196F3; color: white; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer; font-size: 0.8em;">
                        Split
                      </button>
                    {{else}}
                      <div></div>
                    {{/if}}
                    <button type="button"
                            class="equipment-sell"
                            data-action="sell-item"
                            data-item-id="{{item.id}}"
                            style="background: #4CAF50; color: white; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer; font-size: 0.8em;">
                      Sell
                    </button>
                    <button type="button"
                            class="equipment-delete"
                            data-action="delete-item"
                            data-item-id="{{item.id}}"
                            style="background: #cc0000; color: white; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer; font-size: 0.8em;">
                      Delete
                    </button>
                  </div>
                {{/each}}
              </div>
            {{else}}
              <div class="muted" style="padding: 16px;">No equipment</div>
            {{/if}}
          </section>
        </div>

        <div class="swse-v2-full">
          <section class="armor-section">
            <h3>Armor</h3>
            {{#if armor}}
              <div class="armor-list" style="border-top: 1px solid #ddd;">
                {{#each armor as |item|}}
                  <div class="armor-row" style="display: grid; grid-template-columns: 40px 1fr 120px 100px 80px 80px; gap: 8px; padding: 8px; border-bottom: 1px solid #eee; align-items: center;">
                    <div style="text-align: center;">
                      <input type="checkbox"
                             class="armor-equip"
                             data-action="toggle-equip-armor"
                             data-item-id="{{item.id}}"
                             {{#if item.system.equipped}}checked{{/if}}
                             style="cursor: pointer;">
                    </div>
                    <div class="armor-name">
                      <button type="button"
                              class="armor-name-btn swse-v2-open-item"
                              data-item-id="{{item.id}}"
                              style="background: none; border: none; color: #0066cc; cursor: pointer; text-decoration: underline;">
                        {{item.name}}
                      </button>
                    </div>
                    <div style="font-size: 0.85em;">
                      Def: {{item.system.defenseBonus}} | DX: {{item.system.maxDex}}
                    </div>
                    <div style="text-align: right; font-size: 0.85em;">
                      {{item.system.weight}} lbs
                    </div>
                    <button type="button"
                            class="armor-sell"
                            data-action="sell-item"
                            data-item-id="{{item.id}}"
                            style="background: #4CAF50; color: white; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer;">
                      Sell
                    </button>
                    <button type="button"
                            class="armor-delete"
                            data-action="delete-item"
                            data-item-id="{{item.id}}"
                            style="background: #cc0000; color: white; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer;">
                      Delete
                    </button>
                  </div>
                {{/each}}
              </div>
            {{else}}
              <div class="muted" style="padding: 16px;">No armor equipped</div>
            {{/if}}
          </section>
        </div>

        <div class="swse-v2-full">
          <section class="weapons-section">
            <h3>Weapons</h3>
            {{#if weapons}}
              <div class="weapons-list" style="border-top: 1px solid #ddd;">
                {{#each weapons as |item|}}
                  <div class="weapon-row" style="display: grid; grid-template-columns: 1fr 100px 80px; gap: 8px; padding: 8px; border-bottom: 1px solid #eee; align-items: center;">
                    <div class="weapon-name">
                      <button type="button"
                              class="weapon-name-btn swse-v2-open-item"
                              data-item-id="{{item.id}}"
                              style="background: none; border: none; color: #0066cc; cursor: pointer; text-decoration: underline;">
                        {{item.name}}
                      </button>
                    </div>
                    <div style="font-size: 0.85em;">
                      {{item.system.damage}}
                    </div>
                    <button type="button"
                            class="weapon-delete"
                            data-action="delete-item"
                            data-item-id="{{item.id}}"
                            style="background: #cc0000; color: white; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer;">
                      Delete
                    </button>
                  </div>
                {{/each}}
              </div>
            {{else}}
              <div class="muted" style="padding: 16px;">No weapons</div>
            {{/if}}
          </section>
        </div>

        <div class="swse-v2-full">
          <div class="holo-panel">
            <div class="section-bar">
              <h3 class="section-header">Encumbrance</h3>
            </div>
            <div style="padding: 16px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div>
                  <div style="font-size: 0.9em; color: #666; margin-bottom: 4px;">Total Weight</div>
                  <div style="font-size: 1.5em; font-weight: bold;">
                    {{derived.encumbrance.total}} lbs
                  </div>
                </div>
                <div>
                  <div style="font-size: 0.9em; color: #666; margin-bottom: 4px;">Encumbrance State</div>
                  <div style="font-size: 1.2em; font-weight: bold; {{#if (eq derived.encumbrance.state "heavy")}}color: #ff6b35;{{else if (eq derived.encumbrance.state "overloaded")}}color: #cc0000;{{/if}}">
                    {{derived.encumbrance.label}}
                  </div>
                </div>
              </div>

              <!-- Load thresholds -->
              <div style="font-size: 0.75rem; margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px; opacity: 0.8;">
                <div>Light Load: {{derived.encumbrance.lightLoad}} lbs</div>
                <div>Medium Load: {{derived.encumbrance.mediumLoad}} lbs</div>
                <div>Heavy Load: {{derived.encumbrance.heavyLoad}} lbs</div>
              </div>

              {{#if derived.encumbrance.skillPenalty}}
                <div style="color: #ff6b35; font-weight: bold; margin-bottom: 8px;">
                  Skill Penalty: {{derived.encumbrance.skillPenalty}}
                </div>
                <div style="font-size: 0.75rem; opacity: 0.9;">
                  <strong>Affected Skills:</strong> {{#join derived.encumbrance.affectedSkills ", "}}{{/join}}
                </div>
              {{/if}}

              {{#if derived.encumbrance.removeDexToReflex}}
                <div style="color: #cc0000; font-weight: bold; margin-top: 8px;">
                  ⚠ Dex bonus to Reflex removed
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="tab" data-group="primary" data-tab="other">
      <div class="swse-v2-sheet-grid">
        <section class="other-owned">
          <h3>Followers & Assets</h3>
{{#if followerTalentBadges.length}}
  <div class="follower-badges" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 10px 0;">
    {{#each followerTalentBadges as |b|}}
      <span class="tag-pill" style="padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.18);background:rgba(0,0,0,0.18);font-size:12px;">
        {{b.talentName}}: {{b.current}}/{{b.max}}
      </span>
    {{/each}}
  </div>
{{/if}}

{{#if followerSlots.length}}
  <div class="follower-slots" style="margin-bottom:12px;">
    {{#each followerSlots as |slot|}}
      <div class="owned-entry follower-slot"
           data-slot-id="{{slot.id}}"
           {{#if slot.actor}}draggable="true" data-actor-id="{{slot.actor.id}}"{{/if}}
           style="display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid rgba(255,255,255,0.12);border-radius:8px;background:rgba(0,0,0,0.12);margin-bottom:8px;">
        <div style="width:56px;height:56px;flex:0 0 56px;border-radius:6px;overflow:hidden;border:1px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.2);">
          {{#if slot.tokenImg}}
            <img src="{{slot.tokenImg}}" alt="token" style="width:100%;height:100%;object-fit:cover;">
          {{/if}}
        </div>

        <div style="flex:1;">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
            <div>
              {{#if slot.actor}}
                <div style="font-weight:700;">{{slot.actor.name}}</div>
                <div style="opacity:0.75;font-size:12px;margin-top:2px;">
                  {{slot.roleLabel}} • Level {{slot.level}} • HP {{slot.hp.value}}/{{slot.hp.max}} • {{slot.actor.type}}
                </div>
              {{else}}
                <div style="font-weight:700;">Empty Follower Slot</div>
                <div style="opacity:0.75;font-size:12px;margin-top:2px;">
                  Granted by {{slot.talentName}} • {{slot.roleLabel}}
                </div>
              {{/if}}
            </div>

            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
              {{#if slot.actor}}
                <button type="button" data-action="edit-follower" data-actor-id="{{slot.actor.id}}">
                  Edit
                </button>
              {{else}}
                <button type="button"
                        data-action="create-follower"
                        data-slot-id="{{slot.id}}"
                        {{#if slot.isLocked}}disabled{{/if}}>
                  {{#if slot.isLocked}}Locked{{else}}Create{{/if}}
                </button>
              {{/if}}
            </div>
          </div>

          {{#if slot.tags.length}}
            <div class="tag-pills" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;">
              {{#each slot.tags as |tag|}}
                <span class="tag-pill" style="padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.18);background:rgba(0,0,0,0.18);font-size:12px;">
                  {{tag}}
                </span>
              {{/each}}
            </div>
          {{/if}}
        </div>
      </div>
    {{/each}}
  </div>
{{/if}}

          <div class="owned-actors-list" data-drop-zone="other" style="border: 2px dashed #ccc; padding: 12px; border-radius: 4px; min-height: 100px; background: rgba(0,0,0,0.05);">
            {{#if actor.system.ownedActors}}
              {{#each actor.system.ownedActors as |entry|}}
                {{#with (lookup ../ownedActorMap entry.id) as |actor|}}
                  <div class="owned-entry" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #ddd;">
                    <div style="flex: 1;">
                      <button type="button"
                              class="owned-button"
                              data-action="open-owned"
                              data-actor-id="{{actor.id}}"
                              style="background: none; border: none; padding: 0; color: #0066cc; cursor: pointer; text-decoration: underline;">
                        {{actor.name}}
                      </button>
                    </div>
                    <button type="button"
                            class="owned-remove"
                            data-action="remove-owned"
                            data-actor-id="{{actor.id}}"
                            style="background: #cc0000; color: white; border: none; padding: 4px 8px; border-radius: 2px; cursor: pointer;">
                      Remove
                    </button>
                  </div>
                {{/with}}
              {{/each}}
            {{else}}
              <div class="muted" style="text-align: center; padding: 20px;">
                Drag vehicles, NPCs, or beasts here to add followers or assets.
              </div>
            {{/if}}
          </div>
        </section>
      </div>
    </section>

   <section class="tab biography-tab" data-group="primary" data-tab="biography">

  <div class="swse-v2-sheet-grid">

    {{> "systems/foundryvtt-swse/templates/actors/character/v2/partials/identity-strip.hbs"}}

    <!-- ============================= -->
    <!-- CHARACTER NOTES -->
    <!-- ============================= -->
    <div class="swse-v2-full">
      <div class="holo-panel">
        <div class="section-bar">
          <h3 class="section-header">Character Notes & Background</h3>
        </div>

        <textarea
          name="system.biography"
          class="swse-bio-main"
          placeholder="Write your character's background, personality, goals, bonds, motivations, and other notes here..."
          {{#unless editable}}disabled{{/unless}}
        >{{system.biography}}</textarea>
      </div>
    </div>

    <!-- ============================= -->
    <!-- BACKGROUND DETAILS -->
    <!-- ============================= -->
    <div class="swse-v2-left">
      <div class="holo-panel">
        <div class="section-bar">
          <h3 class="section-header">Background Details</h3>
        </div>

        <div class="swse-bio-fields">

          <div class="swse-bio-field">
            <label>Contacts & Allies</label>
            <textarea
              name="system.biography.contacts"
              {{#unless editable}}disabled{{/unless}}
            >{{system.biography.contacts}}</textarea>
          </div>

          <div class="swse-bio-field">
            <label>Reputation & Notoriety</label>
            <textarea
              name="system.biography.reputation"
              {{#unless editable}}disabled{{/unless}}
            >{{system.biography.reputation}}</textarea>
          </div>

          <div class="swse-bio-field">
            <label>Faction Alignment</label>
            <input
              type="text"
              name="system.biography.faction"
              value="{{system.biography.faction}}"
              {{#unless editable}}disabled{{/unless}}
            />
          </div>

        </div>
      </div>
    </div>

    <!-- ============================= -->
    <!-- GM NOTES -->
    <!-- ============================= -->
    {{#if isGM}}
    <div class="swse-v2-right">
      <div class="holo-panel swse-gm-panel">
        <div class="section-bar">
          <h3 class="section-header">GM-Only Notes</h3>
        </div>

        <textarea
          name="system.biography.gmNotes"
          class="swse-bio-gm"
          {{#unless editable}}disabled{{/unless}}
        >{{system.biography.gmNotes}}</textarea>
      </div>
    </div>
    {{/if}}

  </div>

</section>