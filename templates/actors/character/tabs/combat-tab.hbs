<div class="tab combat-tab" data-group="primary" data-tab="combat">
 <h3 class="section-header">Defenses</h3>

 <div class="defenses-grid-container">
 <div class="defenses-header">DEFENSES</div>

 {{#each system.defenses as |defense key|}}
 <div class="defense-grid-row">
 <!-- Defense Name Box -->
 <div class="defense-name-box">{{upper (substring key 0 4)}}</div>

 <!-- Base (10) -->
 <div class="defense-box-group">
 <input type="number"
 value="10"
 disabled
 class="defense-input-sm"/>
 <label class="defense-box-label">Base</label>
 </div>

 <div class="operator">+</div>

 <!-- Ability Selector Dropdown -->
 <div class="defense-box-group">
 <select
 name="system.defenses.{{key}}.ability"
 class="defense-select-sm">
 <option value="str" {{#if (eq defense.ability "str")}}selected{{/if}}>STR</option>
 <option value="dex" {{#if (eq defense.ability "dex")}}selected{{/if}}>DEX</option>
 <option value="con" {{#if (eq defense.ability "con")}}selected{{/if}}>CON</option>
 <option value="int" {{#if (eq defense.ability "int")}}selected{{/if}}>INT</option>
 <option value="wis" {{#if (eq defense.ability "wis")}}selected{{/if}}>WIS</option>
 <option value="cha" {{#if (eq defense.ability "cha")}}selected{{/if}}>CHA</option>
 </select>
 <label class="defense-box-label">Ability</label>
 </div>

 <div class="operator">+</div>

 <!-- Class Bonus -->
 <div class="defense-box-group">
 <input type="number"
 name="system.defenses.{{key}}.classBonus"
 value="{{defense.classBonus}}"
 data-dtype="Number"
 class="defense-input-sm"
 placeholder="0"/>
 <label class="defense-box-label">Class</label>
 </div>

 <div class="operator">+</div>

 <!-- Misc -->
 <div class="defense-box-group">
 <input type="number"
 name="system.defenses.{{key}}.misc.user.extra"
 value="{{defense.misc.user.extra}}"
 data-dtype="Number"
 class="defense-input-sm"
 placeholder="0"/>
 <label class="defense-box-label">Misc</label>
 </div>

 <div class="operator">=</div>

 <!-- Total -->
 <div class="defense-total-box">{{defense.total}}</div>
 </div>
 {{/each}}
 </div>

 {{!-- Grappling Section --}}
 <h3 class="section-header">Grappling Status</h3>

 <div class="grapple-section">
   <div class="grapple-status">
     {{#if grappleState.grabbed}}
       <div class="grapple-condition grabbed">
         <i class="fas fa-hand-holding-heart"></i>
         <strong>Grabbed by:</strong> {{grappleState.grappler}}
       </div>
     {{/if}}

     {{#if grappleState.grappled}}
       <div class="grapple-condition grappled">
         <i class="fas fa-link"></i>
         <strong>Grappled with:</strong> {{grappleState.opponent}}
       </div>
     {{/if}}

     {{#if grappleState.pinned}}
       <div class="grapple-condition pinned">
         <i class="fas fa-ban"></i>
         <strong>Pinned by:</strong> {{grappleState.grappler}}
         <span class="reflex-penalty">-10 Reflex</span>
       </div>
     {{/if}}

     {{#unless grappleState.grabbed}}
       {{#unless grappleState.grappled}}
         {{#unless grappleState.pinned}}
           <div class="grapple-condition free">
             <i class="fas fa-check-circle"></i>
             <strong>Not Grappled</strong>
           </div>
         {{/unless}}
       {{/unless}}
     {{/unless}}
   </div>

   <div class="grapple-actions">
     {{#if grappleState.grabbed}}
       <button class="grapple-action-btn" data-action="continueGrapple" title="Make opposed grapple check">
         <i class="fas fa-handshake"></i> Continue Grapple Check
       </button>
     {{else}}
       <button class="grapple-action-btn" data-action="startGrapple" title="Initiate grab attack (standard action)">
         <i class="fas fa-hand-holding-heart"></i> Start Grab
       </button>
     {{/if}}

     {{#if grappleState.grappled}}
       {{#if grappleState.canPin}}
         <button class="grapple-action-btn pin-action" data-action="attemptPin" title="Requires Pin feat (opposed grapple check)">
           <i class="fas fa-ban"></i> Attempt Pin
         </button>
       {{/if}}

       <button class="grapple-action-btn escape-action" data-action="escapeGrapple" title="Escape grapple (opposed check)">
         <i class="fas fa-running"></i> Escape
       </button>
     {{/if}}
   </div>
 </div>

 <h3 class="section-header">Weapons</h3>

 <div class="weapons-list">
 <div class="weapons-header flexrow">
 <div class="weapon-col-name">Weapon</div>
 <div class="weapon-col-attack">Attack</div>
 <div class="weapon-col-damage">Damage</div>
 <div class="weapon-col-crit">Critical</div>
 <div class="weapon-col-equipped">Equipped</div>
 <div class="weapon-col-controls"></div>
 </div>

 {{#each weapons as |weapon|}}
 <div class="weapon-row flexrow {{if weapon.system.equipped 'equipped' ''}}" data-item-id="{{weapon._id}}">
 <div class="weapon-name">
 <img src="{{weapon.img}}" width="24" height="24" alt="{{weapon.name}}"/>
 {{weapon.name}}
 </div>

 <div class="weapon-attack rollable"
 data-action="rollAttack"
 data-item-id="{{weapon._id}}">
 {{numberFormat (safeNumber weapon.system.attackBonus) sign=true}}
 </div>

 <div class="weapon-damage rollable"
 data-action="rollDamage"
 data-item-id="{{weapon._id}}">
 {{weapon.system.damage}}
 </div>

 <div class="weapon-crit">
 {{weapon.system.critical}}
 </div>

 <label class="weapon-equipped-toggle">
 <input type="checkbox"
 name="items.{{weapon._id}}.system.equipped"
 {{checked weapon.system.equipped}}/>
 <i class="fas fa-hand-holding"></i>
 </label>

 <div class="weapon-controls flexrow">
 <a class="item-control item-edit" data-action="edit" title="Edit">
 <i class="fas fa-edit"></i>
 </a>
 <a class="item-control item-delete" data-action="delete" title="Delete">
 <i class="fas fa-trash"></i>
 </a>
 </div>
 </div>
 {{/each}}

 <button class="add-weapon" data-action="createItem" data-type="weapon">
 <i class="fas fa-plus"></i> Add Weapon
 </button>
 </div>

 <h3 class="section-header">Armor</h3>

 <div class="armor-section">
 {{#each armor as |item|}}
 <div class="armor-row flexrow {{if item.system.equipped 'equipped' ''}}" data-item-id="{{item._id}}">
 <img src="{{item.img}}" width="24" height="24" alt="{{item.name}}"/>
 <div class="armor-info flex2">
 <span class="armor-name">{{item.name}}</span>
 <div class="armor-stats">
 <span class="armor-bonus"><i class="fas fa-shield-alt"></i> Reflex: +{{item.system.defenseBonus}}</span>
 <span class="armor-max-dex"><i class="fas fa-running"></i> Max Dex: +{{item.system.maxDexBonus}}</span>
 </div>
 </div>
 <label class="armor-equipped-toggle" title="{{if item.system.equipped 'Equipped - providing defense bonus' 'Not equipped'}}">
 <input type="checkbox"
 name="items.{{item._id}}.system.equipped"
 {{checked item.system.equipped}}/>
 <i class="fas fa-user-shield"></i>
 <span class="equipped-label">{{if item.system.equipped 'Equipped' 'Equip'}}</span>
 </label>
 <div class="item-controls flexrow">
 <a class="item-control item-edit" data-action="edit" title="Edit">
 <i class="fas fa-edit"></i>
 </a>
 <a class="item-control item-delete" data-action="delete" title="Delete">
 <i class="fas fa-trash"></i>
 </a>
 </div>
 </div>
 {{/each}}

 <button class="add-armor" data-action="createItem" data-type="armor">
 <i class="fas fa-shield-alt"></i> Add Armor
 </button>
 </div>

 <h3 class="section-header">Feats</h3>

 <div class="feats-grid">
 {{#each feats as |feat|}}
 <div class="feat-card" data-item-id="{{feat._id}}" title="{{feat.name}}">
 <div class="feat-icon">
 {{#if feat.img}}
 <img src="{{feat.img}}" alt="{{feat.name}}" width="48" height="48"/>
 {{else}}
 <img src="systems/foundryvtt-swse/assets/feats/feat-generic.svg" alt="Feat Icon" width="48" height="48" class="default-feat-icon"/>
 {{/if}}
 </div>
 <h5>{{feat.name}}</h5>
 {{#if feat.system.prerequisite}}
 <p class="feat-prereqs">
 <i class="fas fa-link"></i> {{feat.system.prerequisite}}
 </p>
 {{/if}}
 <div class="item-controls flexrow">
 <a class="item-control item-edit" data-action="edit" title="Edit">
 <i class="fas fa-edit"></i>
 </a>
 <a class="item-control item-delete" data-action="delete" title="Delete">
 <i class="fas fa-trash"></i>
 </a>
 </div>
 </div>
 {{/each}}
 </div>

 <button class="add-feat" data-action="createItem" data-type="feat">
 <i class="fas fa-plus"></i> Add Feat
 </button>

 {{!-- Feat Actions Panel --}}
 {{> "systems/foundryvtt-swse/templates/partials/feat-actions-panel.hbs" featActions=featActions}}

 <h3 class="section-header">Combat Actions</h3>

 <div class="combat-actions-section">
 <div class="combat-actions-filter">
 <input type="text"
 class="combat-action-search"
 placeholder="Search actions..."
 title="Filter combat actions by name"/>
 <select class="action-type-filter">
 <option value="">All Action Types</option>
 <option value="swift">Swift Actions</option>
 <option value="move">Move Actions</option>
 <option value="standard">Standard Actions</option>
 <option value="full-round">Full-Round Actions</option>
 </select>
 </div>

 <div class="combat-actions-list">
 {{#each combatActions as |action|}}
 <div class="combat-action-row"
 data-action-type="{{action.actionType}}"
 data-action-name="{{action.name}}">
 <div class="action-header">
 <span class="action-name rollable"
 data-action="rollCombatAction"
 data-action-name="{{action.name}}"
 data-dc="{{action.dc.value}}"
 data-notes="{{action.notes}}"
 title="Click to post to chat">
 <i class="fas fa-dice-d20"></i> {{action.name}}
 </span>
 <span class="action-type-badge {{action.actionType}}">
 {{action.actionType}}
 </span>
 </div>
 <div class="action-details">
 <p class="action-notes">{{action.notes}}</p>
 {{#if action.dc}}
 <p class="action-dc">
 <strong>DC:</strong>
 {{#if action.dc.value}}
 {{action.dc.value}}
 {{else}}
 {{action.dc.type}}
 {{/if}}
 </p>
 {{/if}}
 {{#if action.outcome}}
 <p class="action-outcome"><strong>Effect:</strong> {{action.outcome}}</p>
 {{/if}}
 {{#if action.when}}
 <p class="action-when"><em>{{action.when}}</em></p>
 {{/if}}

 {{!-- Talent Enhancements --}}
 {{#if action.hasEnhancements}}
 <div class="talent-enhancements">
 <h5><i class="fas fa-star"></i> Optional Talent Effects:</h5>
 {{#each action.enhancements as |enhancement|}}
 <div class="talent-enhancement-item">
 <label class="enhancement-checkbox">
 <input type="checkbox"
 class="talent-enhancement-toggle"
 data-action-name="{{../action.name}}"
 data-enhancement-name="{{enhancement.name}}"
 data-talent-name="{{enhancement.requiredTalent}}"
 {{#if enhancement.active}}checked{{/if}}
 title="{{enhancement.trigger}}"/>
 <span class="enhancement-label">
 <strong>{{enhancement.name}}</strong>
 <span class="talent-tree-badge">({{enhancement.talentTree}})</span>
 </span>
 </label>
 <p class="enhancement-description">
 <em>{{enhancement.trigger}}</em> â€” {{enhancement.description}}
 </p>
 {{#if enhancement.notes}}
 <p class="enhancement-notes">{{enhancement.notes}}</p>
 {{/if}}
 </div>
 {{/each}}
 </div>
 {{/if}}

 {{!-- Linked Talent Bonuses (from TalentActionLinker) --}}
 {{#if action.hasTalentBonus}}
 <div class="linked-talent-bonus">
 <span class="bonus-indicator">{{action.talentBonus.description}}</span>
 </div>
 {{/if}}

 </div>
 </div>
 {{/each}}
 </div>
 </div>
</div>
