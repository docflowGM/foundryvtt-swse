import { SheetV2 } from "@foundry/applications/sheets";
import { TabsV2 } from "@foundry/applications/api";

export default class SwseVehicleSheet extends SheetV2 {

    /** -----------------------------------------
     *  Which actor types does this sheet apply to?
     * ----------------------------------------- */
    static get defaultOptions() {
        return mergeObject(super.defaultOptions, {
            id: "swse-vehicle-sheet",
            classes: ["swse", "sheet", "vehicle-sheet"],
            window: {
                title: "Vehicle Sheet"
            },
            position: {
                width: 900,
                height: 900
            }
        });
    }

    /** -----------------------------------------
     *  Template Path
     * ----------------------------------------- */
    static get template() {
        return "systems/swse/templates/actors/vehicle/vehicle-sheet.hbs";
    }

    /** -----------------------------------------
     *  Activate Sheet
     * ----------------------------------------- */
    async _render(...args) {
        await super._render(...args);

        // Bind TabsV2 after DOM is ready
        const html = this.element[0];
        this._tabs = new TabsV2(html.querySelector(".sheet-tabs"), {
            group: "primary",
            initial: "main"
        });
    }

    /** -----------------------------------------
     *  Event Listeners
     * ----------------------------------------- */
    activateListeners(html) {
        super.activateListeners(html);

        // Add weapon
        html[0].querySelector(".weapon-add")?.addEventListener("click", this._onWeaponAdd.bind(this));

        // Remove weapon
        html[0].querySelectorAll(".weapon-remove")?.forEach(btn => {
            btn.addEventListener("click", ev => this._onWeaponRemove(ev));
        });

        // Toggle crew action dropdowns
        html[0].querySelectorAll(".crew-actions-toggle")?.forEach(btn => {
            btn.addEventListener("click", ev => this._onToggleCrewActions(ev));
        });

        // Auto-process tags
        html[0].querySelector(".tags-input")?.addEventListener("change", this._onTagInput.bind(this));
    }

    /* ============================================================
     *  WEAPON MANAGEMENT
     * ============================================================ */

    async _onWeaponAdd(ev) {
        ev.preventDefault();

        const weapons = foundry.utils.duplicate(this.actor.system.weapons ?? []);
        weapons.push({
            name: "",
            arc: "",
            bonus: "",
            damage: "",
            range: ""
        });

        return this.actor.update({ "system.weapons": weapons });
    }

    async _onWeaponRemove(ev) {
        ev.preventDefault();

        const index = Number(ev.currentTarget.dataset.index);
        const weapons = foundry.utils.duplicate(this.actor.system.weapons ?? []);

        if (index >= 0) {
            weapons.splice(index, 1);
            return this.actor.update({ "system.weapons": weapons });
        }
    }

    /* ============================================================
     *  CREW ACTION DROPDOWNS
     * ============================================================ */

    _onToggleCrewActions(ev) {
        const btn = ev.currentTarget;
        const pos = btn.dataset.position;

        const panel = this.element[0].querySelector(`.actions-panel[data-position="${pos}"]`);
        if (panel) {
            panel.classList.toggle("open");
        }
    }

    /* ============================================================
     *  TAG INPUT HANDLING
     * ============================================================ */

    async _onTagInput(ev) {
        const input = ev.currentTarget.value;
        const tags = input.split(",").map(t => t.trim()).filter(t => t.length > 0);

        await this.actor.update({ "system.tags": tags });
        ev.currentTarget.value = "";
    }

}
