name: CI

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Check Code Formatting
        run: npm run format:check
        continue-on-error: true

  build:
    name: Build Styles
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Styles
        run: npm run build:styles

      - name: Check for Build Artifacts
        run: |
          test -f styles/core/swse-base.css || (echo "Build failed: swse-base.css not found" && exit 1)

  validate:
    name: Validate System Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Validate system.json
        run: |
          node -e "
          const fs = require('fs');
          const systemJson = JSON.parse(fs.readFileSync('system.json', 'utf8'));
          const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));

          // Check version match
          if (systemJson.version !== packageJson.version) {
            console.error('❌ Version mismatch!');
            console.error('  system.json:', systemJson.version);
            console.error('  package.json:', packageJson.version);
            process.exit(1);
          }

          // Check required fields
          const required = ['id', 'title', 'version', 'compatibility', 'esmodules', 'styles'];
          for (const field of required) {
            if (!systemJson[field]) {
              console.error('❌ Missing required field:', field);
              process.exit(1);
            }
          }

          console.log('✅ system.json is valid');
          console.log('✅ Version:', systemJson.version);
          "

      - name: Check for Remaining TODOs
        run: |
          echo "Checking for critical TODOs..."

          # Count remaining manual migration TODOs
          TODO_COUNT=$(grep -r "TODO: manual migration required" scripts/ || true | wc -l)

          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "⚠️  Found $TODO_COUNT remaining manual migration TODOs"
            echo "These should be resolved before release"
          else
            echo "✅ No manual migration TODOs found"
          fi

          # This is a warning, not a failure
          exit 0

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [lint, build]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        run: |
          echo "⚠️  Unit tests not yet implemented"
          echo "TODO: Add Jest-based unit tests"
          echo "For now, just verifying files can be parsed..."

          # Basic syntax check by attempting to parse all JS files
          find scripts -name "*.js" ! -name "*.bak" -exec node -c {} \;

          echo "✅ All JavaScript files have valid syntax"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, build, validate, test]
    if: always()

    steps:
      - name: Check Results
        run: |
          echo "## CI Results Summary"
          echo "- Lint: ${{ needs.lint.result }}"
          echo "- Build: ${{ needs.build.result }}"
          echo "- Validate: ${{ needs.validate.result }}"
          echo "- Test: ${{ needs.test.result }}"

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.validate.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ]; then
            echo "❌ CI failed. Please review the errors above."
            exit 1
          fi

          echo "✅ All CI checks passed!"
