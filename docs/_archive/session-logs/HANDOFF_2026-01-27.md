# SWSE Refactor / Stabilization Handoff (Authoritative)

Date: 2026-01-27

This zip is the latest stabilized build from `foundryvtt-swse-suggestion-service-SSOT-compendium-links.zip`, with additional fixes applied for talent tree dedupe, vehicle buckets, store integrity, and speed coercion.

## What was done

### 1) Talent tree cleanup (dedupe by spelling/diacritics)
- Detected and merged duplicate tree:
  - `Master of Teras Kasi` and `Master of Ter√§s Kasi`
- Action:
  - Merged `system.talentIds` into the canonical `Master of Teras Kasi`
  - Removed the duplicate tree document from `packs/talent_trees.db`

### 2) Vehicle compendium buckets filled
- Populated these packs from the canonical vehicles entries:
  - `packs/vehicles-walkers.db`
  - `packs/vehicles-speeders.db`
  - `packs/vehicles-starships.db`
  - `packs/vehicles-stations.db`
- Classification is name/type heuristic-based (AT-*, Starfighter, Shuttle/Freighter, Station keywords, etc).

### 3) Store refactor: SSOT + structural integrity
- Replaced `scripts/apps/store/store-main.js` with a V2-safe implementation that:
  - Loads store-visible data from SSOT pack list (`STORE_PACKS`)
  - Prefers vehicle bucket packs; falls back to canonical vehicles pack if buckets are missing
  - Uses cart arrays (`{items:[], droids:[], vehicles:[]}`) to match `store-checkout.js`
  - Binds to actual template buttons:
    - `.buy-item` with `data-item-id`
    - `.buy-droid` with `data-droid-id`
    - `.buy-vehicle` with `data-vehicle-id`
  - Renders the cart list into `#cart-items-list` and keeps totals updated
  - Uses Rendarr dialogue via `getRendarrLine(...)` and updates `.holo-message`

### 4) Speed warnings fix (integer coercion)
- Fixed vehicle template application setting speed as a string:
  - `scripts/actors/vehicle/swse-vehicle-handler.js`
    - `system.speed` now coerced to integer via `parseInt(...) || 12`
- Fixed another speed assignment that could pass through non-integer strings:
  - `scripts/drag-drop/drop-handler.js`
    - `system.speed` now coerced via `parseInt(...) || 0`

## What to test manually in Foundry

### Store
- Open store, browse all tabs.
- Add an item, droid, and vehicle to cart.
- Confirm:
  - Cart count increments
  - Subtotal updates
  - Checkout deducts credits first, then grants item(s)
  - On insufficient funds: no grant happens

### Vehicles
- Confirm vehicle bucket packs show entries.
- Confirm store displays vehicles (no dupes).

### Chargen / Level-up / Suggestion Engine
- Confirm L1 mentor survey triggers on every class selection (skippable) and skip is recorded.
- Confirm suggestions still display and mentor dialogue composes normally.

## Files changed in this pass

- `packs/talent_trees.db`
- `packs/vehicles-walkers.db`
- `packs/vehicles-speeders.db`
- `packs/vehicles-starships.db`
- `packs/vehicles-stations.db`
- `scripts/apps/store/store-main.js` (replaced)
- `scripts/apps/store/store-constants.js` (updated STORE_PACKS vehicle fields)
- `scripts/actors/vehicle/swse-vehicle-handler.js` (speed coercion)
- `scripts/drag-drop/drop-handler.js` (speed coercion)

## Next steps (if anything breaks)
- If the vehicle bucket classification is off for edge cases:
  - Adjust `classify_vehicle(...)` heuristics used during pack generation
- If store tabs need tighter categorization:
  - Expand `_categorizeEquipmentExtended(...)` keyword rules in store-main
